<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overland Gear Catalog</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        .item-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .nav-tab {
            transition: all 0.2s;
        }
        .nav-tab.active {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Language translations
        const TRANSLATIONS = {
            en: {
                appTitle: "Overland Gear Catalog",
                catalog: "Catalog",
                packingLists: "Packing Lists",
                firstAid: "First Aid",
                insuranceReport: "Insurance Report",
                exportData: "Export All Data",
                importReplace: "Import (Replace)",
                mergeData: "Merge Data",
                generatePDF: "Generate PDF",
                // Add more translations as needed
            },
            es: {
                appTitle: "CatÃ¡logo de Equipo Overland",
                catalog: "CatÃ¡logo",
                packingLists: "Listas de Equipaje",
                firstAid: "Primeros Auxilios",
                insuranceReport: "Informe de Seguro",
                exportData: "Exportar Todos los Datos",
                importReplace: "Importar (Reemplazar)",
                mergeData: "Combinar Datos",
                generatePDF: "Generar PDF",
            },
            fr: {
                appTitle: "Catalogue d'Ã‰quipement Overland",
                catalog: "Catalogue",
                packingLists: "Listes de Bagages",
                firstAid: "Premiers Secours",
                insuranceReport: "Rapport d'Assurance",
                exportData: "Exporter Toutes les DonnÃ©es",
                importReplace: "Importer (Remplacer)",
                mergeData: "Fusionner les DonnÃ©es",
                generatePDF: "GÃ©nÃ©rer PDF",
            },
            de: {
                appTitle: "Overland AusrÃ¼stungskatalog",
                catalog: "Katalog",
                packingLists: "Packlisten",
                firstAid: "Erste Hilfe",
                insuranceReport: "Versicherungsbericht",
                exportData: "Alle Daten Exportieren",
                importReplace: "Importieren (Ersetzen)",
                mergeData: "Daten ZusammenfÃ¼hren",
                generatePDF: "PDF Generieren",
            },
            pt: {
                appTitle: "CatÃ¡logo de Equipamento Overland",
                catalog: "CatÃ¡logo",
                packingLists: "Listas de Bagagem",
                firstAid: "Primeiros Socorros",
                insuranceReport: "RelatÃ³rio de Seguro",
                exportData: "Exportar Todos os Dados",
                importReplace: "Importar (Substituir)",
                mergeData: "Mesclar Dados",
                generatePDF: "Gerar PDF",
            },
            ru: { appTitle: "ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³ ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Overland", catalog: "ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³", packingLists: "Ğ¡Ğ¿Ğ¸ÑĞºĞ¸ Ğ£Ğ¿Ğ°ĞºĞ¾Ğ²ĞºĞ¸", firstAid: "ĞŸĞµÑ€Ğ²Ğ°Ñ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ", insuranceReport: "Ğ¡Ñ‚Ñ€Ğ°Ñ…Ğ¾Ğ²Ğ¾Ğ¹ ĞÑ‚Ñ‡ĞµÑ‚", exportData: "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ’ÑĞµÑ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ…", importReplace: "Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ (Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ)", mergeData: "ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ", generatePDF: "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ PDF" },
            ar: { appTitle: "ÙƒØªØ§Ù„ÙˆØ¬ Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø³ÙØ± Ø§Ù„Ø¨Ø±ÙŠ", catalog: "Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬", packingLists: "Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØªØ¹Ø¨Ø¦Ø©", firstAid: "Ø§Ù„Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©", insuranceReport: "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ£Ù…ÙŠÙ†", exportData: "ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", importReplace: "Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø§Ø³ØªØ¨Ø¯Ø§Ù„)", mergeData: "Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", generatePDF: "Ø¥Ù†Ø´Ø§Ø¡ PDF" },
            zh: { appTitle: "è¶Šé‡è£…å¤‡ç›®å½•", catalog: "ç›®å½•", packingLists: "æ‰“åŒ…æ¸…å•", firstAid: "æ€¥æ•‘", insuranceReport: "ä¿é™©æŠ¥å‘Š", exportData: "å¯¼å‡ºæ‰€æœ‰æ•°æ®", importReplace: "å¯¼å…¥ï¼ˆæ›¿æ¢ï¼‰", mergeData: "åˆå¹¶æ•°æ®", generatePDF: "ç”ŸæˆPDF" },
            ja: { appTitle: "ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒ³ãƒ‰è£…å‚™ã‚«ã‚¿ãƒ­ã‚°", catalog: "ã‚«ã‚¿ãƒ­ã‚°", packingLists: "ãƒ‘ãƒƒã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ", firstAid: "å¿œæ€¥å‡¦ç½®", insuranceReport: "ä¿é™ºå ±å‘Šæ›¸", exportData: "å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ", importReplace: "ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆç½®æ›ï¼‰", mergeData: "ãƒ‡ãƒ¼ã‚¿çµ±åˆ", generatePDF: "PDFç”Ÿæˆ" },
            tr: { appTitle: "Overland Ekipman KataloÄŸu", catalog: "Katalog", packingLists: "Paket Listeleri", firstAid: "Ä°lk YardÄ±m", insuranceReport: "Sigorta Raporu", exportData: "TÃ¼m Verileri DÄ±ÅŸa Aktar", importReplace: "Ä°Ã§e Aktar (DeÄŸiÅŸtir)", mergeData: "Verileri BirleÅŸtir", generatePDF: "PDF OluÅŸtur" },
            hi: { appTitle: "à¤“à¤µà¤°à¤²à¥ˆà¤‚à¤¡ à¤—à¤¿à¤¯à¤° à¤•à¥ˆà¤Ÿà¤²à¥‰à¤—", catalog: "à¤•à¥ˆà¤Ÿà¤²à¥‰à¤—", packingLists: "à¤ªà¥ˆà¤•à¤¿à¤‚à¤— à¤¸à¥‚à¤šà¥€", firstAid: "à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤• à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾", insuranceReport: "à¤¬à¥€à¤®à¤¾ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ", exportData: "à¤¸à¤­à¥€ à¤¡à¥‡à¤Ÿà¤¾ à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤•à¤°à¥‡à¤‚", importReplace: "à¤†à¤¯à¤¾à¤¤ (à¤¬à¤¦à¤²à¥‡à¤‚)", mergeData: "à¤¡à¥‡à¤Ÿà¤¾ à¤®à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚", generatePDF: "PDF à¤œà¥‡à¤¨à¤°à¥‡à¤Ÿ à¤•à¤°à¥‡à¤‚" },
            sw: { appTitle: "Katalogi ya Vifaa vya Safari", catalog: "Katalogi", packingLists: "Orodha za Kufunga", firstAid: "Huduma ya Kwanza", insuranceReport: "Ripoti ya Bima", exportData: "Tuma Data Zote", importReplace: "Leta (Badilisha)", mergeData: "Unganisha Data", generatePDF: "Tengeneza PDF" },
            th: { appTitle: "à¹à¸„à¸•à¸•à¸²à¸¥à¹‡à¸­à¸à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹€à¸”à¸´à¸™à¸—à¸²à¸‡", catalog: "à¹à¸„à¸•à¸•à¸²à¸¥à¹‡à¸­à¸", packingLists: "à¸£à¸²à¸¢à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸£à¸°à¹€à¸›à¹‹à¸²", firstAid: "à¸à¸²à¸£à¸›à¸à¸¡à¸à¸¢à¸²à¸šà¸²à¸¥", insuranceReport: "à¸£à¸²à¸¢à¸‡à¸²à¸™à¸›à¸£à¸°à¸à¸±à¸™", exportData: "à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", importReplace: "à¸™à¸³à¹€à¸‚à¹‰à¸² (à¹à¸—à¸™à¸—à¸µà¹ˆ)", mergeData: "à¸£à¸§à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥", generatePDF: "à¸ªà¸£à¹‰à¸²à¸‡ PDF" },
            id: { appTitle: "Katalog Perlengkapan Overland", catalog: "Katalog", packingLists: "Daftar Packing", firstAid: "Pertolongan Pertama", insuranceReport: "Laporan Asuransi", exportData: "Ekspor Semua Data", importReplace: "Impor (Ganti)", mergeData: "Gabungkan Data", generatePDF: "Buat PDF" },
            ms: { appTitle: "Katalog Peralatan Overland", catalog: "Katalog", packingLists: "Senarai Pengemasan", firstAid: "Pertolongan Cemas", insuranceReport: "Laporan Insurans", exportData: "Eksport Semua Data", importReplace: "Import (Ganti)", mergeData: "Gabungkan Data", generatePDF: "Jana PDF" },
            vi: { appTitle: "Danh Má»¥c Thiáº¿t Bá»‹ Overland", catalog: "Danh Má»¥c", packingLists: "Danh SÃ¡ch ÄÃ³ng GÃ³i", firstAid: "SÆ¡ Cá»©u", insuranceReport: "BÃ¡o CÃ¡o Báº£o Hiá»ƒm", exportData: "Xuáº¥t Táº¥t Cáº£ Dá»¯ Liá»‡u", importReplace: "Nháº­p (Thay Tháº¿)", mergeData: "Há»£p Nháº¥t Dá»¯ Liá»‡u", generatePDF: "Táº¡o PDF" },
            ko: { appTitle: "ì˜¤ë²„ëœë“œ ì¥ë¹„ ì¹´íƒˆë¡œê·¸", catalog: "ì¹´íƒˆë¡œê·¸", packingLists: "ì§ ì‹¸ê¸° ëª©ë¡", firstAid: "ì‘ê¸‰ ì²˜ì¹˜", insuranceReport: "ë³´í—˜ ë³´ê³ ì„œ", exportData: "ëª¨ë“  ë°ì´í„° ë‚´ë³´ë‚´ê¸°", importReplace: "ê°€ì ¸ì˜¤ê¸° (ë°”ê¾¸ê¸°)", mergeData: "ë°ì´í„° ë³‘í•©", generatePDF: "PDF ìƒì„±" },
            it: { appTitle: "Catalogo Equipaggiamento Overland", catalog: "Catalogo", packingLists: "Liste Bagagli", firstAid: "Primo Soccorso", insuranceReport: "Rapporto Assicurativo", exportData: "Esporta Tutti i Dati", importReplace: "Importa (Sostituisci)", mergeData: "Unisci Dati", generatePDF: "Genera PDF" },
            pl: { appTitle: "Katalog WyposaÅ¼enia Overland", catalog: "Katalog", packingLists: "Listy Pakowania", firstAid: "Pierwsza Pomoc", insuranceReport: "Raport Ubezpieczeniowy", exportData: "Eksportuj Wszystkie Dane", importReplace: "Importuj (ZastÄ…p)", mergeData: "PoÅ‚Ä…cz Dane", generatePDF: "Generuj PDF" },
            nl: { appTitle: "Overland Uitrusting Catalogus", catalog: "Catalogus", packingLists: "Paklijsten", firstAid: "Eerste Hulp", insuranceReport: "Verzekeringsrapport", exportData: "Exporteer Alle Gegevens", importReplace: "Importeren (Vervangen)", mergeData: "Gegevens Samenvoegen", generatePDF: "PDF Genereren" },
            sv: { appTitle: "Overland Utrustningskatalog", catalog: "Katalog", packingLists: "Packlistor", firstAid: "FÃ¶rsta HjÃ¤lpen", insuranceReport: "FÃ¶rsÃ¤kringsrapport", exportData: "Exportera All Data", importReplace: "Importera (ErsÃ¤tt)", mergeData: "SlÃ¥ Samman Data", generatePDF: "Skapa PDF" },
            no: { appTitle: "Overland Utstyrskatalog", catalog: "Katalog", packingLists: "Pakkelister", firstAid: "FÃ¸rstehjelp", insuranceReport: "Forsikringsrapport", exportData: "Eksporter Alle Data", importReplace: "Importer (Erstatt)", mergeData: "SlÃ¥ Sammen Data", generatePDF: "Generer PDF" },
            da: { appTitle: "Overland Udstyrskatalog", catalog: "Katalog", packingLists: "Pakkelister", firstAid: "FÃ¸rstehjÃ¦lp", insuranceReport: "Forsikringsrapport", exportData: "Eksporter Alle Data", importReplace: "Importer (Erstat)", mergeData: "Flet Data", generatePDF: "Generer PDF" },
            fi: { appTitle: "Overland Varustekuvasto", catalog: "Kuvasto", packingLists: "Pakkauslistat", firstAid: "Ensiap", insuranceReport: "Vakuutusraportti", exportData: "Vie Kaikki Tiedot", importReplace: "Tuo (Korvaa)", mergeData: "YhdistÃ¤ Tiedot", generatePDF: "Luo PDF" },
            el: { appTitle: "ÎšÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚ Î•Î¾Î¿Ï€Î»Î¹ÏƒÎ¼Î¿Ï Overland", catalog: "ÎšÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚", packingLists: "Î›Î¯ÏƒÏ„ÎµÏ‚ Î£Ï…ÏƒÎºÎµÏ…Î±ÏƒÎ¯Î±Ï‚", firstAid: "Î ÏÏÏ„ÎµÏ‚ Î’Î¿Î®Î¸ÎµÎ¹ÎµÏ‚", insuranceReport: "ÎˆÎºÎ¸ÎµÏƒÎ· Î‘ÏƒÏ†Î¬Î»Î¹ÏƒÎ·Ï‚", exportData: "Î•Î¾Î±Î³Ï‰Î³Î® ÎŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½", importReplace: "Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® (Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·)", mergeData: "Î£Ï…Î³Ï‡ÏÎ½ÎµÏ…ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½", generatePDF: "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± PDF" },
            he: { appTitle: "×§×˜×œ×•×’ ×¦×™×•×“ ××•×‘×¨×œ× ×“", catalog: "×§×˜×œ×•×’", packingLists: "×¨×©×™××•×ª ××¨×™×–×”", firstAid: "×¢×–×¨×” ×¨××©×•× ×”", insuranceReport: "×“×•×— ×‘×™×˜×•×—", exportData: "×™×™×¦×•× ×›×œ ×”× ×ª×•× ×™×", importReplace: "×™×™×‘×•× (×”×—×œ×¤×”)", mergeData: "××™×–×•×’ × ×ª×•× ×™×", generatePDF: "×™×¦×™×¨×ª PDF" },
            cs: { appTitle: "Katalog VybavenÃ­ Overland", catalog: "Katalog", packingLists: "BalicÃ­ Seznamy", firstAid: "PrvnÃ­ Pomoc", insuranceReport: "PojistnÃ¡ ZprÃ¡va", exportData: "Exportovat VÅ¡echna Data", importReplace: "Importovat (Nahradit)", mergeData: "SlouÄit Data", generatePDF: "VytvoÅ™it PDF" },
            ro: { appTitle: "Catalog Echipament Overland", catalog: "Catalog", packingLists: "Liste de Ambalare", firstAid: "Prim Ajutor", insuranceReport: "Raport de Asigurare", exportData: "ExportÄƒ Toate Datele", importReplace: "ImportÄƒ (ÃnlocuieÈ™te)", mergeData: "ÃmbinÄƒ Datele", generatePDF: "GenereazÄƒ PDF" },
            hu: { appTitle: "Overland FelszerelÃ©si KatalÃ³gus", catalog: "KatalÃ³gus", packingLists: "CsomagolÃ¡si ListÃ¡k", firstAid: "ElsÅ‘segÃ©ly", insuranceReport: "BiztosÃ­tÃ¡si JelentÃ©s", exportData: "Ã–sszes Adat ExportÃ¡lÃ¡sa", importReplace: "ImportÃ¡lÃ¡s (Csere)", mergeData: "Adatok EgyesÃ­tÃ©se", generatePDF: "PDF LÃ©trehozÃ¡sa" }
        };

        // PDF Generation Functions
        const generateInventoryPDF = (items, language = 'en', options = {}) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const title = options.title || 'Vehicle/Property Inventory for Customs/Shipping';
            const date = new Date().toLocaleDateString();
            
            // Header
            doc.setFontSize(16);
            doc.text(title, 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated: ${date}`, 105, 28, { align: 'center' });
            
            // Summary
            const totalValue = items
                .filter(i => i.actualCost)
                .reduce((sum, i) => sum + parseFloat(i.actualCost || 0), 0);
            
            doc.setFontSize(12);
            doc.text(`Total Items: ${items.length}`, 14, 40);
            doc.text(`Total Declared Value: Â£${totalValue.toFixed(2)}`, 14, 47);
            
            // Table
            const tableData = items.map(item => [
                item.name,
                item.manufacturer || '-',
                item.category,
                item.owner || '-',
                item.actualCost ? `Â£${item.actualCost}` : '-',
                item.location || '-'
            ]);
            
            doc.autoTable({
                startY: 55,
                head: [['Item', 'Manufacturer', 'Category', 'Owner', 'Value', 'Location']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 8 }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(
                    `Page ${i} of ${pageCount}`,
                    doc.internal.pageSize.getWidth() / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }
            
            return doc;
        };

        const generateMedicationPDF = (items, language = 'en') => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const medications = items.filter(i => i.medicationExpiry);
            const date = new Date().toLocaleDateString();
            
            // Header
            doc.setFontSize(16);
            doc.text('Medication Declaration for Border Crossing', 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated: ${date}`, 105, 28, { align: 'center' });
            
            // Warning Box
            doc.setFillColor(255, 243, 205);
            doc.rect(14, 35, 182, 20, 'F');
            doc.setFontSize(9);
            doc.text('âš ï¸ IMPORTANT: Personal medications must be declared at customs.', 20, 42);
            doc.text('Keep this document with prescriptions and original packaging.', 20, 48);
            
            // Group by person
            const byPerson = {
                'Sonia': [],
                'Amanda': [],
                'Guest': [],
                'General/Shared': []
            };
            
            medications.forEach(med => {
                const person = med.medicationFor || 'General/Shared';
                if (byPerson[person]) {
                    byPerson[person].push(med);
                }
            });
            
            let currentY = 65;
            
            Object.entries(byPerson).forEach(([person, meds]) => {
                if (meds.length === 0) return;
                
                // Person header
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${person} (${meds.length} medication${meds.length > 1 ? 's' : ''})`, 14, currentY);
                currentY += 8;
                
                // Medications table
                const tableData = meds.map(med => [
                    med.name,
                    med.manufacturer || '-',
                    med.prescribingDoctor || '-',
                    med.medicationExpiry,
                    new Date(med.medicationExpiry) < new Date() ? 'EXPIRED' : 'Valid'
                ]);
                
                doc.autoTable({
                    startY: currentY,
                    head: [['Medication', 'Manufacturer', 'Prescribing Doctor', 'Expiry Date', 'Status']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [220, 38, 38] },
                    styles: { fontSize: 8 },
                    didDrawPage: (data) => {
                        currentY = data.cursor.y + 10;
                    }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(
                    `Page ${i} of ${pageCount} - Medication Declaration`,
                    doc.internal.pageSize.getWidth() / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }
            
            return doc;
        };

        const generateFirstAidPDF = (items, language = 'en') => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const firstAidItems = items.filter(i => i.category === 'First Aid');
            const date = new Date().toLocaleDateString();
            
            // Header
            doc.setFontSize(16);
            doc.text('First Aid Kit Inventory', 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated: ${date}`, 105, 28, { align: 'center' });
            
            // Summary by subcategory
            const bySubcategory = {};
            firstAidItems.forEach(item => {
                const subcat = item.subcategory || 'Other';
                if (!bySubcategory[subcat]) {
                    bySubcategory[subcat] = [];
                }
                bySubcategory[subcat].push(item);
            });
            
            let currentY = 40;
            
            Object.entries(bySubcategory).forEach(([subcat, items]) => {
                // Check if we need a new page
                if (currentY > 250) {
                    doc.addPage();
                    currentY = 20;
                }
                
                // Subcategory header
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${subcat} (${items.length} items)`, 14, currentY);
                currentY += 8;
                
                // Items table
                const tableData = items.map(item => {
                    const row = [item.name, item.manufacturer || '-'];
                    if (item.medicationExpiry) {
                        row.push(item.medicationExpiry);
                        row.push(new Date(item.medicationExpiry) < new Date() ? 'EXPIRED' : 'Valid');
                    } else {
                        row.push('-', '-');
                    }
                    return row;
                });
                
                doc.autoTable({
                    startY: currentY,
                    head: [['Item', 'Manufacturer', 'Expiry', 'Status']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [220, 38, 38] },
                    styles: { fontSize: 9 }
                });
                
                currentY = doc.lastAutoTable.finalY + 10;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(
                    `Page ${i} of ${pageCount}`,
                    doc.internal.pageSize.getWidth() / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }
            
            return doc;
        };

        const CATEGORIES = [
            'All',
            'Cooking',
            'Sleeping',
            'Shelter',
            'Tools & Equipment',
            'Recovery & Trail Assistance',
            'Electronics',
            'Clothing',
            'First Aid',
            'Safety',
            'Navigation',
            'Water/Hygiene',
            'Other'
        ];

        const CLOTHING_SUBCATEGORIES = [
            'Footwear',
            'Base Layers',
            'Underwear',
            'Trousers',
            'Shorts',
            'Shirts/Tops',
            'Jackets/Coats',
            'Sweaters/Hoodies',
            'Socks',
            'Hats/Caps',
            'Gloves',
            'Scarves',
            'Belts/Accessories',
            'Sleepwear',
            'Activewear',
            'Rain Gear',
            'Other'
        ];

        const FIRST_AID_SUBCATEGORIES = [
            'Medications',
            'Wound Care',
            'Tools/Equipment',
            'Emergency Supplies',
            'Personal Medications',
            'Topicals/Ointments',
            'Diagnostic Equipment',
            'Splints/Supports',
            'Burn Treatment',
            'Eye Care',
            'Dental Care',
            'Other'
        ];

        const TOOLS_SUBCATEGORIES = [
            'Hand Tools',
            'Power Tools',
            'Diagnostic Tools',
            'Vehicle-Specific Tools',
            'Welding/Fabrication',
            'Electrical Tools',
            'Plumbing Tools',
            'Measuring Tools',
            'Fasteners/Hardware',
            'Lubricants/Fluids',
            'Spare Parts - Engine',
            'Spare Parts - Drivetrain',
            'Spare Parts - Suspension',
            'Spare Parts - Electrical',
            'Spare Parts - Body/Habitat',
            'Consumables',
            'Safety Equipment',
            'Other'
        ];

        const RECOVERY_SUBCATEGORIES = [
            'Winching Equipment',
            'Recovery Straps/Ropes',
            'Shackles/D-Rings',
            'Traction Aids',
            'Jacking/Lifting',
            'Air Down/Up Equipment',
            'Communication',
            'Signaling/Visibility',
            'Protective Gear',
            'Ground Anchors',
            'Vehicle Protection',
            'Other'
        ];

        const RECOVERY_RATING = [
            '< 2,000 kg',
            '2,000 - 3,500 kg',
            '3,500 - 5,000 kg',
            '5,000 - 7,000 kg',
            '7,000+ kg'
        ];

        const TOOL_CONDITION = [
            'New',
            'Good',
            'Fair',
            'Needs Replacement',
            'Spare/Backup'
        ];

        const MEDICATION_FOR = [
            'General/Shared',
            'Sonia',
            'Amanda',
            'Guest'
        ];

        const OWNERSHIP_STATUS = [
            'All',
            'Owned',
            'Need to Purchase'
        ];

        const PRIORITY_LEVELS = [
            'All',
            'Must Have',
            'Nice to Have'
        ];

        const MOBILITY_STATUS = [
            'Fixed/Permanent',
            'Movable',
            'Removable (Storage)'
        ];

        const OWNERS = [
            'Sonia',
            'Amanda',
            'Guest',
            'Joint'
        ];

        const LOCATIONS = [
            'House - Loft',
            'House - Under Sink',
            'House - Bookshelf',
            'House - Monitor Cabinet',
            'House - Toilet',
            'House - General Storage',
            'Truck Cab - Cockpit/Front',
            'Truck Cab - Rear Seat Delete',
            'Truck - Engine Bay',
            'Truck - Roof Rack',
            'Truck - Rear Step',
            'Truck - Frame',
            'Secure Storage Unit',
            'Other'
        ];

        const WEIGHT_UNITS = ['kg', 'lb', 'oz', 'g'];
        
        const CURRENCIES = ['CAD ($)', 'USD ($)', 'MXN ($)', 'EUR (â‚¬)', 'GBP (Â£)', 'AUD ($)', 'NZD ($)', 'JPY (Â¥)'];
        
        const getCurrencySymbol = (currency) => {
            const match = currency.match(/\((.)\)/);
            return match ? match[1] : 'Â£';
        };

        function App() {
            const [items, setItems] = useState([]);
            const [packingLists, setPackingLists] = useState([]);
            const [serviceRecords, setServiceRecords] = useState([]);
            const [fuelRecords, setFuelRecords] = useState([]);
            const [journalEntries, setJournalEntries] = useState([]);
            const [activeView, setActiveView] = useState('catalog');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [selectedSubcategory, setSelectedSubcategory] = useState('All');
            const [selectedOwnership, setSelectedOwnership] = useState('All');
            const [selectedPriority, setSelectedPriority] = useState('All');
            const [selectedLocation, setSelectedLocation] = useState('All');
            const [selectedOwner, setSelectedOwner] = useState('All');
            const [showAddModal, setShowAddModal] = useState(false);
            const [showPackingModal, setShowPackingModal] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [language, setLanguage] = useState('en');
            const [showPDFMenu, setShowPDFMenu] = useState(false);
            const [showWeightSettings, setShowWeightSettings] = useState(false);
            const [vehicleBaseWeight, setVehicleBaseWeight] = useState(2100); // Sierra 1500 Z71 base weight in kg
            
            // Load data from localStorage
            useEffect(() => {
                const savedItems = localStorage.getItem('overlandItems');
                const savedLists = localStorage.getItem('packingLists');
                const savedVehicleWeight = localStorage.getItem('vehicleBaseWeight');
                const savedServiceRecords = localStorage.getItem('serviceRecords');
                const savedFuelRecords = localStorage.getItem('fuelRecords');
                const savedJournalEntries = localStorage.getItem('journalEntries');
                
                if (savedItems) setItems(JSON.parse(savedItems));
                if (savedLists) setPackingLists(JSON.parse(savedLists));
                if (savedVehicleWeight) setVehicleBaseWeight(parseFloat(savedVehicleWeight));
                if (savedServiceRecords) setServiceRecords(JSON.parse(savedServiceRecords));
                if (savedFuelRecords) setFuelRecords(JSON.parse(savedFuelRecords));
                if (savedJournalEntries) setJournalEntries(JSON.parse(savedJournalEntries));
            }, []);

            // Save to localStorage
            useEffect(() => {
                localStorage.setItem('overlandItems', JSON.stringify(items));
            }, [items]);

            useEffect(() => {
                localStorage.setItem('packingLists', JSON.stringify(packingLists));
            }, [packingLists]);

            useEffect(() => {
                localStorage.setItem('vehicleBaseWeight', vehicleBaseWeight.toString());
            }, [vehicleBaseWeight]);

            useEffect(() => {
                localStorage.setItem('serviceRecords', JSON.stringify(serviceRecords));
            }, [serviceRecords]);

            useEffect(() => {
                localStorage.setItem('fuelRecords', JSON.stringify(fuelRecords));
            }, [fuelRecords]);

            useEffect(() => {
                localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
            }, [journalEntries]);

            const addItem = (newItem) => {
                setItems([...items, { ...newItem, id: Date.now() }]);
                setShowAddModal(false);
            };

            const deleteItem = (id) => {
                setItems(items.filter(item => item.id !== id));
            };

            const addServiceRecord = (record) => {
                setServiceRecords([{ ...record, id: Date.now() }, ...serviceRecords]);
            };

            const deleteServiceRecord = (id) => {
                setServiceRecords(serviceRecords.filter(record => record.id !== id));
            };

            const updateServiceRecord = (id, updatedRecord) => {
                setServiceRecords(serviceRecords.map(record => 
                    record.id === id ? { ...record, ...updatedRecord } : record
                ));
            };

            const addFuelRecord = (record) => {
                setFuelRecords([{ ...record, id: Date.now() }, ...fuelRecords]);
            };

            const deleteFuelRecord = (id) => {
                setFuelRecords(fuelRecords.filter(record => record.id !== id));
            };

            const updateFuelRecord = (id, updatedRecord) => {
                setFuelRecords(fuelRecords.map(record => 
                    record.id === id ? { ...record, ...updatedRecord } : record
                ));
            };

            const addJournalEntry = (entry) => {
                setJournalEntries([{ ...entry, id: Date.now() }, ...journalEntries]);
            };

            const deleteJournalEntry = (id) => {
                setJournalEntries(journalEntries.filter(entry => entry.id !== id));
            };

            const updateJournalEntry = (id, updatedEntry) => {
                setJournalEntries(journalEntries.map(entry => 
                    entry.id === id ? { ...entry, ...updatedEntry } : entry
                ));
            };

            const exportAllData = () => {
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    items: items,
                    packingLists: packingLists
                };

                const json = JSON.stringify(exportData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `overland-gear-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const importAllData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.items || !importData.packingLists) {
                            alert('Invalid backup file format');
                            return;
                        }

                        const confirmMessage = `This will import ${importData.items.length} items and ${importData.packingLists.length} packing lists.\n\nCurrent data will be REPLACED. Are you sure?`;
                        
                        if (confirm(confirmMessage)) {
                            setItems(importData.items);
                            setPackingLists(importData.packingLists);
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Error reading backup file. Please check the file and try again.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                // Reset file input
                event.target.value = '';
            };

            const mergeData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.items || !importData.packingLists) {
                            alert('Invalid backup file format');
                            return;
                        }

                        // Check for duplicates and prepare merge summary
                        const existingItemNames = new Set(items.map(i => i.name.toLowerCase()));
                        const newItems = importData.items.filter(item => 
                            !items.some(existing => existing.id === item.id)
                        );
                        const duplicateItems = importData.items.filter(item =>
                            items.some(existing => existing.id === item.id)
                        );

                        const existingListNames = new Set(packingLists.map(l => l.name.toLowerCase()));
                        const newLists = importData.packingLists.filter(list =>
                            !packingLists.some(existing => existing.id === list.id)
                        );
                        const duplicateLists = importData.packingLists.filter(list =>
                            packingLists.some(existing => existing.id === list.id)
                        );

                        let confirmMessage = `MERGE SUMMARY:\n\n`;
                        confirmMessage += `ğŸ“¦ Items:\n`;
                        confirmMessage += `  â€¢ ${newItems.length} new items will be added\n`;
                        confirmMessage += `  â€¢ ${duplicateItems.length} duplicate items will be skipped\n`;
                        confirmMessage += `  â€¢ ${items.length} existing items will be kept\n\n`;
                        confirmMessage += `ğŸ“‹ Packing Lists:\n`;
                        confirmMessage += `  â€¢ ${newLists.length} new lists will be added\n`;
                        confirmMessage += `  â€¢ ${duplicateLists.length} duplicate lists will be skipped\n`;
                        confirmMessage += `  â€¢ ${packingLists.length} existing lists will be kept\n\n`;
                        confirmMessage += `Total after merge: ${items.length + newItems.length} items, ${packingLists.length + newLists.length} lists\n\n`;
                        confirmMessage += `Continue with merge?`;

                        if (confirm(confirmMessage)) {
                            setItems([...items, ...newItems]);
                            setPackingLists([...packingLists, ...newLists]);
                            alert(`âœ… Merge complete!\n\nAdded ${newItems.length} items and ${newLists.length} packing lists.\nSkipped ${duplicateItems.length} duplicate items and ${duplicateLists.length} duplicate lists.`);
                        }
                    } catch (error) {
                        alert('Error reading backup file. Please check the file and try again.');
                        console.error('Merge error:', error);
                    }
                };
                reader.readAsText(file);
                // Reset file input
                event.target.value = '';
            };

            const handleGeneratePDF = (type) => {
                let doc;
                let filename;
                
                const titles = {
                    inventory: {
                        en: 'Vehicle/Property Inventory for Customs/Shipping',
                        es: 'Inventario de VehÃ­culo/Propiedad para Aduanas/EnvÃ­o',
                        fr: 'Inventaire de VÃ©hicule/PropriÃ©tÃ© pour Douanes/ExpÃ©dition',
                        de: 'Fahrzeug-/Eigentumsinventar fÃ¼r Zoll/Versand',
                        pt: 'InventÃ¡rio de VeÃ­culo/Propriedade para AlfÃ¢ndega/Envio',
                        ru: 'Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°/Ğ˜Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° Ğ´Ğ»Ñ Ğ¢Ğ°Ğ¼Ğ¾Ğ¶Ğ½Ğ¸/Ğ”Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸',
                        ar: 'Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª/Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª Ù„Ù„Ø¬Ù…Ø§Ø±Ùƒ/Ø§Ù„Ø´Ø­Ù†',
                        zh: 'æµ·å…³/è¿è¾“è½¦è¾†/è´¢äº§æ¸…å•',
                        ja: 'ç¨é–¢/è¼¸é€ç”¨è»Šä¸¡/è²¡ç”£ç›®éŒ²',
                        tr: 'GÃ¼mrÃ¼k/Nakliye iÃ§in AraÃ§/MÃ¼lk Envanteri',
                        hi: 'à¤¸à¥€à¤®à¤¾ à¤¶à¥à¤²à¥à¤•/à¤¶à¤¿à¤ªà¤¿à¤‚à¤— à¤•à¥‡ à¤²à¤¿à¤ à¤µà¤¾à¤¹à¤¨/à¤¸à¤‚à¤ªà¤¤à¥à¤¤à¤¿ à¤¸à¥‚à¤šà¥€',
                        sw: 'Hesabu ya Gari/Mali kwa Forodha/Usafirishaji',
                        th: 'à¸ªà¸´à¸™à¸„à¹‰à¸²à¸„à¸‡à¸„à¸¥à¸±à¸‡à¸‚à¸­à¸‡à¸¢à¸²à¸™à¸à¸²à¸«à¸™à¸°/à¸—à¸£à¸±à¸à¸¢à¹Œà¸ªà¸´à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸¨à¸¸à¸¥à¸à¸²à¸à¸£/à¸à¸²à¸£à¸ˆà¸±à¸”à¸ªà¹ˆà¸‡',
                        id: 'Inventaris Kendaraan/Properti untuk Bea Cukai/Pengiriman',
                        ms: 'Inventori Kenderaan/Harta untuk Kastam/Penghantaran',
                        vi: 'Kiá»ƒm KÃª Xe/TÃ i Sáº£n cho Háº£i Quan/Váº­n Chuyá»ƒn',
                        ko: 'ì„¸ê´€/ë°°ì†¡ì„ ìœ„í•œ ì°¨ëŸ‰/ì¬ì‚° ëª©ë¡',
                        it: 'Inventario Veicolo/ProprietÃ  per Dogana/Spedizione',
                        pl: 'Inwentarz Pojazdu/WÅ‚asnoÅ›ci dla Celnika/WysyÅ‚ki',
                        nl: 'Voertuig-/Eigendomsinventaris voor Douane/Verzending',
                        sv: 'Fordon/Egendomsinventering fÃ¶r Tull/Frakt',
                        no: 'KjÃ¸retÃ¸y-/Eiendomsinventar for Toll/Frakt',
                        da: 'KÃ¸retÃ¸j-/Ejendomsinventar til Told/Forsendelse',
                        fi: 'Ajoneuvo-/Omaisuusinventaario Tullia/LÃ¤hetystÃ¤ varten',
                        el: 'Î‘Ï€Î¿Î³ÏÎ±Ï†Î® ÎŸÏ‡Î®Î¼Î±Ï„Î¿Ï‚/Î™Î´Î¹Î¿ÎºÏ„Î·ÏƒÎ¯Î±Ï‚ Î³Î¹Î± Î¤ÎµÎ»Ï‰Î½ÎµÎ¯Î¿/Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®',
                        he: '××œ××™ ×¨×›×‘/× ×›×¡×™× ×œ××›×¡/××©×œ×•×—',
                        cs: 'InventÃ¡Å™ Vozidla/Majetku pro Celnici/Dopravu',
                        ro: 'Inventar Vehicul/Proprietate pentru VamÄƒ/Expediere',
                        hu: 'JÃ¡rmÅ±-/Tulajdon LeltÃ¡r VÃ¡mhoz/SzÃ¡llÃ­tÃ¡shoz'
                    }
                };
                
                switch(type) {
                    case 'inventory':
                        doc = generateInventoryPDF(items.filter(i => i.ownership === 'Owned'), language, {
                            title: titles.inventory[language] || titles.inventory.en
                        });
                        filename = `vehicle-inventory-${new Date().toISOString().split('T')[0]}.pdf`;
                        break;
                    case 'medications':
                        doc = generateMedicationPDF(items, language);
                        filename = `medication-declaration-${new Date().toISOString().split('T')[0]}.pdf`;
                        break;
                    case 'firstaid':
                        doc = generateFirstAidPDF(items, language);
                        filename = `firstaid-inventory-${new Date().toISOString().split('T')[0]}.pdf`;
                        break;
                    default:
                        return;
                }
                
                doc.save(filename);
                setShowPDFMenu(false);
            };

            const filteredItems = items.filter(item => {
                const matchesCategory = selectedCategory === 'All' || item.category === selectedCategory;
                const matchesSubcategory = selectedSubcategory === 'All' || item.subcategory === selectedSubcategory;
                const matchesOwnership = selectedOwnership === 'All' || item.ownership === selectedOwnership;
                const matchesPriority = selectedPriority === 'All' || item.priority === selectedPriority;
                const matchesLocation = selectedLocation === 'All' || item.location === selectedLocation;
                const matchesOwner = selectedOwner === 'All' || item.owner === selectedOwner;
                const matchesSearch = item.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                    item.description?.toLowerCase().includes(searchQuery.toLowerCase());
                return matchesCategory && matchesSubcategory && matchesOwnership && matchesPriority && matchesLocation && matchesOwner && matchesSearch;
            });

            const stats = {
                total: items.length,
                owned: items.filter(i => i.ownership === 'Owned').length,
                needToBuy: items.filter(i => i.ownership === 'Need to Purchase').length,
                mustHave: items.filter(i => i.priority === 'Must Have').length,
                niceToHave: items.filter(i => i.priority === 'Nice to Have').length,
                fixed: items.filter(i => i.mobility === 'Fixed/Permanent').length,
                movable: items.filter(i => i.mobility === 'Movable').length,
                removable: items.filter(i => i.mobility === 'Removable (Storage)').length,
                sonia: items.filter(i => i.owner === 'Sonia').length,
                amanda: items.filter(i => i.owner === 'Amanda').length,
                guest: items.filter(i => i.owner === 'Guest').length,
                joint: items.filter(i => i.owner === 'Joint').length,
                totalValue: items
                    .filter(i => i.ownership === 'Owned' && i.actualCost)
                    .reduce((sum, i) => sum + parseFloat(i.actualCost || 0), 0)
                    .toFixed(2),
                categories: new Set(items.map(i => i.category)).size,
                lists: packingLists.length
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
                    {/* Header */}
                    <header className="bg-white shadow-md sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <div className="bg-gradient-to-br from-blue-600 to-blue-700 p-3 rounded-xl">
                                        <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">Overland Gear</h1>
                                        <p className="text-sm text-gray-500">Your Tiny House on Wheels</p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center space-x-3">
                                    <div className="hidden md:flex space-x-6 text-sm">
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-blue-600">{stats.total}</div>
                                            <div className="text-gray-500">Items</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-green-600">{stats.owned}</div>
                                            <div className="text-gray-500">Owned</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-orange-600">{stats.needToBuy}</div>
                                            <div className="text-gray-500">To Buy</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-emerald-600">Â£{stats.totalValue}</div>
                                            <div className="text-gray-500">Total Value</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-2xl font-bold text-purple-600">{stats.lists}</div>
                                            <div className="text-gray-500">Lists</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Data Management Buttons */}
                            <div className="flex gap-3 mt-4 flex-wrap items-center">
                                {/* Weight Monitor Button */}
                                <button
                                    onClick={() => setShowWeightSettings(true)}
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition flex items-center space-x-2 text-sm"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                                    </svg>
                                    <span>âš–ï¸ Weight Monitor</span>
                                </button>

                                {/* Language Selector */}
                                <select
                                    value={language}
                                    onChange={(e) => setLanguage(e.target.value)}
                                    className="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg font-medium hover:bg-gray-200 transition text-sm"
                                >
                                    <optgroup label="ğŸŒ Western Europe">
                                        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                                        <option value="nl">ğŸ‡³ğŸ‡± Nederlands</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ Northern Europe">
                                        <option value="sv">ğŸ‡¸ğŸ‡ª Svenska</option>
                                        <option value="no">ğŸ‡³ğŸ‡´ Norsk</option>
                                        <option value="da">ğŸ‡©ğŸ‡° Dansk</option>
                                        <option value="fi">ğŸ‡«ğŸ‡® Suomi</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ Eastern Europe">
                                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                                        <option value="pl">ğŸ‡µğŸ‡± Polski</option>
                                        <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
                                        <option value="ro">ğŸ‡·ğŸ‡´ RomÃ¢nÄƒ</option>
                                        <option value="hu">ğŸ‡­ğŸ‡º Magyar</option>
                                        <option value="el">ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ East Asia">
                                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ Southeast Asia">
                                        <option value="th">ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</option>
                                        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                                        <option value="id">ğŸ‡®ğŸ‡© Bahasa Indonesia</option>
                                        <option value="ms">ğŸ‡²ğŸ‡¾ Bahasa Melayu</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ Middle East & South Asia">
                                        <option value="tr">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</option>
                                        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                        <option value="he">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª</option>
                                        <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                                    </optgroup>
                                    <optgroup label="ğŸŒ Africa">
                                        <option value="sw">ğŸ‡°ğŸ‡ª Kiswahili</option>
                                    </optgroup>
                                </select>

                                <button
                                    onClick={exportAllData}
                                    className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition flex items-center space-x-2 text-sm"
                                >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    <span>Export All Data</span>
                                </button>
                                <label className="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition flex items-center space-x-2 cursor-pointer text-sm">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>Import (Replace)</span>
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={importAllData}
                                        className="hidden"
                                    />
                                </label>
                                <label className="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center space-x-2 cursor-pointer text-sm">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z" />
                                    </svg>
                                    <span>Merge Data</span>
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={mergeData}
                                        className="hidden"
                                    />
                                </label>

                                {/* PDF Generation Menu */}
                                <div className="relative">
                                    <button
                                        onClick={() => setShowPDFMenu(!showPDFMenu)}
                                        className="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition flex items-center space-x-2 text-sm"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                        <span>ğŸ“„ Generate PDF</span>
                                        <svg className={`w-4 h-4 transition-transform ${showPDFMenu ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>

                                    {showPDFMenu && (
                                        <div className="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                                            <div className="py-2">
                                                <button
                                                    onClick={() => handleGeneratePDF('inventory')}
                                                    className="w-full px-4 py-3 text-left hover:bg-gray-50 transition flex items-start space-x-3"
                                                >
                                                    <span className="text-2xl">ğŸš›</span>
                                                    <div>
                                                        <div className="font-medium text-gray-900">Vehicle/Property Inventory</div>
                                                        <div className="text-xs text-gray-500">For customs, temp import, shipping</div>
                                                    </div>
                                                </button>
                                                <button
                                                    onClick={() => handleGeneratePDF('medications')}
                                                    className="w-full px-4 py-3 text-left hover:bg-gray-50 transition flex items-start space-x-3"
                                                >
                                                    <span className="text-2xl">ğŸ’Š</span>
                                                    <div>
                                                        <div className="font-medium text-gray-900">Medication Declaration</div>
                                                        <div className="text-xs text-gray-500">For border crossings</div>
                                                    </div>
                                                </button>
                                                <button
                                                    onClick={() => handleGeneratePDF('firstaid')}
                                                    className="w-full px-4 py-3 text-left hover:bg-gray-50 transition flex items-start space-x-3"
                                                >
                                                    <span className="text-2xl">ğŸ¥</span>
                                                    <div>
                                                        <div className="font-medium text-gray-900">First Aid Kit Inventory</div>
                                                        <div className="text-xs text-gray-500">Complete medical supplies list</div>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Navigation */}
                            <div className="flex space-x-1 mt-4 border-b overflow-x-auto">
                                <button
                                    onClick={() => setActiveView('catalog')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'catalog' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Catalog
                                </button>
                                <button
                                    onClick={() => setActiveView('packing')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'packing' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Packing Lists
                                </button>
                                <button
                                    onClick={() => setActiveView('service')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'service' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸ”§ Service & Maintenance
                                </button>
                                <button
                                    onClick={() => setActiveView('fuel')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'fuel' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    â›½ Fuel Tracking
                                </button>
                                <button
                                    onClick={() => setActiveView('journal')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'journal' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸ““ Travel Journal
                                </button>
                                <button
                                    onClick={() => setActiveView('tools')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'tools' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸ”§ Tools & Equipment
                                </button>
                                <button
                                    onClick={() => setActiveView('fluids')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'fluids' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸ›¢ï¸ Fluids & Spares
                                </button>
                                <button
                                    onClick={() => setActiveView('recovery')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'recovery' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸ”— Recovery & Assistance
                                </button>
                                <button
                                    onClick={() => setActiveView('trailassist')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'trailassist' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸš¨ Trail Recovery Assistant
                                </button>
                                <button
                                    onClick={() => setActiveView('firstaid')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'firstaid' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    ğŸ¥ First Aid
                                </button>
                                <button
                                    onClick={() => setActiveView('insurance')}
                                    className={`nav-tab px-6 py-3 font-medium whitespace-nowrap ${activeView === 'insurance' ? 'active' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Insurance Report
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {activeView === 'catalog' ? (
                            <CatalogView
                                items={filteredItems}
                                categories={CATEGORIES}
                                selectedCategory={selectedCategory}
                                setSelectedCategory={setSelectedCategory}
                                subcategories={
                                    selectedCategory === 'Clothing' 
                                        ? ['All', ...CLOTHING_SUBCATEGORIES]
                                        : selectedCategory === 'First Aid'
                                        ? ['All', ...FIRST_AID_SUBCATEGORIES]
                                        : selectedCategory === 'Tools & Equipment'
                                        ? ['All', ...TOOLS_SUBCATEGORIES]
                                        : selectedCategory === 'Recovery & Trail Assistance'
                                        ? ['All', ...RECOVERY_SUBCATEGORIES]
                                        : []
                                }
                                selectedSubcategory={selectedSubcategory}
                                setSelectedSubcategory={setSelectedSubcategory}
                                showSubcategoryFilter={selectedCategory === 'Clothing' || selectedCategory === 'First Aid' || selectedCategory === 'Tools & Equipment' || selectedCategory === 'Recovery & Trail Assistance'}
                                subcategoryTitle={
                                    selectedCategory === 'Clothing' ? 'ğŸ‘• Clothing Type' 
                                    : selectedCategory === 'First Aid' ? 'ğŸ¥ First Aid Type'
                                    : selectedCategory === 'Tools & Equipment' ? 'ğŸ”§ Tool Type'
                                    : selectedCategory === 'Recovery & Trail Assistance' ? 'ğŸ”— Recovery Type'
                                    : ''
                                }
                                ownershipStatuses={OWNERSHIP_STATUS}
                                selectedOwnership={selectedOwnership}
                                setSelectedOwnership={setSelectedOwnership}
                                priorityLevels={PRIORITY_LEVELS}
                                selectedPriority={selectedPriority}
                                setSelectedPriority={setSelectedPriority}
                                locations={['All', ...LOCATIONS]}
                                selectedLocation={selectedLocation}
                                setSelectedLocation={setSelectedLocation}
                                owners={['All', ...OWNERS]}
                                selectedOwner={selectedOwner}
                                setSelectedOwner={setSelectedOwner}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                onAddItem={() => setShowAddModal(true)}
                                onDeleteItem={deleteItem}
                            />
                        ) : activeView === 'packing' ? (
                            <PackingListsView
                                packingLists={packingLists}
                                items={items}
                                onAddList={() => setShowPackingModal(true)}
                                onDeleteList={(id) => setPackingLists(packingLists.filter(l => l.id !== id))}
                                onUpdateList={(updatedList) => {
                                    setPackingLists(packingLists.map(l => 
                                        l.id === updatedList.id ? updatedList : l
                                    ));
                                }}
                            />
                        ) : activeView === 'service' ? (
                            <ServiceMaintenanceView 
                                serviceRecords={serviceRecords}
                                onAddRecord={addServiceRecord}
                                onDeleteRecord={deleteServiceRecord}
                                onUpdateRecord={updateServiceRecord}
                                vehicleBaseWeight={vehicleBaseWeight}
                            />
                        ) : activeView === 'fuel' ? (
                            <FuelTrackingView
                                fuelRecords={fuelRecords}
                                onAddRecord={addFuelRecord}
                                onDeleteRecord={deleteFuelRecord}
                                onUpdateRecord={updateFuelRecord}
                            />
                        ) : activeView === 'journal' ? (
                            <TravelJournalView
                                journalEntries={journalEntries}
                                onAddEntry={addJournalEntry}
                                onDeleteEntry={deleteJournalEntry}
                                onUpdateEntry={updateJournalEntry}
                            />
                        ) : activeView === 'tools' ? (
                            <ToolsView items={items} />
                        ) : activeView === 'fluids' ? (
                            <FluidsAndSparesView items={items} vehicleBaseWeight={vehicleBaseWeight} />
                        ) : activeView === 'recovery' ? (
                            <RecoveryView items={items} vehicleBaseWeight={vehicleBaseWeight} />
                        ) : activeView === 'trailassist' ? (
                            <TrailRecoveryAssistant items={items} vehicleBaseWeight={vehicleBaseWeight} />
                        ) : activeView === 'firstaid' ? (
                            <FirstAidView items={items} />
                        ) : (
                            <InsuranceReportView items={items} />
                        )}
                    </main>

                    {/* Modals */}
                    {/* Weight Settings Modal */}
                    {showWeightSettings && (
                        <WeightMonitorModal
                            items={items}
                            vehicleBaseWeight={vehicleBaseWeight}
                            setVehicleBaseWeight={setVehicleBaseWeight}
                            onClose={() => setShowWeightSettings(false)}
                        />
                    )}

                    {showAddModal && (
                        <AddItemModal
                            onClose={() => setShowAddModal(false)}
                            onAdd={addItem}
                            categories={CATEGORIES.filter(c => c !== 'All')}
                        />
                    )}

                    {showPackingModal && (
                        <AddPackingListModal
                            onClose={() => setShowPackingModal(false)}
                            items={items}
                            onAdd={(list) => {
                                setPackingLists([...packingLists, { ...list, id: Date.now() }]);
                                setShowPackingModal(false);
                            }}
                        />
                    )}
                </div>
            );
        }

        function TravelJournalView({ journalEntries, onAddEntry, onDeleteEntry, onUpdateEntry }) {
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedEntry, setSelectedEntry] = useState(null);
            const [filterView, setFilterView] = useState('all'); // all, month, location

            const sortedEntries = [...journalEntries].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Group entries by month
            const entriesByMonth = sortedEntries.reduce((acc, entry) => {
                const month = entry.date.substring(0, 7); // YYYY-MM
                if (!acc[month]) acc[month] = [];
                acc[month].push(entry);
                return acc;
            }, {});

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-3xl font-bold text-white flex items-center space-x-3">
                                    <span>ğŸ““</span>
                                    <span>Travel Journal</span>
                                </h2>
                                <p className="text-indigo-50 mt-2">
                                    Document your journey: daily logs, people, places, thoughts & truck improvements
                                </p>
                            </div>
                            <button
                                onClick={() => setShowAddModal(true)}
                                className="px-6 py-3 bg-white text-indigo-600 rounded-lg font-bold hover:bg-indigo-50 transition flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                <span>New Entry</span>
                            </button>
                        </div>
                    </div>

                    {/* Stats */}
                    <div className="grid md:grid-cols-4 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-indigo-500">
                            <div className="text-3xl font-bold text-indigo-600">{journalEntries.length}</div>
                            <div className="text-gray-600 mt-1">Journal Entries</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                            <div className="text-3xl font-bold text-purple-600">{Object.keys(entriesByMonth).length}</div>
                            <div className="text-gray-600 mt-1">Months Traveled</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <div className="text-3xl font-bold text-blue-600">
                                {journalEntries.filter(e => e.contacts && e.contacts.length > 0).length}
                            </div>
                            <div className="text-gray-600 mt-1">Contacts Made</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <div className="text-3xl font-bold text-green-600">
                                {journalEntries.filter(e => e.improvements && e.improvements.trim()).length}
                            </div>
                            <div className="text-gray-600 mt-1">Improvements Noted</div>
                        </div>
                    </div>

                    {/* View Filters */}
                    <div className="flex space-x-2 border-b">
                        <button
                            onClick={() => setFilterView('all')}
                            className={`px-6 py-3 font-medium ${filterView === 'all' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500'}`}
                        >
                            All Entries
                        </button>
                        <button
                            onClick={() => setFilterView('month')}
                            className={`px-6 py-3 font-medium ${filterView === 'month' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500'}`}
                        >
                            By Month
                        </button>
                    </div>

                    {/* Entries Display */}
                    {journalEntries.length === 0 ? (
                        <div className="text-center py-12 bg-gray-50 rounded-lg">
                            <p className="text-gray-500 mb-4">No journal entries yet - start documenting your journey!</p>
                            <button
                                onClick={() => setShowAddModal(true)}
                                className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                            >
                                Create First Entry
                            </button>
                        </div>
                    ) : filterView === 'all' ? (
                        <div className="space-y-4">
                            {sortedEntries.map(entry => (
                                <JournalEntryCard
                                    key={entry.id}
                                    entry={entry}
                                    onDelete={onDeleteEntry}
                                    onView={() => setSelectedEntry(entry)}
                                />
                            ))}
                        </div>
                    ) : (
                        <div className="space-y-6">
                            {Object.keys(entriesByMonth).sort().reverse().map(month => (
                                <div key={month}>
                                    <h3 className="text-xl font-bold text-gray-900 mb-3 sticky top-0 bg-white py-2 border-b-2 border-indigo-200">
                                        {new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
                                        <span className="text-sm text-gray-500 ml-3">({entriesByMonth[month].length} entries)</span>
                                    </h3>
                                    <div className="space-y-4">
                                        {entriesByMonth[month].map(entry => (
                                            <JournalEntryCard
                                                key={entry.id}
                                                entry={entry}
                                                onDelete={onDeleteEntry}
                                                onView={() => setSelectedEntry(entry)}
                                            />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {showAddModal && (
                        <AddJournalModal
                            onClose={() => setShowAddModal(false)}
                            onAdd={(entry) => {
                                onAddEntry(entry);
                                setShowAddModal(false);
                            }}
                        />
                    )}

                    {selectedEntry && (
                        <ViewJournalModal
                            entry={selectedEntry}
                            onClose={() => setSelectedEntry(null)}
                            onDelete={() => {
                                onDeleteEntry(selectedEntry.id);
                                setSelectedEntry(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        function JournalEntryCard({ entry, onDelete, onView }) {
            return (
                <div className="bg-white border-2 border-gray-200 rounded-lg p-5 hover:shadow-lg transition cursor-pointer"
                     onClick={onView}>
                    <div className="flex justify-between items-start">
                        <div className="flex-1">
                            <div className="flex items-center space-x-3 mb-2">
                                <h3 className="font-bold text-xl text-gray-900">{entry.date}</h3>
                                {entry.location && (
                                    <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                        ğŸ“ {entry.location}
                                    </span>
                                )}
                                {entry.weather && (
                                    <span className="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">
                                        {entry.weather.emoji} {entry.weather.temp}Â°C
                                    </span>
                                )}
                            </div>
                            
                            <p className="text-gray-700 mb-3 line-clamp-2">{entry.dailyLog}</p>
                            
                            <div className="flex flex-wrap gap-2 text-sm">
                                {entry.companions && entry.companions.length > 0 && (
                                    <span className="px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                        ğŸ‘¥ {entry.companions.length} companion{entry.companions.length > 1 ? 's' : ''}
                                    </span>
                                )}
                                {entry.contacts && entry.contacts.length > 0 && (
                                    <span className="px-2 py-1 bg-green-100 text-green-700 rounded">
                                        ğŸ“ {entry.contacts.length} contact{entry.contacts.length > 1 ? 's' : ''}
                                    </span>
                                )}
                                {entry.campsiteGPS && (
                                    <span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded">
                                        ğŸ“ GPS Saved
                                    </span>
                                )}
                                {entry.photos && entry.photos.length > 0 && (
                                    <span className="px-2 py-1 bg-pink-100 text-pink-700 rounded">
                                        ğŸ“· {entry.photos.length} photo{entry.photos.length > 1 ? 's' : ''}
                                    </span>
                                )}
                                {entry.improvements && (
                                    <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded">
                                        ğŸ”§ Improvements noted
                                    </span>
                                )}
                            </div>
                        </div>
                        
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                if (confirm('Delete this journal entry?')) onDelete(entry.id);
                            }}
                            className="ml-4 px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            );
        }
        function AddJournalModal({ onClose, onAdd }) {
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                location: '',
                locationDetails: { // NEW: Structured location data
                    address: '',
                    city: '',
                    state: '',
                    country: '',
                    formatted: ''
                },
                weather: { condition: 'Sunny', temp: '', emoji: 'â˜€ï¸', description: '' },
                dailyLog: '',
                thoughts: '',
                companions: [],
                contacts: [],
                campsiteGPS: '',
                improvements: '',
                photos: []
            });

            const [isLoadingLocation, setIsLoadingLocation] = useState(false);
            const [isLoadingWeather, setIsLoadingWeather] = useState(false);
            const [autoFillStatus, setAutoFillStatus] = useState('');

            const weatherOptions = [
                { condition: 'Sunny', emoji: 'â˜€ï¸' },
                { condition: 'Partly Cloudy', emoji: 'â›…' },
                { condition: 'Cloudy', emoji: 'â˜ï¸' },
                { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                { condition: 'Stormy', emoji: 'â›ˆï¸' },
                { condition: 'Snowy', emoji: 'â„ï¸' },
                { condition: 'Foggy', emoji: 'ğŸŒ«ï¸' },
                { condition: 'Windy', emoji: 'ğŸ’¨' }
            ];

            const [companionInput, setCompanionInput] = useState('');
            const [contactInput, setContactInput] = useState({ name: '', phone: '', email: '', notes: '' });

            // Smart Auto-Fill: Get Location + Weather in one click!
            const autoFillLocationAndWeather = async () => {
                setIsLoadingLocation(true);
                setIsLoadingWeather(true);
                setAutoFillStatus('ğŸ” Getting your location...');

                if (!navigator.geolocation) {
                    setAutoFillStatus('âŒ Geolocation not supported');
                    setIsLoadingLocation(false);
                    setIsLoadingWeather(false);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const gps = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

                        // Update GPS immediately
                        setFormData(prev => ({ ...prev, campsiteGPS: gps }));

                        try {
                            // Reverse Geocoding - Get location details
                            setAutoFillStatus('ğŸ“ Finding address...');
                            const geoResponse = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`,
                                { headers: { 'User-Agent': 'OverlandGearCatalog/1.0' } }
                            );
                            const geoData = await geoResponse.json();

                            const locationDetails = {
                                address: geoData.address?.road || geoData.address?.hamlet || '',
                                city: geoData.address?.city || geoData.address?.town || geoData.address?.village || '',
                                state: geoData.address?.state || geoData.address?.province || '',
                                country: geoData.address?.country || '',
                                formatted: geoData.display_name || ''
                            };

                            // Create clean location string
                            const locationParts = [
                                locationDetails.city,
                                locationDetails.state,
                                locationDetails.country
                            ].filter(Boolean);
                            const location = locationParts.join(', ');

                            setFormData(prev => ({
                                ...prev,
                                location: location,
                                locationDetails: locationDetails
                            }));

                            setIsLoadingLocation(false);
                            setAutoFillStatus('ğŸŒ¤ï¸ Getting weather...');

                            // Get Weather from Open-Meteo (free, no API key needed)
                            const weatherResponse = await fetch(
                                `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&temperature_unit=celsius`
                            );
                            const weatherData = await weatherResponse.json();

                            if (weatherData.current) {
                                const temp = Math.round(weatherData.current.temperature_2m);
                                const weatherCode = weatherData.current.weather_code;
                                
                                // Map weather codes to our conditions
                                const weatherMapping = {
                                    0: { condition: 'Sunny', emoji: 'â˜€ï¸' },
                                    1: { condition: 'Partly Cloudy', emoji: 'â›…' },
                                    2: { condition: 'Partly Cloudy', emoji: 'â›…' },
                                    3: { condition: 'Cloudy', emoji: 'â˜ï¸' },
                                    45: { condition: 'Foggy', emoji: 'ğŸŒ«ï¸' },
                                    48: { condition: 'Foggy', emoji: 'ğŸŒ«ï¸' },
                                    51: { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                                    53: { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                                    55: { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                                    61: { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                                    63: { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                                    65: { condition: 'Rainy', emoji: 'ğŸŒ§ï¸' },
                                    71: { condition: 'Snowy', emoji: 'â„ï¸' },
                                    73: { condition: 'Snowy', emoji: 'â„ï¸' },
                                    75: { condition: 'Snowy', emoji: 'â„ï¸' },
                                    95: { condition: 'Stormy', emoji: 'â›ˆï¸' },
                                    96: { condition: 'Stormy', emoji: 'â›ˆï¸' },
                                    99: { condition: 'Stormy', emoji: 'â›ˆï¸' }
                                };

                                const weather = weatherMapping[weatherCode] || weatherMapping[3];
                                
                                setFormData(prev => ({
                                    ...prev,
                                    weather: {
                                        condition: weather.condition,
                                        emoji: weather.emoji,
                                        temp: temp.toString()
                                    }
                                }));

                                setAutoFillStatus(`âœ… Auto-filled: ${location} â€¢ ${weather.emoji} ${temp}Â°C`);
                            }

                            setIsLoadingWeather(false);
                            
                            // Clear status after 3 seconds
                            setTimeout(() => setAutoFillStatus(''), 3000);

                        } catch (error) {
                            console.error('Auto-fill error:', error);
                            setAutoFillStatus('âš ï¸ Auto-fill partial - some data unavailable');
                            setIsLoadingLocation(false);
                            setIsLoadingWeather(false);
                            setTimeout(() => setAutoFillStatus(''), 3000);
                        }
                    },
                    (error) => {
                        setAutoFillStatus('âŒ Could not get location: ' + error.message);
                        setIsLoadingLocation(false);
                        setIsLoadingWeather(false);
                        setTimeout(() => setAutoFillStatus(''), 3000);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd(formData);
            };

            const addCompanion = () => {
                if (companionInput.trim()) {
                    setFormData({
                        ...formData,
                        companions: [...formData.companions, companionInput.trim()]
                    });
                    setCompanionInput('');
                }
            };

            const removeCompanion = (index) => {
                setFormData({
                    ...formData,
                    companions: formData.companions.filter((_, i) => i !== index)
                });
            };

            const addContact = () => {
                if (contactInput.name.trim()) {
                    setFormData({
                        ...formData,
                        contacts: [...formData.contacts, { ...contactInput, id: Date.now() }]
                    });
                    setContactInput({ name: '', phone: '', email: '', notes: '' });
                }
            };

            const removeContact = (id) => {
                setFormData({
                    ...formData,
                    contacts: formData.contacts.filter(c => c.id !== id)
                });
            };

            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setFormData(prev => ({
                            ...prev,
                            photos: [...prev.photos, {
                                data: event.target.result,
                                name: file.name,
                                id: Date.now() + Math.random()
                            }]
                        }));
                    };
                    reader.readAsDataURL(file);
                });
            };

            const removePhoto = (id) => {
                setFormData({
                    ...formData,
                    photos: formData.photos.filter(p => p.id !== id)
                });
            };

            const getCurrentGPS = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const gps = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                            setFormData({ ...formData, campsiteGPS: gps });
                        },
                        (error) => {
                            alert('Unable to get GPS location: ' + error.message);
                        }
                    );
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full my-8">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-6 rounded-t-2xl sticky top-0 z-10">
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-white">New Journal Entry</h2>
                                <button onClick={onClose} className="text-white hover:text-indigo-200">
                                    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="p-8 space-y-6 max-h-[80vh] overflow-y-auto">
                            {/* Smart Auto-Fill Section */}
                            <div className="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-300 rounded-xl p-6">
                                <div className="flex items-center justify-between mb-3">
                                    <div>
                                        <h3 className="text-lg font-bold text-green-900 flex items-center space-x-2">
                                            <span>ğŸ¤–</span>
                                            <span>Smart Auto-Fill</span>
                                        </h3>
                                        <p className="text-sm text-green-700 mt-1">
                                            Click to automatically fill location, weather, and GPS using your device
                                        </p>
                                    </div>
                                    <button
                                        type="button"
                                        onClick={autoFillLocationAndWeather}
                                        disabled={isLoadingLocation || isLoadingWeather}
                                        className="px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 disabled:bg-gray-400 flex items-center space-x-2 transition"
                                    >
                                        {(isLoadingLocation || isLoadingWeather) ? (
                                            <>
                                                <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                <span>Loading...</span>
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                                </svg>
                                                <span>Auto-Fill Now</span>
                                            </>
                                        )}
                                    </button>
                                </div>
                                {autoFillStatus && (
                                    <div className="mt-3 p-3 bg-white rounded-lg border-2 border-green-400">
                                        <p className="text-sm font-medium text-green-900">{autoFillStatus}</p>
                                    </div>
                                )}
                                <div className="mt-3 text-xs text-green-800">
                                    <strong>Fills automatically:</strong> GPS coordinates, city, state, country, current temperature, weather conditions
                                </div>
                            </div>

                            {/* Date */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                                <input
                                    type="date"
                                    required
                                    value={formData.date}
                                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                />
                            </div>

                            {/* Location - Enhanced with structured data */}
                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <label className="block text-sm font-medium text-blue-900 mb-2">
                                    Location (Auto-filled or manual)
                                </label>
                                <input
                                    type="text"
                                    value={formData.location}
                                    onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                    placeholder="e.g., Whitehorse, YT, Canada (or use Auto-Fill above)"
                                    className="w-full px-4 py-2 border-2 border-blue-300 rounded-lg mb-2"
                                />
                                {formData.locationDetails.formatted && (
                                    <div className="text-xs text-blue-700 mt-2">
                                        <strong>Full address:</strong> {formData.locationDetails.formatted}
                                    </div>
                                )}
                            </div>

                            {/* Weather - Enhanced */}
                            <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                <label className="block text-sm font-medium text-yellow-900 mb-3">
                                    Weather (Auto-filled or manual)
                                </label>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs text-yellow-800 mb-1">Condition</label>
                                        <select
                                            value={formData.weather.condition}
                                            onChange={(e) => {
                                                const option = weatherOptions.find(w => w.condition === e.target.value);
                                                setFormData({
                                                    ...formData,
                                                    weather: { ...formData.weather, condition: option.condition, emoji: option.emoji }
                                                });
                                            }}
                                            className="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg"
                                        >
                                            {weatherOptions.map(w => (
                                                <option key={w.condition} value={w.condition}>{w.emoji} {w.condition}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-yellow-800 mb-1">Temperature (Â°C)</label>
                                        <input
                                            type="number"
                                            value={formData.weather.temp}
                                            onChange={(e) => setFormData({
                                                ...formData,
                                                weather: { ...formData.weather, temp: e.target.value }
                                            })}
                                            placeholder="Temperature"
                                            className="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Daily Log - FOCUSED SECTION */}
                            <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-300 rounded-lg p-5">
                                <label className="block text-sm font-bold text-purple-900 mb-2">
                                    ğŸ“ Daily Log * (Focus here - other details auto-filled!)
                                </label>
                                <textarea
                                    required
                                    value={formData.dailyLog}
                                    onChange={(e) => setFormData({ ...formData, dailyLog: e.target.value })}
                                    placeholder="What happened today? Where did you go? What did you see?"
                                    rows="5"
                                    className="w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                />
                            </div>

                            {/* Thoughts & Feelings - FOCUSED SECTION */}
                            <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-lg p-5">
                                <label className="block text-sm font-bold text-indigo-900 mb-2">
                                    ğŸ’­ Thoughts & Feelings (Spend time here!)
                                </label>
                                <textarea
                                    value={formData.thoughts}
                                    onChange={(e) => setFormData({ ...formData, thoughts: e.target.value })}
                                    placeholder="How are you feeling? Reflections, emotions, personal thoughts..."
                                    rows="4"
                                    className="w-full px-4 py-2 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                />
                            </div>

                            {/* Travel Companions */}
                            <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                                <label className="block text-sm font-medium text-purple-900 mb-2">Travel Companions</label>
                                <div className="flex gap-2 mb-3">
                                    <input
                                        type="text"
                                        value={companionInput}
                                        onChange={(e) => setCompanionInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addCompanion())}
                                        placeholder="Name of companion"
                                        className="flex-1 px-4 py-2 border-2 border-purple-300 rounded-lg"
                                    />
                                    <button
                                        type="button"
                                        onClick={addCompanion}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                    >
                                        Add
                                    </button>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {formData.companions.map((comp, idx) => (
                                        <span key={idx} className="px-3 py-1 bg-purple-200 text-purple-900 rounded-full flex items-center space-x-2">
                                            <span>{comp}</span>
                                            <button
                                                type="button"
                                                onClick={() => removeCompanion(idx)}
                                                className="text-purple-700 hover:text-purple-900"
                                            >Ã—</button>
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* People Met / Contacts */}
                            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                <label className="block text-sm font-medium text-green-900 mb-3">People Met / Contacts</label>
                                <div className="grid md:grid-cols-2 gap-3 mb-3">
                                    <input
                                        type="text"
                                        value={contactInput.name}
                                        onChange={(e) => setContactInput({ ...contactInput, name: e.target.value })}
                                        placeholder="Name *"
                                        className="px-4 py-2 border-2 border-green-300 rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        value={contactInput.phone}
                                        onChange={(e) => setContactInput({ ...contactInput, phone: e.target.value })}
                                        placeholder="Phone"
                                        className="px-4 py-2 border-2 border-green-300 rounded-lg"
                                    />
                                    <input
                                        type="email"
                                        value={contactInput.email}
                                        onChange={(e) => setContactInput({ ...contactInput, email: e.target.value })}
                                        placeholder="Email"
                                        className="px-4 py-2 border-2 border-green-300 rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        value={contactInput.notes}
                                        onChange={(e) => setContactInput({ ...contactInput, notes: e.target.value })}
                                        placeholder="How you met / Notes"
                                        className="px-4 py-2 border-2 border-green-300 rounded-lg"
                                    />
                                </div>
                                <button
                                    type="button"
                                    onClick={addContact}
                                    className="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mb-3"
                                >
                                    Add Contact
                                </button>
                                <div className="space-y-2">
                                    {formData.contacts.map(contact => (
                                        <div key={contact.id} className="bg-white p-3 rounded border border-green-300 flex justify-between">
                                            <div>
                                                <div className="font-semibold">{contact.name}</div>
                                                {contact.phone && <div className="text-sm text-gray-600">ğŸ“ {contact.phone}</div>}
                                                {contact.email && <div className="text-sm text-gray-600">ğŸ“§ {contact.email}</div>}
                                                {contact.notes && <div className="text-sm text-gray-600">ğŸ’¬ {contact.notes}</div>}
                                            </div>
                                            <button
                                                type="button"
                                                onClick={() => removeContact(contact.id)}
                                                className="text-red-600 hover:text-red-800"
                                            >Delete</button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Campsite GPS */}
                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                <label className="block text-sm font-medium text-blue-900 mb-2">
                                    Campsite GPS (Auto-filled or manual)
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={formData.campsiteGPS}
                                        onChange={(e) => setFormData({ ...formData, campsiteGPS: e.target.value })}
                                        placeholder="e.g., 60.7212, -135.0568"
                                        className="flex-1 px-4 py-2 border-2 border-blue-300 rounded-lg"
                                    />
                                    <button
                                        type="button"
                                        onClick={getCurrentGPS}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span>GPS Only</span>
                                    </button>
                                </div>
                            </div>

                            {/* Photos */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Photos of the Day</label>
                                <input
                                    type="file"
                                    accept="image/*"
                                    multiple
                                    onChange={handlePhotoUpload}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                />
                                {formData.photos.length > 0 && (
                                    <div className="grid grid-cols-4 gap-2 mt-3">
                                        {formData.photos.map(photo => (
                                            <div key={photo.id} className="relative">
                                                <img src={photo.data} alt={photo.name} className="w-full h-24 object-cover rounded" />
                                                <button
                                                    type="button"
                                                    onClick={() => removePhoto(photo.id)}
                                                    className="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6"
                                                >Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Truck Improvements - FOCUSED SECTION */}
                            <div className="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-lg p-5">
                                <label className="block text-sm font-bold text-orange-900 mb-2">
                                    ğŸ”§ Truck Improvements / Future Work (Spend time here!)
                                </label>
                                <textarea
                                    value={formData.improvements}
                                    onChange={(e) => setFormData({ ...formData, improvements: e.target.value })}
                                    placeholder="Mechanical issues noticed, electrical problems, setup improvements needed, modifications to make, gear that didn't work, what to fix/improve..."
                                    rows="5"
                                    className="w-full px-4 py-2 border-2 border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                />
                                <p className="text-xs text-orange-700 mt-2">
                                    <strong>Examples:</strong> Roof rack needs reinforcement, auxiliary battery draining, need better water storage, suspension feels soft, lights not bright enough
                                </p>
                            </div>

                            {/* Submit */}
                            <div className="flex gap-3 pt-4 sticky bottom-0 bg-white pb-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700"
                                >
                                    Save Journal Entry
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ViewJournalModal({ entry, onClose, onDelete }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full my-8">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-8 py-6 rounded-t-2xl sticky top-0">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold text-white">{entry.date}</h2>
                                    {entry.location && <p className="text-indigo-100 mt-1">ğŸ“ {entry.location}</p>}
                                </div>
                                <button onClick={onClose} className="text-white hover:text-indigo-200">
                                    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div className="p-8 space-y-6 max-h-[80vh] overflow-y-auto">
                            {/* Weather */}
                            {entry.weather && (
                                <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-yellow-900 mb-2">Weather</h3>
                                    <div className="text-2xl">
                                        {entry.weather.emoji} {entry.weather.condition}
                                        {entry.weather.temp && ` â€¢ ${entry.weather.temp}Â°C`}
                                    </div>
                                </div>
                            )}

                            {/* Daily Log */}
                            <div>
                                <h3 className="font-semibold text-gray-900 mb-2">Daily Log</h3>
                                <div className="text-gray-800 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg">
                                    {entry.dailyLog}
                                </div>
                            </div>

                            {/* Thoughts */}
                            {entry.thoughts && (
                                <div>
                                    <h3 className="font-semibold text-gray-900 mb-2">Thoughts & Feelings</h3>
                                    <div className="text-gray-800 whitespace-pre-wrap bg-purple-50 p-4 rounded-lg border border-purple-200">
                                        {entry.thoughts}
                                    </div>
                                </div>
                            )}

                            {/* Companions */}
                            {entry.companions && entry.companions.length > 0 && (
                                <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-purple-900 mb-2">Travel Companions</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {entry.companions.map((comp, idx) => (
                                            <span key={idx} className="px-3 py-1 bg-purple-200 text-purple-900 rounded-full">
                                                ğŸ‘¥ {comp}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Contacts */}
                            {entry.contacts && entry.contacts.length > 0 && (
                                <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-green-900 mb-3">People Met</h3>
                                    <div className="space-y-3">
                                        {entry.contacts.map(contact => (
                                            <div key={contact.id} className="bg-white p-3 rounded border border-green-300">
                                                <div className="font-semibold text-lg">{contact.name}</div>
                                                {contact.phone && <div className="text-sm text-gray-600 mt-1">ğŸ“ {contact.phone}</div>}
                                                {contact.email && <div className="text-sm text-gray-600">ğŸ“§ {contact.email}</div>}
                                                {contact.notes && <div className="text-sm text-gray-700 mt-2 italic">{contact.notes}</div>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Campsite GPS */}
                            {entry.campsiteGPS && (
                                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-blue-900 mb-2">Campsite Location</h3>
                                    <div className="flex items-center space-x-3">
                                        <span className="text-blue-900 font-mono">{entry.campsiteGPS}</span>
                                        <a
                                            href={`https://www.google.com/maps?q=${entry.campsiteGPS}`}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                                        >
                                            Open in Maps
                                        </a>
                                    </div>
                                </div>
                            )}

                            {/* Photos */}
                            {entry.photos && entry.photos.length > 0 && (
                                <div>
                                    <h3 className="font-semibold text-gray-900 mb-3">Photos ({entry.photos.length})</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {entry.photos.map(photo => (
                                            <img
                                                key={photo.id}
                                                src={photo.data}
                                                alt={photo.name}
                                                className="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90"
                                                onClick={() => window.open(photo.data)}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Improvements */}
                            {entry.improvements && (
                                <div className="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
                                    <h3 className="font-semibold text-orange-900 mb-2">ğŸ”§ Truck Improvements / Future Work</h3>
                                    <div className="text-orange-900 whitespace-pre-wrap">
                                        {entry.improvements}
                                    </div>
                                </div>
                            )}

                            {/* Actions */}
                            <div className="flex gap-3 pt-4 border-t">
                                <button
                                    onClick={() => {
                                        if (confirm('Delete this journal entry?')) onDelete();
                                    }}
                                    className="px-6 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700"
                                >
                                    Delete Entry
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function FuelTrackingView({ fuelRecords, onAddRecord, onDeleteRecord, onUpdateRecord }) {
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedTab, setSelectedTab] = useState('all');
            
            // Calculate fuel economy statistics
            const calculateFuelEconomy = () => {
                if (fuelRecords.length < 2) return null;
                
                // Filter out records without odometer readings (historical entries)
                const withOdometer = fuelRecords.filter(r => r.odometer != null);
                if (withOdometer.length < 2) return null;
                
                const sorted = [...withOdometer].sort((a, b) => a.odometer - b.odometer);
                const economies = [];
                
                for (let i = 1; i < sorted.length; i++) {
                    const prev = sorted[i-1];
                    const curr = sorted[i];
                    const distance = curr.odometer - prev.odometer;
                    const fuelUsed = curr.liters;
                    
                    if (distance > 0 && fuelUsed > 0) {
                        const economy = (fuelUsed / distance) * 100; // L/100km
                        economies.push({
                            date: curr.date,
                            economy,
                            distance,
                            mpg: 235.21 / economy // Convert to MPG
                        });
                    }
                }
                
                if (economies.length === 0) return null;
                
                const avgEconomy = economies.reduce((sum, e) => sum + e.economy, 0) / economies.length;
                const bestEconomy = Math.min(...economies.map(e => e.economy));
                const worstEconomy = Math.max(...economies.map(e => e.economy));
                
                return {
                    average: avgEconomy,
                    best: bestEconomy,
                    worst: worstEconomy,
                    avgMPG: 235.21 / avgEconomy,
                    bestMPG: 235.21 / bestEconomy,
                    worstMPG: 235.21 / worstEconomy,
                    entries: economies
                };
            };

            const stats = calculateFuelEconomy();
            const totalSpent = fuelRecords.reduce((sum, r) => sum + (r.totalCost || 0), 0);
            const totalLiters = fuelRecords.reduce((sum, r) => sum + (r.liters || 0), 0);
            const avgPricePerLiter = totalLiters > 0 ? totalSpent / totalLiters : 0;

            const sortedRecords = [...fuelRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-orange-600 to-red-600 p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-3xl font-bold text-white flex items-center space-x-3">
                                    <span>â›½</span>
                                    <span>Fuel Tracking</span>
                                </h2>
                                <p className="text-orange-50 mt-2">
                                    Track every fuel purchase, calculate fuel economy, monitor costs
                                </p>
                            </div>
                            <button
                                onClick={() => setShowAddModal(true)}
                                className="px-6 py-3 bg-white text-orange-600 rounded-lg font-bold hover:bg-orange-50 transition flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                <span>Add Fuel Purchase</span>
                            </button>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-orange-500">
                            <div className="text-3xl font-bold text-orange-600">{fuelRecords.length}</div>
                            <div className="text-gray-600 mt-1">Total Fill-Ups</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <div className="text-3xl font-bold text-green-600">CAD ${totalSpent.toFixed(2)}</div>
                            <div className="text-gray-600 mt-1">Total Spent</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <div className="text-3xl font-bold text-blue-600">{totalLiters.toFixed(1)} L</div>
                            <div className="text-gray-600 mt-1">Total Fuel</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                            <div className="text-3xl font-bold text-purple-600">
                                {stats ? stats.average.toFixed(1) : '-'} L/100km
                            </div>
                            <div className="text-gray-600 mt-1">Average Economy</div>
                            {stats && <div className="text-sm text-purple-500 mt-1">{stats.avgMPG.toFixed(1)} MPG</div>}
                        </div>
                    </div>

                    {/* Fuel Economy Stats */}
                    {stats && (
                        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 p-5 rounded-xl">
                            <h3 className="font-bold text-blue-900 mb-4">ğŸ“Š Fuel Economy Statistics</h3>
                            <div className="grid md:grid-cols-3 gap-4">
                                <div className="bg-white p-4 rounded-lg">
                                    <div className="text-sm text-gray-600">Best Economy</div>
                                    <div className="text-2xl font-bold text-green-600">{stats.best.toFixed(1)} L/100km</div>
                                    <div className="text-sm text-green-600">{stats.bestMPG.toFixed(1)} MPG</div>
                                </div>
                                <div className="bg-white p-4 rounded-lg">
                                    <div className="text-sm text-gray-600">Average Economy</div>
                                    <div className="text-2xl font-bold text-blue-600">{stats.average.toFixed(1)} L/100km</div>
                                    <div className="text-sm text-blue-600">{stats.avgMPG.toFixed(1)} MPG</div>
                                </div>
                                <div className="bg-white p-4 rounded-lg">
                                    <div className="text-sm text-gray-600">Worst Economy</div>
                                    <div className="text-2xl font-bold text-red-600">{stats.worst.toFixed(1)} L/100km</div>
                                    <div className="text-sm text-red-600">{stats.worstMPG.toFixed(1)} MPG</div>
                                </div>
                            </div>
                            <div className="mt-4 bg-white p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-2">Cost Per Liter Average</div>
                                <div className="text-xl font-bold text-orange-600">CAD ${avgPricePerLiter.toFixed(3)}/L</div>
                            </div>
                        </div>
                    )}

                    {/* Tabs */}
                    <div className="flex space-x-2 border-b">
                        <button
                            onClick={() => setSelectedTab('all')}
                            className={`px-6 py-3 font-medium ${selectedTab === 'all' ? 'border-b-2 border-orange-600 text-orange-600' : 'text-gray-500'}`}
                        >
                            All Fill-Ups
                        </button>
                        <button
                            onClick={() => setSelectedTab('economy')}
                            className={`px-6 py-3 font-medium ${selectedTab === 'economy' ? 'border-b-2 border-orange-600 text-orange-600' : 'text-gray-500'}`}
                        >
                            Fuel Economy Details
                        </button>
                    </div>

                    {/* All Fill-Ups */}
                    {selectedTab === 'all' && (
                        <div className="space-y-3">
                            {sortedRecords.length === 0 ? (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <p className="text-gray-500 mb-4">No fuel purchases recorded yet</p>
                                    <button
                                        onClick={() => setShowAddModal(true)}
                                        className="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
                                    >
                                        Add First Fuel Purchase
                                    </button>
                                </div>
                            ) : (
                                sortedRecords.map((record, idx) => (
                                    <FuelRecordCard
                                        key={record.id}
                                        record={record}
                                        prevRecord={idx < sortedRecords.length - 1 ? sortedRecords[idx + 1] : null}
                                        onDelete={onDeleteRecord}
                                    />
                                ))
                            )}
                        </div>
                    )}

                    {/* Fuel Economy Details */}
                    {selectedTab === 'economy' && stats && (
                        <div className="space-y-3">
                            {stats.entries.reverse().map((entry, idx) => (
                                <div key={idx} className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <div className="font-semibold text-gray-900">{entry.date}</div>
                                            <div className="text-sm text-gray-600 mt-1">Distance: {entry.distance.toFixed(0)} km</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-2xl font-bold text-blue-600">{entry.economy.toFixed(1)} L/100km</div>
                                            <div className="text-sm text-blue-500">{entry.mpg.toFixed(1)} MPG</div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {showAddModal && (
                        <AddFuelModal
                            onClose={() => setShowAddModal(false)}
                            onAdd={(record) => {
                                onAddRecord(record);
                                setShowAddModal(false);
                            }}
                        />
                    )}
                </div>
            );
        }

        function FuelRecordCard({ record, prevRecord, onDelete }) {
            const [isExpanded, setIsExpanded] = useState(false);
            
            // Calculate economy if we have previous record AND both have odometer readings
            let economy = null;
            if (prevRecord && record.odometer && prevRecord.odometer) {
                const distance = record.odometer - prevRecord.odometer;
                if (distance > 0 && record.liters > 0) {
                    const lPer100km = (record.liters / distance) * 100;
                    const mpg = 235.21 / lPer100km;
                    economy = { lPer100km, mpg, distance };
                }
            }

            return (
                <div className="bg-white border-2 border-gray-200 rounded-lg p-5 hover:shadow-md transition">
                    <div className="flex justify-between items-start">
                        <div className="flex-1">
                            <div className="flex items-center space-x-3 mb-3">
                                <h3 className="font-bold text-lg text-gray-900">{record.date}</h3>
                                {record.station && (
                                    <span className="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium">
                                        {record.station}
                                    </span>
                                )}
                                {record.location && (
                                    <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                        ğŸ“ {record.location}
                                    </span>
                                )}
                                {record.isHistorical && (
                                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                        ğŸ“… Historical
                                    </span>
                                )}
                            </div>

                            <div className="grid md:grid-cols-4 gap-4 text-sm mb-3">
                                <div>
                                    <span className="text-gray-500">Odometer:</span>
                                    <div className="font-semibold">
                                        {record.odometer ? `${record.odometer.toLocaleString()} km` : 'Not recorded'}
                                    </div>
                                    {!record.odometer && (
                                        <div className="text-xs text-purple-600">Historical entry</div>
                                    )}
                                </div>
                                <div>
                                    <span className="text-gray-500">Fuel Amount:</span>
                                    <div className="font-semibold">{record.liters.toFixed(2)} L</div>
                                    <div className="text-xs text-gray-500">{(record.liters * 0.264172).toFixed(2)} gal</div>
                                </div>
                                <div>
                                    <span className="text-gray-500">Price/L:</span>
                                    <div className="font-semibold">CAD ${record.pricePerLiter.toFixed(3)}</div>
                                </div>
                                <div>
                                    <span className="text-gray-500">Total Cost:</span>
                                    <div className="font-semibold text-green-600">CAD ${record.totalCost.toFixed(2)}</div>
                                </div>
                            </div>

                            {economy && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                    <div className="text-sm font-medium text-blue-900 mb-2">â›½ Fuel Economy Since Last Fill-Up</div>
                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                        <div>
                                            <span className="text-blue-600">Distance:</span>
                                            <div className="font-bold text-blue-900">{economy.distance.toFixed(0)} km</div>
                                        </div>
                                        <div>
                                            <span className="text-blue-600">Economy:</span>
                                            <div className="font-bold text-blue-900">{economy.lPer100km.toFixed(1)} L/100km</div>
                                        </div>
                                        <div>
                                            <span className="text-blue-600">MPG:</span>
                                            <div className="font-bold text-blue-900">{economy.mpg.toFixed(1)} MPG</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {isExpanded && record.notes && (
                                <div className="mt-3 text-sm">
                                    <span className="text-gray-600 font-medium">Notes:</span>
                                    <div className="mt-1 text-gray-800">{record.notes}</div>
                                </div>
                            )}
                        </div>

                        <div className="flex flex-col space-y-2 ml-4">
                            {record.notes && (
                                <button
                                    onClick={() => setIsExpanded(!isExpanded)}
                                    className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200"
                                >
                                    {isExpanded ? 'Less' : 'Notes'}
                                </button>
                            )}
                            <button
                                onClick={() => {
                                    if (confirm('Delete this fuel record?')) onDelete(record.id);
                                }}
                                className="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AddFuelModal({ onClose, onAdd }) {
            const [isHistoricalMode, setIsHistoricalMode] = useState(false);
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                odometer: '',
                liters: '',
                pricePerLiter: '',
                totalCost: '',
                station: '',
                location: '',
                fuelType: '87 Regular',
                notes: '',
                isHistorical: false
            });

            const [autoCalc, setAutoCalc] = useState('total'); // 'total' or 'price'

            const calculateTotal = () => {
                if (formData.liters && formData.pricePerLiter) {
                    const total = parseFloat(formData.liters) * parseFloat(formData.pricePerLiter);
                    setFormData({...formData, totalCost: total.toFixed(2)});
                }
            };

            const calculatePrice = () => {
                if (formData.liters && formData.totalCost) {
                    const price = parseFloat(formData.totalCost) / parseFloat(formData.liters);
                    setFormData({...formData, pricePerLiter: price.toFixed(3)});
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({
                    ...formData,
                    odometer: formData.odometer ? parseFloat(formData.odometer) : null,
                    liters: parseFloat(formData.liters),
                    pricePerLiter: parseFloat(formData.pricePerLiter),
                    totalCost: parseFloat(formData.totalCost)
                });
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="bg-gradient-to-r from-orange-600 to-red-600 px-8 py-6 rounded-t-2xl sticky top-0">
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-white">Add Fuel Purchase</h2>
                                <button onClick={onClose} className="text-white hover:text-orange-200">
                                    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="p-8 space-y-4">
                            {/* Historical Mode Toggle */}
                            <div className="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                                <label className="flex items-center cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={isHistoricalMode}
                                        onChange={(e) => {
                                            setIsHistoricalMode(e.target.checked);
                                            setFormData({...formData, isHistorical: e.target.checked});
                                        }}
                                        className="w-5 h-5 text-purple-600 mr-3"
                                    />
                                    <div>
                                        <span className="font-semibold text-purple-900">
                                            ğŸ“… Historical Entry Mode (Past Fuel Purchases)
                                        </span>
                                        <p className="text-sm text-purple-700 mt-1">
                                            Enable this to add past fuel purchases where you don't have odometer readings. 
                                            Cost tracking only - no fuel economy calculation.
                                        </p>
                                    </div>
                                </label>
                            </div>

                            {isHistoricalMode && (
                                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                                    <h4 className="font-bold text-yellow-900 mb-2">ğŸ’¡ Historical Mode Tips:</h4>
                                    <ul className="text-sm text-yellow-800 space-y-1 list-disc list-inside">
                                        <li>Odometer is optional - leave blank if you don't remember</li>
                                        <li>Enter approximate dates from receipts or bank statements</li>
                                        <li>Add what you know: cost, location, station name</li>
                                        <li>These entries track spending but won't calculate fuel economy</li>
                                        <li>Start fresh tracking with odometer readings for future fill-ups!</li>
                                    </ul>
                                </div>
                            )}

                            <div className="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                                    <input
                                        type="date"
                                        required
                                        value={formData.date}
                                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Odometer (km) {!isHistoricalMode && '*'}
                                        {isHistoricalMode && <span className="text-purple-600 text-xs ml-1">(Optional in historical mode)</span>}
                                    </label>
                                    <input
                                        type="number"
                                        required={!isHistoricalMode}
                                        value={formData.odometer}
                                        onChange={(e) => setFormData({...formData, odometer: e.target.value})}
                                        placeholder={isHistoricalMode ? "Leave blank if unknown" : "230000"}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    />
                                    {isHistoricalMode && !formData.odometer && (
                                        <p className="text-xs text-purple-600 mt-1">
                                            No fuel economy will be calculated for this entry
                                        </p>
                                    )}
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Fuel Amount (Liters) *</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        required
                                        value={formData.liters}
                                        onChange={(e) => {
                                            setFormData({...formData, liters: e.target.value});
                                            if (autoCalc === 'total') setTimeout(calculateTotal, 100);
                                        }}
                                        placeholder="75.50"
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        {formData.liters && `â‰ˆ ${(formData.liters * 0.264172).toFixed(2)} gallons`}
                                    </p>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Fuel Type</label>
                                    <select
                                        value={formData.fuelType}
                                        onChange={(e) => setFormData({...formData, fuelType: e.target.value})}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    >
                                        <option>87 Regular</option>
                                        <option>89 Mid-Grade</option>
                                        <option>91 Premium</option>
                                        <option>Diesel</option>
                                    </select>
                                </div>
                            </div>

                            <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                                <div className="flex items-center space-x-4 mb-3">
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            checked={autoCalc === 'total'}
                                            onChange={() => setAutoCalc('total')}
                                            className="mr-2"
                                        />
                                        <span className="text-sm">I know price/L, calculate total</span>
                                    </label>
                                    <label className="flex items-center">
                                        <input
                                            type="radio"
                                            checked={autoCalc === 'price'}
                                            onChange={() => setAutoCalc('price')}
                                            className="mr-2"
                                        />
                                        <span className="text-sm">I know total, calculate price/L</span>
                                    </label>
                                </div>

                                <div className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Price per Liter (CAD) *
                                        </label>
                                        <input
                                            type="number"
                                            step="0.001"
                                            required
                                            value={formData.pricePerLiter}
                                            onChange={(e) => {
                                                setFormData({...formData, pricePerLiter: e.target.value});
                                                if (autoCalc === 'total') setTimeout(calculateTotal, 100);
                                            }}
                                            placeholder="1.459"
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Total Cost (CAD) *
                                        </label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            required
                                            value={formData.totalCost}
                                            onChange={(e) => {
                                                setFormData({...formData, totalCost: e.target.value});
                                                if (autoCalc === 'price') setTimeout(calculatePrice, 100);
                                            }}
                                            placeholder="110.15"
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Gas Station</label>
                                    <input
                                        type="text"
                                        value={formData.station}
                                        onChange={(e) => setFormData({...formData, station: e.target.value})}
                                        placeholder="Petro-Canada, Shell, Esso"
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                    <input
                                        type="text"
                                        value={formData.location}
                                        onChange={(e) => setFormData({...formData, location: e.target.value})}
                                        placeholder="Whitehorse, YT"
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    placeholder="Highway driving, towing trailer, winter conditions, etc."
                                    rows="2"
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                />
                            </div>

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-6 py-3 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700"
                                >
                                    Add Fuel Purchase
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ServiceReportsView({ serviceRecords, currentMileage }) {
            const [searchCategory, setSearchCategory] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedReport, setSelectedReport] = useState('quick');

            const categories = [
                'All Categories',
                'Oil Change',
                'Tire Service',
                'Brake Service',
                'Fluid Change/Top-up',
                'Filter Replacement',
                'Belt/Hose Replacement',
                'Suspension',
                'Electrical',
                'Transmission',
                'Differential',
                'Transfer Case',
                'Pre-Trip Inspection',
                'Post-Trip Inspection',
                'General Maintenance',
                'Repair',
                'Safety Inspection'
            ];

            // Quick answer queries
            const getLastService = (category) => {
                const filtered = serviceRecords.filter(r => 
                    category === 'All Categories' ? true : r.category === category
                );
                if (filtered.length === 0) return null;
                return filtered.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            };

            const getServicesByCategory = (category) => {
                return serviceRecords
                    .filter(r => category === 'All Categories' ? true : r.category === category)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            };

            const searchRecords = (term) => {
                if (!term) return [];
                const lower = term.toLowerCase();
                return serviceRecords.filter(r => 
                    r.workPerformed?.toLowerCase().includes(lower) ||
                    r.recommendations?.toLowerCase().includes(lower) ||
                    r.futureWork?.toLowerCase().includes(lower) ||
                    r.category.toLowerCase().includes(lower) ||
                    r.serviceProvider?.toLowerCase().includes(lower) ||
                    r.mechanicName?.toLowerCase().includes(lower) ||
                    r.location?.toLowerCase().includes(lower) ||
                    r.notes?.toLowerCase().includes(lower)
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
            };

            const categoryRecords = getServicesByCategory(searchCategory || 'All Categories');
            const searchResults = searchTerm ? searchRecords(searchTerm) : [];

            // Quick stats by category
            const getCategoryStats = () => {
                const stats = {};
                serviceRecords.forEach(r => {
                    if (!stats[r.category]) {
                        stats[r.category] = { count: 0, totalCost: 0, records: [] };
                    }
                    stats[r.category].count++;
                    stats[r.category].totalCost += parseFloat(r.cost || 0);
                    stats[r.category].records.push(r);
                });
                return stats;
            };

            const stats = getCategoryStats();

            return (
                <div className="space-y-6">
                    {/* Quick Search Tools */}
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-xl shadow-lg text-white">
                        <h3 className="text-2xl font-bold mb-2">ğŸ“Š Service History Reports & Search</h3>
                        <p className="text-blue-100">
                            Quickly find past services when mechanics ask: "When did you last change transmission fluid?"
                        </p>
                    </div>

                    {/* Report Type Selector */}
                    <div className="flex space-x-2 border-b">
                        <button
                            onClick={() => setSelectedReport('quick')}
                            className={`px-4 py-2 font-medium ${selectedReport === 'quick' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}
                        >
                            Quick Answers
                        </button>
                        <button
                            onClick={() => setSelectedReport('category')}
                            className={`px-4 py-2 font-medium ${selectedReport === 'category' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}
                        >
                            By Category
                        </button>
                        <button
                            onClick={() => setSelectedReport('search')}
                            className={`px-4 py-2 font-medium ${selectedReport === 'search' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}
                        >
                            Search All
                        </button>
                        <button
                            onClick={() => setSelectedReport('summary')}
                            className={`px-4 py-2 font-medium ${selectedReport === 'summary' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}
                        >
                            Summary Stats
                        </button>
                    </div>

                    {/* Quick Answers */}
                    {selectedReport === 'quick' && (
                        <div className="space-y-4">
                            <div className="bg-green-50 border-2 border-green-300 p-4 rounded-lg">
                                <h4 className="font-bold text-green-900 mb-2">ğŸ¯ Common Mechanic Questions - Quick Answers</h4>
                                <p className="text-sm text-green-800">Click any category to see when you last had that service</p>
                            </div>

                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {['Oil Change', 'Transmission', 'Differential', 'Brake Service', 'Tire Service', 'Filter Replacement', 'Belt/Hose Replacement', 'Fluid Change/Top-up'].map(cat => {
                                    const last = getLastService(cat);
                                    const records = getServicesByCategory(cat);
                                    return (
                                        <div key={cat} className="bg-white border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 transition">
                                            <h5 className="font-bold text-gray-900 mb-2">{cat}</h5>
                                            {last ? (
                                                <>
                                                    <div className="text-sm space-y-1">
                                                        <div><span className="text-gray-600">Last service:</span> <span className="font-semibold">{last.date}</span></div>
                                                        <div><span className="text-gray-600">Mileage:</span> <span className="font-semibold">{last.mileage.toLocaleString()} km</span></div>
                                                        <div><span className="text-gray-600">Km ago:</span> <span className="font-semibold">{(currentMileage - last.mileage).toLocaleString()} km</span></div>
                                                        <div><span className="text-gray-600">Provider:</span> <span className="font-semibold text-sm">{last.serviceProvider}</span></div>
                                                        {last.mechanicName && (
                                                            <div><span className="text-gray-600">Mechanic:</span> <span className="font-semibold text-sm">{last.mechanicName}</span></div>
                                                        )}
                                                    </div>
                                                    <div className="mt-3 text-xs text-gray-500">
                                                        Total {cat} services: {records.length}
                                                    </div>
                                                </>
                                            ) : (
                                                <div className="text-sm text-gray-500">No services recorded</div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* By Category View */}
                    {selectedReport === 'category' && (
                        <div className="space-y-4">
                            <div className="bg-white p-4 rounded-lg border-2 border-gray-200">
                                <label className="block font-medium text-gray-700 mb-2">Select Service Category:</label>
                                <select
                                    value={searchCategory}
                                    onChange={(e) => setSearchCategory(e.target.value)}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                >
                                    <option value="">Choose a category...</option>
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            {searchCategory && (
                                <>
                                    <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-lg">
                                        <h4 className="font-bold text-blue-900 mb-2">
                                            {searchCategory} History ({categoryRecords.length} service{categoryRecords.length !== 1 ? 's' : ''})
                                        </h4>
                                        {categoryRecords.length > 0 && (
                                            <div className="text-sm text-blue-800">
                                                <div>Most recent: {categoryRecords[0].date} @ {categoryRecords[0].mileage.toLocaleString()} km</div>
                                                <div>Total spent: CAD ${categoryRecords.reduce((sum, r) => sum + parseFloat(r.cost || 0), 0).toFixed(2)}</div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="space-y-3">
                                        {categoryRecords.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                No {searchCategory} services recorded yet
                                            </div>
                                        ) : (
                                            categoryRecords.map(record => (
                                                <ServiceRecordCard
                                                    key={record.id}
                                                    record={record}
                                                    onDelete={() => {}}
                                                    onUpdate={() => {}}
                                                />
                                            ))
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {/* Search All */}
                    {selectedReport === 'search' && (
                        <div className="space-y-4">
                            <div className="bg-white p-4 rounded-lg border-2 border-gray-200">
                                <label className="block font-medium text-gray-700 mb-2">Search all service records:</label>
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="e.g., transmission, brake pads, Mike, Whitehorse, coolant leak..."
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"
                                />
                                <p className="text-xs text-gray-500 mt-2">
                                    Searches: work performed, recommendations, future work, categories, providers, mechanics, locations, notes
                                </p>
                            </div>

                            {searchTerm && (
                                <>
                                    <div className="bg-green-50 border-2 border-green-300 p-4 rounded-lg">
                                        <h4 className="font-bold text-green-900">
                                            Found {searchResults.length} result{searchResults.length !== 1 ? 's' : ''} for "{searchTerm}"
                                        </h4>
                                    </div>

                                    <div className="space-y-3">
                                        {searchResults.length === 0 ? (
                                            <div className="text-center py-8 text-gray-500">
                                                No results found. Try different search terms.
                                            </div>
                                        ) : (
                                            searchResults.map(record => (
                                                <ServiceRecordCard
                                                    key={record.id}
                                                    record={record}
                                                    onDelete={() => {}}
                                                    onUpdate={() => {}}
                                                />
                                            ))
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {/* Summary Stats */}
                    {selectedReport === 'summary' && (
                        <div className="space-y-4">
                            <div className="bg-purple-50 border-2 border-purple-300 p-4 rounded-lg">
                                <h4 className="font-bold text-purple-900 mb-2">ğŸ“ˆ Service History Summary</h4>
                                <p className="text-sm text-purple-800">Overview of all services by category</p>
                            </div>

                            <div className="grid md:grid-cols-2 gap-4">
                                {Object.keys(stats).sort((a, b) => stats[b].count - stats[a].count).map(cat => {
                                    const catStats = stats[cat];
                                    const lastService = catStats.records.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                    return (
                                        <div key={cat} className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                            <h5 className="font-bold text-gray-900 mb-3">{cat}</h5>
                                            <div className="space-y-2 text-sm">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Total services:</span>
                                                    <span className="font-semibold">{catStats.count}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Total cost:</span>
                                                    <span className="font-semibold">CAD ${catStats.totalCost.toFixed(2)}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Average cost:</span>
                                                    <span className="font-semibold">CAD ${(catStats.totalCost / catStats.count).toFixed(2)}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Last service:</span>
                                                    <span className="font-semibold">{lastService.date}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">At mileage:</span>
                                                    <span className="font-semibold">{lastService.mileage.toLocaleString()} km</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-600">Km ago:</span>
                                                    <span className="font-semibold">{(currentMileage - lastService.mileage).toLocaleString()} km</span>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ServiceMaintenanceView({ serviceRecords, onAddRecord, onDeleteRecord, onUpdateRecord, vehicleBaseWeight }) {
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedTab, setSelectedTab] = useState('upcoming');
            const [currentMileage, setCurrentMileage] = useState(230000);
            
            // Calculate next service due dates based on current mileage
            const calculateNextService = (lastMileage, intervalKm) => {
                return lastMileage + intervalKm;
            };

            // Service categories
            const serviceCategories = [
                'Pre-Trip Inspection',
                'Post-Trip Inspection',
                'Oil Change',
                'Tire Service',
                'Brake Service',
                'Fluid Change/Top-up',
                'Filter Replacement',
                'Belt/Hose Replacement',
                'Suspension',
                'Electrical',
                'Transmission',
                'Differential',
                'Transfer Case',
                'General Maintenance',
                'Repair',
                'Safety Inspection',
                'Other'
            ];

            // Standard service intervals for 2003 Sierra Z71
            const serviceIntervals = {
                'Oil Change': { km: 5000, description: '5W-30, filter replacement' },
                'Tire Rotation': { km: 10000, description: 'Rotate and check pressure' },
                'Air Filter': { km: 20000, description: 'Replace engine air filter' },
                'Cabin Filter': { km: 20000, description: 'Replace cabin air filter' },
                'Fuel Filter': { km: 50000, description: 'Replace fuel filter' },
                'Brake Fluid': { km: 40000, description: 'Flush and replace DOT 3' },
                'Coolant': { km: 80000, description: 'Flush and replace Dex-Cool' },
                'Transmission Fluid': { km: 80000, description: 'Change Dexron VI' },
                'Transfer Case': { km: 80000, description: 'Change fluid' },
                'Front Diff': { km: 80000, description: '75W-90 GL-5' },
                'Rear Diff (G80)': { km: 50000, description: '75W-90, NO LS additives' },
                'Spark Plugs': { km: 160000, description: 'Replace (8 plugs)' },
                'Serpentine Belt': { km: 100000, description: 'Inspect/replace if worn' }
            };

            // Filter records
            const upcomingServices = Object.keys(serviceIntervals).map(service => {
                const lastService = serviceRecords
                    .filter(r => r.category === service || r.workPerformed.toLowerCase().includes(service.toLowerCase()))
                    .sort((a, b) => b.mileage - a.mileage)[0];
                
                const lastMileage = lastService ? lastService.mileage : 0;
                const nextDue = lastMileage + serviceIntervals[service].km;
                const kmUntilDue = nextDue - currentMileage;
                
                return {
                    service,
                    interval: serviceIntervals[service].km,
                    description: serviceIntervals[service].description,
                    lastMileage,
                    lastDate: lastService?.date || 'Never',
                    nextDue,
                    kmUntilDue,
                    overdue: kmUntilDue < 0,
                    dueSoon: kmUntilDue >= 0 && kmUntilDue <= 2000
                };
            }).sort((a, b) => a.kmUntilDue - b.kmUntilDue);

            const preTripInspections = serviceRecords.filter(r => 
                r.category === 'Pre-Trip Inspection'
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            const postTripInspections = serviceRecords.filter(r => 
                r.category === 'Post-Trip Inspection'
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            const allRecordsSorted = [...serviceRecords].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-green-600 to-emerald-600 p-6 rounded-xl shadow-lg">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-3xl font-bold text-white flex items-center space-x-3">
                                    <span>ğŸ”§</span>
                                    <span>Service & Maintenance Log</span>
                                </h2>
                                <p className="text-green-50 mt-2">
                                    Track professional services, inspections, and preventive maintenance
                                </p>
                                <div className="mt-3 bg-green-700 bg-opacity-50 p-3 rounded-lg">
                                    <p className="text-white text-sm font-medium">
                                        Prevention is better than cure - Keep your Sierra 1500 Z71 in tip-top shape
                                    </p>
                                </div>
                            </div>
                            <div className="flex space-x-3">
                                <button
                                    onClick={() => setShowAddModal(true)}
                                    className="px-6 py-3 bg-white text-green-600 rounded-lg font-bold hover:bg-green-50 transition flex items-center space-x-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                    </svg>
                                    <span>Add Service Record</span>
                                </button>
                                <button
                                    onClick={() => {
                                        const csvTemplate = `Date,Mileage (km),Category,Service Provider,Work Performed,Recommendations,Cost (CAD),Notes
2023-06-15,185000,Oil Change,Mr Lube,"Oil change 5W-30 6 qts filter replacement","Looks good continue regular maintenance",89.99,"Regular service"
2023-03-10,178000,Pre-Trip Inspection,Canadian Tire,"Full inspection brake check tire rotation fluid top-ups","Rear brake pads at 40% - replace in 10000 km. All else good.",125.00,"Pre-summer trip inspection"
2022-12-05,170000,Tire Service,Kal Tire,"Winter tire installation balance",None,75.00,"Seasonal changeover"

INSTRUCTIONS:
1. Fill in your historical service records (one per row)
2. Keep dates in YYYY-MM-DD format
3. Mileage in kilometers
4. Use double quotes around text with commas
5. Save as CSV file
6. Import back into app (feature coming soon)

For now copy this template and save your records externally!`;
                                        
                                        const blob = new Blob([csvTemplate], { type: 'text/csv' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = 'service-records-template.csv';
                                        a.click();
                                    }}
                                    className="px-4 py-3 bg-green-100 text-green-700 rounded-lg font-medium hover:bg-green-200 transition flex items-center space-x-2 text-sm"
                                    title="Download CSV template for bulk historical entry"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span>Download CSV Template</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Current Mileage */}
                    <div className="bg-blue-50 border-2 border-blue-300 p-5 rounded-xl">
                        <div className="flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-blue-900 mb-2">Current Vehicle Mileage</h3>
                                <div className="text-3xl font-bold text-blue-600">{currentMileage.toLocaleString()} km</div>
                                <div className="text-sm text-blue-700 mt-1">
                                    ({Math.round(currentMileage * 0.621371).toLocaleString()} miles)
                                </div>
                            </div>
                            <div>
                                <input
                                    type="number"
                                    value={currentMileage}
                                    onChange={(e) => setCurrentMileage(parseInt(e.target.value) || 0)}
                                    className="px-4 py-2 border-2 border-blue-300 rounded-lg text-right font-bold"
                                    placeholder="Mileage"
                                />
                                <div className="text-xs text-blue-600 mt-1 text-right">Update mileage</div>
                            </div>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <div className="text-3xl font-bold text-green-600">{serviceRecords.length}</div>
                            <div className="text-gray-600 mt-1">Total Service Records</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-500">
                            <div className="text-3xl font-bold text-red-600">
                                {upcomingServices.filter(s => s.overdue).length}
                            </div>
                            <div className="text-gray-600 mt-1">Overdue Services</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                            <div className="text-3xl font-bold text-yellow-600">
                                {upcomingServices.filter(s => s.dueSoon).length}
                            </div>
                            <div className="text-gray-600 mt-1">Due Soon (< 2,000 km)</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <div className="text-3xl font-bold text-blue-600">{preTrip Inspections.length}</div>
                            <div className="text-gray-600 mt-1">Pre-Trip Inspections</div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex space-x-2 border-b">
                        <button
                            onClick={() => setSelectedTab('upcoming')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'upcoming'
                                    ? 'border-b-3 border-green-600 text-green-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Upcoming Service Schedule
                        </button>
                        <button
                            onClick={() => setSelectedTab('pretrip')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'pretrip'
                                    ? 'border-b-3 border-green-600 text-green-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Pre-Trip Inspections
                        </button>
                        <button
                            onClick={() => setSelectedTab('posttrip')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'posttrip'
                                    ? 'border-b-3 border-green-600 text-green-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Post-Trip Inspections
                        </button>
                        <button
                            onClick={() => setSelectedTab('all')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'all'
                                    ? 'border-b-3 border-green-600 text-green-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            All Service Records
                        </button>
                        <button
                            onClick={() => setSelectedTab('reports')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'reports'
                                    ? 'border-b-3 border-green-600 text-green-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            ğŸ“Š Reports & Search
                        </button>
                    </div>

                    {/* Tab Content */}
                    {selectedTab === 'reports' && (
                        <ServiceReportsView 
                            serviceRecords={serviceRecords}
                            currentMileage={currentMileage}
                        />
                    )}
                    {selectedTab === 'upcoming' && (
                        <div className="space-y-4">
                            <div className="bg-yellow-50 border-2 border-yellow-300 p-4 rounded-lg">
                                <h3 className="font-bold text-yellow-900 mb-2">â° Maintenance Schedule</h3>
                                <p className="text-sm text-yellow-800">
                                    Based on your current mileage ({currentMileage.toLocaleString()} km) and standard service intervals for 2003 GMC Sierra 1500 Z71
                                </p>
                            </div>

                            {upcomingServices.map((service, idx) => (
                                <div
                                    key={idx}
                                    className={`border-2 rounded-lg p-5 ${
                                        service.overdue
                                            ? 'border-red-400 bg-red-50'
                                            : service.dueSoon
                                            ? 'border-yellow-400 bg-yellow-50'
                                            : 'border-gray-200 bg-white'
                                    }`}
                                >
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <div className="flex items-center space-x-3">
                                                <h3 className="font-bold text-lg text-gray-900">{service.service}</h3>
                                                {service.overdue && (
                                                    <span className="px-3 py-1 bg-red-600 text-white rounded-full text-xs font-bold">
                                                        OVERDUE
                                                    </span>
                                                )}
                                                {service.dueSoon && !service.overdue && (
                                                    <span className="px-3 py-1 bg-yellow-600 text-white rounded-full text-xs font-bold">
                                                        DUE SOON
                                                    </span>
                                                )}
                                            </div>
                                            <div className="text-sm text-gray-600 mt-1">{service.description}</div>
                                            <div className="mt-3 grid md:grid-cols-4 gap-4 text-sm">
                                                <div>
                                                    <span className="text-gray-500">Interval:</span>
                                                    <div className="font-semibold">Every {service.interval.toLocaleString()} km</div>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Last Service:</span>
                                                    <div className="font-semibold">
                                                        {service.lastMileage > 0 ? `${service.lastMileage.toLocaleString()} km` : 'Never'}
                                                    </div>
                                                    <div className="text-xs text-gray-500">{service.lastDate}</div>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">Next Due:</span>
                                                    <div className="font-semibold">{service.nextDue.toLocaleString()} km</div>
                                                </div>
                                                <div>
                                                    <span className="text-gray-500">
                                                        {service.overdue ? 'Overdue by:' : 'Due in:'}
                                                    </span>
                                                    <div className={`font-bold text-lg ${
                                                        service.overdue ? 'text-red-600' : service.dueSoon ? 'text-yellow-600' : 'text-green-600'
                                                    }`}>
                                                        {Math.abs(service.kmUntilDue).toLocaleString()} km
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {selectedTab === 'pretrip' && (
                        <div className="space-y-4">
                            <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-lg">
                                <h3 className="font-bold text-blue-900 mb-2">ğŸ” Pre-Trip Inspections</h3>
                                <p className="text-sm text-blue-800">
                                    Professional mechanic inspections BEFORE departing on trips. Get expert eyes on your truck to catch potential issues.
                                </p>
                            </div>
                            {preTripInspections.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <p>No pre-trip inspections recorded yet.</p>
                                    <button
                                        onClick={() => setShowAddModal(true)}
                                        className="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        Add First Pre-Trip Inspection
                                    </button>
                                </div>
                            ) : (
                                preTripInspections.map(record => (
                                    <ServiceRecordCard
                                        key={record.id}
                                        record={record}
                                        onDelete={onDeleteRecord}
                                        onUpdate={onUpdateRecord}
                                    />
                                ))
                            )}
                        </div>
                    )}

                    {selectedTab === 'posttrip' && (
                        <div className="space-y-4">
                            <div className="bg-purple-50 border-2 border-purple-300 p-4 rounded-lg">
                                <h3 className="font-bold text-purple-900 mb-2">âœ… Post-Trip Inspections</h3>
                                <p className="text-sm text-purple-800">
                                    Professional mechanic inspections AFTER trips. Assess wear, damage, and maintenance needs from the journey.
                                </p>
                            </div>
                            {postTripInspections.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <p>No post-trip inspections recorded yet.</p>
                                    <button
                                        onClick={() => setShowAddModal(true)}
                                        className="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        Add First Post-Trip Inspection
                                    </button>
                                </div>
                            ) : (
                                postTripInspections.map(record => (
                                    <ServiceRecordCard
                                        key={record.id}
                                        record={record}
                                        onDelete={onDeleteRecord}
                                        onUpdate={onUpdateRecord}
                                    />
                                ))
                            )}
                        </div>
                    )}

                    {selectedTab === 'all' && (
                        <div className="space-y-4">
                            {allRecordsSorted.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <p>No service records yet. Add your first service!</p>
                                    <button
                                        onClick={() => setShowAddModal(true)}
                                        className="mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        Add First Service Record
                                    </button>
                                </div>
                            ) : (
                                allRecordsSorted.map(record => (
                                    <ServiceRecordCard
                                        key={record.id}
                                        record={record}
                                        onDelete={onDeleteRecord}
                                        onUpdate={onUpdateRecord}
                                    />
                                ))
                            )}
                        </div>
                    )}

                    {/* Add Service Modal */}
                    {showAddModal && (
                        <AddServiceRecordModal
                            onClose={() => setShowAddModal(false)}
                            onAdd={(record) => {
                                onAddRecord(record);
                                setShowAddModal(false);
                            }}
                            categories={serviceCategories}
                            currentMileage={currentMileage}
                        />
                    )}
                </div>
            );
        }

        function ServiceRecordCard({ record, onDelete, onUpdate }) {
            const [isExpanded, setIsExpanded] = useState(false);
            const [selectedPhoto, setSelectedPhoto] = useState(null);

            return (
                <>
                    <div className="border-2 border-gray-200 rounded-lg p-5 bg-white hover:shadow-md transition">
                        <div className="flex justify-between items-start">
                            <div className="flex-1">
                                <div className="flex items-center space-x-3 mb-2">
                                    <h3 className="font-bold text-lg text-gray-900">{record.category}</h3>
                                    <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                        {record.serviceProvider}
                                    </span>
                                    {record.mechanicName && (
                                        <span className="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium">
                                            ğŸ‘¤ {record.mechanicName}
                                        </span>
                                    )}
                                    {record.isHistorical && (
                                        <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                            ğŸ“… Historical
                                        </span>
                                    )}
                                    {record.photos && record.photos.length > 0 && (
                                        <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium flex items-center space-x-1">
                                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <span>{record.photos.length} photo{record.photos.length > 1 ? 's' : ''}</span>
                                        </span>
                                    )}
                                </div>
                                <div className="grid md:grid-cols-4 gap-4 text-sm mb-3">
                                    <div>
                                        <span className="text-gray-500">Date:</span>
                                        <div className="font-semibold">{record.date}</div>
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Mileage:</span>
                                        <div className="font-semibold">{record.mileage.toLocaleString()} km</div>
                                    </div>
                                    <div>
                                        <span className="text-gray-500">Cost:</span>
                                        <div className="font-semibold">CAD ${record.cost || '0'}</div>
                                    </div>
                                    {record.location && (
                                        <div>
                                            <span className="text-gray-500">ğŸ“ Location:</span>
                                            <div className="font-semibold text-blue-700">{record.location}</div>
                                        </div>
                                    )}
                                </div>
                                {!record.location && (
                                    <div className="text-xs text-gray-400 mb-2">
                                        ğŸ“ Location not recorded
                                    </div>
                                )}
                                <div className="text-sm">
                                    <span className="text-gray-600 font-medium">Work Performed:</span>
                                    <div className="mt-1 text-gray-800">{record.workPerformed}</div>
                                </div>
                                {isExpanded && (
                                    <div className="mt-4 space-y-3 text-sm border-t pt-4">
                                        {record.location && (
                                            <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                                <span className="text-gray-600 font-medium">ğŸ“ Service Location:</span>
                                                <div className="mt-1 text-blue-900 font-semibold">{record.location}</div>
                                                <p className="text-xs text-blue-600 mt-1">
                                                    This service was performed at this location on your journey
                                                </p>
                                            </div>
                                        )}
                                        {record.mechanicName && (
                                            <div className="bg-indigo-50 p-3 rounded border border-indigo-200">
                                                <span className="text-gray-600 font-medium">ğŸ‘¤ Mechanic/Technician:</span>
                                                <div className="mt-1 text-indigo-900 font-semibold">{record.mechanicName}</div>
                                                <p className="text-xs text-indigo-600 mt-1">
                                                    Ask for this person next time for consistent service
                                                </p>
                                            </div>
                                        )}
                                        {record.recommendations && (
                                            <div>
                                                <span className="text-gray-600 font-medium">ğŸ’¬ Immediate Recommendations:</span>
                                                <div className="mt-1 text-gray-800 bg-green-50 p-3 rounded border border-green-200">
                                                    {record.recommendations}
                                                </div>
                                            </div>
                                        )}
                                        {record.futureWork && (
                                            <div>
                                                <span className="text-gray-600 font-medium">âš ï¸ Future Work Needed:</span>
                                                <div className="mt-1 text-gray-900 bg-yellow-50 p-3 rounded border-2 border-yellow-400">
                                                    <div className="font-semibold text-yellow-900 mb-1">
                                                        ACTION REQUIRED - Plan for this work:
                                                    </div>
                                                    <div className="whitespace-pre-wrap">{record.futureWork}</div>
                                                </div>
                                                <p className="text-xs text-yellow-700 mt-1 font-medium">
                                                    ğŸ’¡ Add reminder or schedule this work before it becomes urgent!
                                                </p>
                                            </div>
                                        )}
                                        {record.notes && (
                                            <div>
                                                <span className="text-gray-600 font-medium">Notes:</span>
                                                <div className="mt-1 text-gray-800">{record.notes}</div>
                                            </div>
                                        )}
                                        {record.photos && record.photos.length > 0 && (
                                            <div>
                                                <span className="text-gray-600 font-medium mb-2 block">
                                                    ğŸ“¸ Attached Photos ({record.photos.length}):
                                                </span>
                                                <div className="grid grid-cols-3 md:grid-cols-4 gap-2">
                                                    {record.photos.map((photo, index) => (
                                                        <div 
                                                            key={index}
                                                            onClick={() => setSelectedPhoto(photo)}
                                                            className="relative border-2 border-gray-200 rounded-lg overflow-hidden cursor-pointer hover:border-blue-500 transition group"
                                                        >
                                                            <img 
                                                                src={photo.data} 
                                                                alt={`Receipt ${index + 1}`}
                                                                className="w-full h-24 object-cover group-hover:opacity-75 transition"
                                                            />
                                                            <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition bg-black bg-opacity-50">
                                                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                                                                </svg>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                                <p className="text-xs text-gray-500 mt-2">Click photo to view full size</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                            <div className="flex flex-col space-y-2 ml-4">
                                <button
                                    onClick={() => setIsExpanded(!isExpanded)}
                                    className="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200"
                                >
                                    {isExpanded ? 'Less' : 'More'}
                                </button>
                                <button
                                    onClick={() => {
                                        if (confirm('Delete this service record?')) {
                                            onDelete(record.id);
                                        }
                                    }}
                                    className="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Photo Lightbox Modal */}
                    {selectedPhoto && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4"
                            onClick={() => setSelectedPhoto(null)}
                        >
                            <div className="relative max-w-6xl w-full">
                                <button
                                    onClick={() => setSelectedPhoto(null)}
                                    className="absolute top-4 right-4 bg-white text-gray-800 rounded-full p-2 hover:bg-gray-200 z-10"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                                <img 
                                    src={selectedPhoto.data} 
                                    alt="Full size receipt"
                                    className="w-full h-auto max-h-[90vh] object-contain rounded-lg"
                                    onClick={(e) => e.stopPropagation()}
                                />
                                <div className="absolute bottom-4 left-4 bg-black bg-opacity-75 text-white px-4 py-2 rounded">
                                    {selectedPhoto.name}
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        function AddServiceRecordModal({ onClose, onAdd, categories, currentMileage }) {
            const [isHistoricalEntry, setIsHistoricalEntry] = useState(false);
            const [customProviders, setCustomProviders] = useState(() => {
                const saved = localStorage.getItem('customServiceProviders');
                return saved ? JSON.parse(saved) : [];
            });
            const [showAddProvider, setShowAddProvider] = useState(false);
            const [newProviderName, setNewProviderName] = useState('');
            
            const [formData, setFormData] = useState({
                date: new Date().toISOString().split('T')[0],
                mileage: currentMileage,
                category: categories[0],
                serviceProvider: '',
                mechanicName: '',
                location: '',
                workPerformed: '',
                recommendations: '',
                futureWork: '',
                cost: '',
                notes: '',
                photos: [], // Array to store photo data URLs
                isHistorical: false
            });

            // Common service providers - North America (Canada + USA + Mexico)
            const defaultProviders = [
                // === CANADA ===
                'Mr Lube (Canada)',
                'Canadian Tire',
                'NAPA Auto Parts Canada',
                'Lordco (BC)',
                'Princess Auto',
                'OK Tire',
                'Fountain Tire',
                'Kal Tire',
                'Integra Tire & Auto Centres',
                'Active Green + Ross',
                'Midas Canada',
                'Meineke Canada',
                'Speedy Auto Service',
                'Rust Check Canada',
                'Jiffy Lube Canada',
                'Petro-Canada (service)',
                'GMC/Chevrolet Dealership (Canada)',
                'GM Canada Dealership',
                
                // === USA ===
                'Jiffy Lube (USA)',
                'Valvoline Instant Oil Change',
                'Take 5 Oil Change',
                'Grease Monkey',
                'Pep Boys',
                'AutoZone (service)',
                'O\'Reilly Auto Parts (service)',
                'Advance Auto Parts (service)',
                'NAPA AutoCare (USA)',
                'Firestone Complete Auto Care',
                'Goodyear Auto Service',
                'Discount Tire',
                'Big O Tires',
                'Tire Discounters',
                'Midas (USA)',
                'Meineke (USA)',
                'Maaco',
                'AAMCO',
                'Pep Boys',
                'Monro Auto Service',
                'Christian Brothers Automotive',
                'GMC/Chevrolet Dealership (USA)',
                'GM Dealership USA',
                'Walmart Auto Care Center',
                'Costco Tire Center',
                'Sam\'s Club Tire & Battery',
                
                // === MEXICO ===
                'AutoZone Mexico',
                'Puma Energy (Mexico)',
                'Mobil Oil Mexico',
                'Castrol Service (Mexico)',
                'Chevrolet Dealership Mexico',
                'GM Mexico Service',
                
                // === UNIVERSAL ===
                'Independent Mechanic',
                'Mobile Mechanic',
                'Roadside Assistance',
                'Self (DIY)',
                'Friend/Family Help',
                'Other'
            ];

            // Combine default + custom providers
            const allProviders = [...defaultProviders, ...customProviders].sort();

            // Save custom providers to localStorage
            const addCustomProvider = () => {
                if (newProviderName.trim() && !allProviders.includes(newProviderName.trim())) {
                    const updated = [...customProviders, newProviderName.trim()];
                    setCustomProviders(updated);
                    localStorage.setItem('customServiceProviders', JSON.stringify(updated));
                    setFormData({...formData, serviceProvider: newProviderName.trim()});
                    setNewProviderName('');
                    setShowAddProvider(false);
                }
            };

            const handlePhotoUpload = (e) => {
                const files = Array.from(e.target.files);
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            setFormData(prev => ({
                                ...prev,
                                photos: [...prev.photos, {
                                    data: event.target.result,
                                    name: file.name,
                                    uploadDate: new Date().toISOString()
                                }]
                            }));
                        };
                        reader.readAsDataURL(file);
                    }
                });
            };

            const removePhoto = (index) => {
                setFormData(prev => ({
                    ...prev,
                    photos: prev.photos.filter((_, i) => i !== index)
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full my-8">
                        <div className="bg-gradient-to-r from-green-600 to-emerald-600 px-8 py-6 rounded-t-2xl">
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-white">Add Service Record</h2>
                                <button
                                    onClick={onClose}
                                    className="text-white hover:text-green-200 transition"
                                >
                                    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="p-8 space-y-4 max-h-[70vh] overflow-y-auto">
                            {/* Historical Entry Mode Toggle */}
                            <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-lg">
                                <label className="flex items-center space-x-3 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={isHistoricalEntry}
                                        onChange={(e) => {
                                            setIsHistoricalEntry(e.target.checked);
                                            setFormData({...formData, isHistorical: e.target.checked});
                                        }}
                                        className="w-5 h-5 text-blue-600 rounded"
                                    />
                                    <div>
                                        <span className="font-bold text-blue-900">ğŸ“… Historical Entry Mode</span>
                                        <p className="text-xs text-blue-700 mt-1">
                                            Enable this to backdate service records from before you started using this app. 
                                            Perfect for building your complete maintenance history since 2018!
                                        </p>
                                    </div>
                                </label>
                            </div>

                            {isHistoricalEntry && (
                                <div className="bg-yellow-50 border-2 border-yellow-300 p-4 rounded-lg">
                                    <h4 className="font-bold text-yellow-900 mb-2">ğŸ’¡ Tips for Historical Entries:</h4>
                                    <ul className="text-sm text-yellow-800 space-y-1 list-disc list-inside">
                                        <li>Enter date and mileage as accurately as possible</li>
                                        <li>Photo old receipts if you still have them</li>
                                        <li>Add approximate costs from memory or bank statements</li>
                                        <li>Note: "Approximate - from memory" in notes if uncertain</li>
                                        <li>Start with major services first (oil changes, inspections)</li>
                                    </ul>
                                </div>
                            )}

                            <div className="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Date *
                                    </label>
                                    <input
                                        type="date"
                                        required
                                        value={formData.date}
                                        onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Mileage (km) *
                                    </label>
                                    <input
                                        type="number"
                                        required
                                        value={formData.mileage}
                                        onChange={(e) => setFormData({ ...formData, mileage: parseInt(e.target.value) })}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Service Category *
                                </label>
                                <select
                                    value={formData.category}
                                    onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                >
                                    {categories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Service Provider *
                                </label>
                                <div className="flex gap-2">
                                    <div className="flex-1">
                                        <input
                                            type="text"
                                            required
                                            list="common-providers"
                                            value={formData.serviceProvider}
                                            onChange={(e) => setFormData({ ...formData, serviceProvider: e.target.value })}
                                            placeholder="Start typing or select from list..."
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                        />
                                        <datalist id="common-providers">
                                            {allProviders.map((provider, idx) => (
                                                <option key={idx} value={provider} />
                                            ))}
                                        </datalist>
                                    </div>
                                    <button
                                        type="button"
                                        onClick={() => setShowAddProvider(!showAddProvider)}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition whitespace-nowrap"
                                        title="Add custom provider to list"
                                    >
                                        + Add New
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">
                                    {allProviders.length} providers available. Type to search or add your own.
                                    {customProviders.length > 0 && ` (${customProviders.length} custom added)`}
                                </p>
                                
                                {showAddProvider && (
                                    <div className="mt-3 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                                        <label className="block text-sm font-medium text-blue-900 mb-2">
                                            Add Custom Service Provider
                                        </label>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                value={newProviderName}
                                                onChange={(e) => setNewProviderName(e.target.value)}
                                                placeholder="e.g., Bob's Garage, Jose's Taller"
                                                className="flex-1 px-4 py-2 border-2 border-blue-300 rounded-lg"
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter') {
                                                        e.preventDefault();
                                                        addCustomProvider();
                                                    }
                                                }}
                                            />
                                            <button
                                                type="button"
                                                onClick={addCustomProvider}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                            >
                                                Add
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    setShowAddProvider(false);
                                                    setNewProviderName('');
                                                }}
                                                className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                        <p className="text-xs text-blue-700 mt-2">
                                            This provider will be saved and available for future entries
                                        </p>
                                    </div>
                                )}
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ‘¤ Mechanic/Technician Name (Optional)
                                </label>
                                <input
                                    type="text"
                                    value={formData.mechanicName}
                                    onChange={(e) => setFormData({ ...formData, mechanicName: e.target.value })}
                                    placeholder="e.g., Mike, Sarah Johnson, Jose, Bob the Mechanic"
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                    Name of the specific mechanic, technician, or manager who worked on your truck. 
                                    Helpful for finding the same person next time!
                                </p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ“ Location (City, Province/State, Country)
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={formData.location}
                                        onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                        placeholder="e.g., Whitehorse, YT, Canada or Phoenix, AZ, USA"
                                        className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => {
                                            if (navigator.geolocation) {
                                                navigator.geolocation.getCurrentPosition(
                                                    async (position) => {
                                                        try {
                                                            // Use reverse geocoding via public API
                                                            const response = await fetch(
                                                                `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
                                                            );
                                                            const data = await response.json();
                                                            const address = data.address;
                                                            
                                                            let locationString = '';
                                                            if (address.city || address.town || address.village) {
                                                                locationString = address.city || address.town || address.village;
                                                            }
                                                            if (address.state) {
                                                                locationString += locationString ? ', ' + address.state : address.state;
                                                            }
                                                            if (address.country) {
                                                                locationString += locationString ? ', ' + address.country : address.country;
                                                            }
                                                            
                                                            setFormData({...formData, location: locationString || `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`});
                                                        } catch (error) {
                                                            // Fallback to coordinates if geocoding fails
                                                            setFormData({...formData, location: `${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`});
                                                        }
                                                    },
                                                    (error) => {
                                                        alert('Unable to get location. Please enter manually.');
                                                    }
                                                );
                                            } else {
                                                alert('Geolocation not supported by your browser');
                                            }
                                        }}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition whitespace-nowrap flex items-center space-x-1"
                                        title="Get current location"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span>Use Current Location</span>
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-1">
                                    Where was this service performed? Helpful for tracking your journey and finding providers again.
                                </p>
                                <p className="text-xs text-blue-600 mt-1">
                                    ğŸ’¡ Tip: Include full details like "Whitehorse, YT, Canada" or click button to auto-detect
                                </p>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Work Performed *
                                </label>
                                <textarea
                                    required
                                    value={formData.workPerformed}
                                    onChange={(e) => setFormData({ ...formData, workPerformed: e.target.value })}
                                    placeholder="Describe what was done: oil change, brake inspection, tire rotation, etc."
                                    rows="3"
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    ğŸ’¬ Immediate Recommendations & Observations
                                </label>
                                <textarea
                                    value={formData.recommendations}
                                    onChange={(e) => setFormData({ ...formData, recommendations: e.target.value })}
                                    placeholder="What did the mechanic say about current condition? Any immediate concerns or observations?"
                                    rows="3"
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                                <p className="text-xs text-gray-500 mt-1">
                                    Example: "Brake pads at 40% - still good. Oil level perfect. Minor coolant weep - monitor."
                                </p>
                            </div>

                            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                                <label className="block text-sm font-medium text-yellow-900 mb-2">
                                    âš ï¸ Future Work Needed (At Base Camp or Next Service)
                                </label>
                                <textarea
                                    value={formData.futureWork}
                                    onChange={(e) => setFormData({ ...formData, futureWork: e.target.value })}
                                    placeholder="What needs attention later? When? At base camp? Next interval? Future maintenance?"
                                    rows="4"
                                    className="w-full px-4 py-2 border-2 border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500"
                                />
                                <p className="text-xs text-yellow-800 mt-1">
                                    <strong>CRITICAL PLANNING FIELD:</strong> Record what mechanic advised for future work
                                </p>
                                <div className="mt-2 bg-yellow-100 p-2 rounded text-xs text-yellow-900">
                                    <strong>Examples:</strong>
                                    <ul className="list-disc list-inside mt-1 space-y-1">
                                        <li>"Replace rear brake pads in 5,000-10,000 km"</li>
                                        <li>"Front struts showing wear - replace when back at base camp"</li>
                                        <li>"Serpentine belt has small crack - carry spare, replace at next service"</li>
                                        <li>"Transmission service due at 240,000 km (in ~10,000 km)"</li>
                                        <li>"Monitor oil consumption - may need valve cover gasket eventually"</li>
                                    </ul>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Cost (CAD)
                                </label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.cost}
                                    onChange={(e) => setFormData({ ...formData, cost: e.target.value })}
                                    placeholder="0.00"
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Additional Notes
                                </label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                    placeholder="Any other details..."
                                    rows="2"
                                    className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                />
                            </div>

                            <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                                <label className="block text-sm font-medium text-gray-700 mb-3">
                                    ğŸ“¸ Attach Photos (Receipts, Invoice, Mechanic Notes)
                                </label>
                                <input
                                    type="file"
                                    accept="image/*"
                                    multiple
                                    onChange={handlePhotoUpload}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm"
                                />
                                <p className="text-xs text-gray-500 mt-2">
                                    Upload photos of receipts, invoices, mechanic inspection sheets, or handwritten notes. 
                                    Multiple photos allowed. Mobile camera supported.
                                </p>
                                
                                {formData.photos.length > 0 && (
                                    <div className="mt-4 space-y-3">
                                        <div className="text-sm font-medium text-gray-700">
                                            Attached Photos ({formData.photos.length}):
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {formData.photos.map((photo, index) => (
                                                <div key={index} className="relative border-2 border-gray-200 rounded-lg overflow-hidden bg-white">
                                                    <img 
                                                        src={photo.data} 
                                                        alt={`Receipt ${index + 1}`}
                                                        className="w-full h-32 object-cover"
                                                    />
                                                    <div className="p-2 bg-white">
                                                        <div className="text-xs text-gray-600 truncate">{photo.name}</div>
                                                    </div>
                                                    <button
                                                        type="button"
                                                        onClick={() => removePhoto(index)}
                                                        className="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700"
                                                    >
                                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition"
                                >
                                    Add Service Record
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function CatalogView({ items, categories, selectedCategory, setSelectedCategory, subcategories, selectedSubcategory, setSelectedSubcategory, showSubcategoryFilter, subcategoryTitle, ownershipStatuses, selectedOwnership, setSelectedOwnership, priorityLevels, selectedPriority, setSelectedPriority, locations, selectedLocation, setSelectedLocation, owners, selectedOwner, setSelectedOwner, searchQuery, setSearchQuery, onAddItem, onDeleteItem }) {
            return (
                <>
                    {/* Controls */}
                    <div className="mb-6 space-y-4">
                        <div className="flex flex-col md:flex-row gap-4">
                            <div className="flex-1">
                                <input
                                    type="text"
                                    placeholder="Search your gear..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>
                            <button
                                onClick={onAddItem}
                                className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                <span>Add Item</span>
                            </button>
                        </div>

                        {/* Owner Filter */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-700 mb-2">Owner</h3>
                            <div className="flex flex-wrap gap-2">
                                {owners.map(owner => (
                                    <button
                                        key={owner}
                                        onClick={() => setSelectedOwner(owner)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                            selectedOwner === owner
                                                ? 'bg-indigo-600 text-white'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        {owner}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Ownership Status Filter */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-700 mb-2">Ownership Status</h3>
                            <div className="flex flex-wrap gap-2">
                                {ownershipStatuses.map(status => (
                                    <button
                                        key={status}
                                        onClick={() => setSelectedOwnership(status)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                            selectedOwnership === status
                                                ? 'bg-green-600 text-white'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        {status}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Priority Filter */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-700 mb-2">Priority</h3>
                            <div className="flex flex-wrap gap-2">
                                {priorityLevels.map(priority => (
                                    <button
                                        key={priority}
                                        onClick={() => setSelectedPriority(priority)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                            selectedPriority === priority
                                                ? 'bg-red-600 text-white'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        {priority}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Location Filter */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-700 mb-2">Location</h3>
                            <div className="flex flex-wrap gap-2">
                                {locations.map(location => (
                                    <button
                                        key={location}
                                        onClick={() => setSelectedLocation(location)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                            selectedLocation === location
                                                ? 'bg-teal-600 text-white'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        {location}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Category Filter */}
                        <div>
                            <h3 className="text-sm font-medium text-gray-700 mb-2">Category</h3>
                            <div className="flex flex-wrap gap-2">
                                {categories.map(cat => (
                                    <button
                                        key={cat}
                                        onClick={() => setSelectedCategory(cat)}
                                        className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                            selectedCategory === cat
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-white text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Subcategory Filter - Shows for Clothing and First Aid */}
                        {showSubcategoryFilter && subcategories.length > 0 && (
                            <div className={`p-4 rounded-lg border ${
                                selectedCategory === 'First Aid' 
                                    ? 'bg-red-50 border-red-200' 
                                    : 'bg-blue-50 border-blue-200'
                            }`}>
                                <h3 className="text-sm font-medium text-gray-700 mb-2">{subcategoryTitle}</h3>
                                <div className="flex flex-wrap gap-2">
                                    {subcategories.map(sub => (
                                        <button
                                            key={sub}
                                            onClick={() => setSelectedSubcategory(sub)}
                                            className={`px-4 py-2 rounded-full text-sm font-medium transition ${
                                                selectedSubcategory === sub
                                                    ? selectedCategory === 'First Aid'
                                                        ? 'bg-red-700 text-white'
                                                        : 'bg-blue-700 text-white'
                                                    : selectedCategory === 'First Aid'
                                                    ? 'bg-white text-gray-700 hover:bg-red-100'
                                                    : 'bg-white text-gray-700 hover:bg-blue-100'
                                            }`}
                                        >
                                            {sub}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Items Grid */}
                    {items.length === 0 ? (
                        <div className="text-center py-16 bg-white rounded-xl">
                            <svg className="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                            <h3 className="text-xl font-semibold text-gray-700 mb-2">No gear cataloged yet</h3>
                            <p className="text-gray-500 mb-4">Start building your overland inventory!</p>
                            <button
                                onClick={onAddItem}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Add Your First Item
                            </button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {items.map(item => (
                                <ItemCard key={item.id} item={item} onDelete={onDeleteItem} />
                            ))}
                        </div>
                    )}
                </>
            );
        }

        function ItemCard({ item, onDelete }) {
            const isOwned = item.ownership === 'Owned';
            const isMustHave = item.priority === 'Must Have';
            const currencySymbol = item.currency ? getCurrencySymbol(item.currency) : 'Â£';
            
            return (
                <div className="item-card bg-white rounded-xl overflow-hidden shadow-md">
                    <div className="aspect-square bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center relative">
                        {item.image ? (
                            <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
                        ) : (
                            <svg className="w-20 h-20 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                        )}
                        {/* Priority badge */}
                        {item.priority && (
                            <div className={`absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-semibold flex items-center space-x-1 ${
                                isMustHave 
                                    ? 'bg-red-500 text-white' 
                                    : 'bg-purple-500 text-white'
                            }`}>
                                {isMustHave ? (
                                    <>
                                        <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                        </svg>
                                        <span>Must</span>
                                    </>
                                ) : (
                                    <span>Nice</span>
                                )}
                            </div>
                        )}
                        {/* Product link indicator */}
                        {item.productUrl && (
                            <a
                                href={item.productUrl}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="absolute top-2 right-12 bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-600 transition"
                                title="View product page"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                        )}
                        {/* Receipt indicator */}
                        {item.receipt && isOwned && (
                            <div className="absolute bottom-2 right-2 bg-blue-500 text-white p-2 rounded-full" title="Receipt uploaded">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                        )}
                        {/* Ownership badge */}
                        <div className={`absolute bottom-2 left-2 px-2 py-1 rounded-full text-xs font-semibold ${
                            isOwned 
                                ? 'bg-green-500 text-white' 
                                : 'bg-orange-500 text-white'
                        }`}>
                            {isOwned ? 'âœ“ Owned' : 'To Buy'}
                        </div>
                        <button
                            onClick={() => onDelete(item.id)}
                            className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition"
                        >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div className="p-4">
                        <div className="flex items-start justify-between mb-2">
                            <div className="flex-1">
                                <h3 className="font-semibold text-gray-900">{item.name}</h3>
                                {item.manufacturer && (
                                    <p className="text-xs text-gray-500 mt-1">by {item.manufacturer}</p>
                                )}
                            </div>
                        </div>
                        <span className="inline-block px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full mb-2">
                            {item.category}
                        </span>
                        {item.subcategory && (
                            <span className="inline-block px-2 py-1 bg-cyan-100 text-cyan-700 text-xs rounded-full mb-2 ml-2">
                                {item.subcategory}
                            </span>
                        )}
                        {item.owner && (
                            <span className="inline-block px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded-full mb-2 ml-2">
                                ğŸ‘¤ {item.owner}
                            </span>
                        )}
                        {item.description && (
                            <p className="text-sm text-gray-600 line-clamp-2">{item.description}</p>
                        )}
                        <div className="mt-2 space-y-1">
                            {item.location && (
                                <p className="text-xs text-teal-700 font-medium">
                                    ğŸ“ {item.location}
                                </p>
                            )}
                            {item.mobility && (
                                <p className="text-xs text-gray-600">
                                    {item.mobility === 'Fixed/Permanent' && 'ğŸ”’ Fixed/Permanent'}
                                    {item.mobility === 'Movable' && 'ğŸ”„ Movable'}
                                    {item.mobility === 'Removable (Storage)' && 'ğŸ“¦ Removable (Storage)'}
                                </p>
                            )}
                            {item.hasWarranty === 'Yes' && item.warrantyExpiry && (
                                <p className={`text-xs font-medium ${
                                    new Date(item.warrantyExpiry) < new Date() 
                                        ? 'text-red-600' 
                                        : new Date(item.warrantyExpiry) < new Date(Date.now() + 30*24*60*60*1000)
                                        ? 'text-orange-600'
                                        : 'text-blue-600'
                                }`}>
                                    {new Date(item.warrantyExpiry) < new Date() 
                                        ? 'âš ï¸ Warranty Expired' 
                                        : `âœ“ Warranty until ${item.warrantyExpiry}`
                                    }
                                </p>
                            )}
                            {item.hasWarranty === 'Yes' && !item.warrantyExpiry && (
                                <p className="text-xs text-blue-600 font-medium">âœ“ Under Warranty</p>
                            )}
                            {item.medicationExpiry && (
                                <p className={`text-xs font-semibold ${
                                    new Date(item.medicationExpiry) < new Date() 
                                        ? 'text-red-700' 
                                        : new Date(item.medicationExpiry) < new Date(Date.now() + 90*24*60*60*1000)
                                        ? 'text-orange-700'
                                        : 'text-green-700'
                                }`}>
                                    {new Date(item.medicationExpiry) < new Date() 
                                        ? 'ğŸš¨ Medication EXPIRED' 
                                        : new Date(item.medicationExpiry) < new Date(Date.now() + 90*24*60*60*1000)
                                        ? `âš ï¸ Expires ${item.medicationExpiry}`
                                        : `ğŸ’Š Expires ${item.medicationExpiry}`
                                    }
                                </p>
                            )}
                            {item.medicationFor && item.medicationFor !== 'General/Shared' && (
                                <p className="text-xs text-purple-700 font-medium">
                                    ğŸ’Š For: {item.medicationFor}
                                </p>
                            )}
                            {item.prescribingDoctor && (
                                <p className="text-xs text-indigo-600 font-medium">
                                    ğŸ‘¨â€âš•ï¸ Dr: {item.prescribingDoctor}
                                </p>
                            )}
                            {item.weight && (
                                <p className="text-xs text-gray-500">
                                    Weight: {item.weight} {item.weightUnit || 'kg'}
                                </p>
                            )}
                            {isOwned && item.actualCost && (
                                <p className="text-xs text-green-700 font-semibold">
                                    Cost: {currencySymbol}{item.actualCost}
                                </p>
                            )}
                            {!isOwned && item.estimatedCost && (
                                <p className="text-xs text-orange-600 font-medium">
                                    Est. Cost: {currencySymbol}{item.estimatedCost}
                                </p>
                            )}
                            {isOwned && item.purchaseDate && (
                                <p className="text-xs text-gray-500">Purchased: {item.purchaseDate}</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function FluidsAndSparesView({ items, vehicleBaseWeight }) {
            const [selectedTab, setSelectedTab] = useState('fluids');
            const [showAIAnalysis, setShowAIAnalysis] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [currentMileage, setCurrentMileage] = useState(230000); // Default from earlier conversation
            const [showMileageInput, setShowMileageInput] = useState(false);

            // Filter fluids and spare parts from catalog
            const fluidsItems = items.filter(i => 
                i.category === 'Tools & Equipment' && i.subcategory === 'Lubricants/Fluids'
            );
            
            const sparePartsItems = items.filter(i => 
                i.category === 'Tools & Equipment' && (
                    i.subcategory === 'Spare Parts - Engine' ||
                    i.subcategory === 'Spare Parts - Drivetrain' ||
                    i.subcategory === 'Spare Parts - Suspension' ||
                    i.subcategory === 'Spare Parts - Electrical' ||
                    i.subcategory === 'Spare Parts - Body/Habitat'
                )
            );

            // Essential fluids for 2003 Sierra 1500 Z71
            const essentialFluids = {
                'Engine Oil (5W-30)': { capacity: '6 quarts', critical: true, interval: '5,000 km' },
                'Coolant (Dex-Cool)': { capacity: '15.2 L', critical: true, interval: 'Check monthly' },
                'Brake Fluid (DOT 3)': { capacity: '1 quart', critical: true, interval: 'Check monthly' },
                'Power Steering Fluid': { capacity: '1 quart', critical: true, interval: 'Check monthly' },
                'Transmission Fluid (Dexron VI)': { capacity: '12 quarts', critical: false, interval: '80,000 km' },
                'Transfer Case Fluid (Dexron III)': { capacity: '2 quarts', critical: false, interval: '80,000 km' },
                'Front Differential (75W-90)': { capacity: '2.2 quarts', critical: false, interval: '80,000 km' },
                'Rear Differential G80 (75W-90)': { capacity: '2.6 quarts', critical: true, interval: '50,000 km', note: 'NO limited-slip additives!' },
                'Windshield Washer Fluid': { capacity: '4 L', critical: false, interval: 'As needed' }
            };

            // Essential spare parts by priority
            const essentialSpares = {
                critical: [
                    'Serpentine Belt',
                    'Upper Radiator Hose',
                    'Lower Radiator Hose',
                    'Thermostat',
                    'Fuel Filter',
                    'Air Filter'
                ],
                important: [
                    'Oil Filter (x2)',
                    'Spark Plugs (set of 8)',
                    'Fuel Line (3 feet)',
                    'Fuses (assorted)',
                    'Headlight Bulbs',
                    'Brake Light Bulbs'
                ],
                recommended: [
                    'Outer Tie Rod End',
                    'Sway Bar Links',
                    'CV Axle Boot',
                    'U-Joint (driveshaft)',
                    'Water Pump',
                    'Alternator Belt'
                ]
            };

            const analyzeFluidAndSparesNeeds = async () => {
                setIsAnalyzing(true);
                setShowAIAnalysis(true);

                try {
                    const fluidInventory = fluidsItems.map(item => 
                        `- ${item.name}${item.description ? ` (${item.description})` : ''}${item.weight ? ` - ${item.weight} ${item.weightUnit}` : ''}`
                    ).join('\n');

                    const sparesInventory = sparePartsItems.map(item =>
                        `- ${item.name} (${item.subcategory})${item.compatibleWith ? ` - Compatible: ${item.compatibleWith}` : ''}${item.toolCondition ? ` - Condition: ${item.toolCondition}` : ''}`
                    ).join('\n');

                    const prompt = `You are an expert automotive technician specializing in overland vehicle preparation and remote repairs for North American expeditions. I need comprehensive advice on fluids and spare parts for my expedition vehicle based in Canada.

MY VEHICLE:
- 2003 GMC Sierra 1500 Z71 Extended Cab 4x4 (Canadian truck)
- Engine: 5.3L Vortec V8
- Transmission: 4L60E automatic
- Transfer Case: NP246 Autotrac or NP263
- Rear Differential: G80 automatic locking (10-bolt)
- Front Differential: Standard open
- Current Mileage: ${currentMileage.toLocaleString()} km (${Math.round(currentMileage * 0.621371).toLocaleString()} miles)
- Modifications: Radflo 2.5 reservoir shocks, Eazi-Awn roof rack on Yakima rails
- Based in: Canada

EXPEDITION DETAILS:
- Duration: 2-3 years Pan-American + worldwide
- Primary routes:
  * Alaska Highway & Northern Canada
  * Continental North America (Canada/USA)
  * Pan-American Highway (Alaska to Argentina)
  * Then shipping to other continents
- Terrain: Mixed (highway, dirt roads, trails, sand, mud, mountain passes, Arctic tundra)
- Remote areas: Canadian North, rural Alaska, Central/South American backcountry, then overseas
- Climate zones: All (Arctic -40Â°C to desert +50Â°C to tropical)

CURRENT FLUIDS IN CATALOG:
${fluidInventory || 'No fluids currently cataloged'}

CURRENT SPARE PARTS IN CATALOG:
${sparesInventory || 'No spare parts currently cataloged'}

ESSENTIAL FLUIDS FOR 2003 SIERRA 1500 (reference):
${Object.entries(essentialFluids).map(([fluid, info]) => 
    `- ${fluid}: ${info.capacity}, ${info.critical ? 'CRITICAL' : 'Important'}, Change: ${info.interval}${info.note ? ` - ${info.note}` : ''}`
).join('\n')}

Please provide a comprehensive analysis:

1. **FLUIDS ANALYSIS** (Weight-Conscious Trail Approach):
   a) **Critical Gaps**: Which essential fluids am I MISSING that could cause breakdowns?
   b) **Quantity Assessment - Practical Trail Quantities** (minimize weight while maintaining safety):
      
      **TOP-UP ONLY (minimize weight):**
      - Engine Oil: 2 quarts (for top-up between changes, not full capacity)
      - Coolant: 1-2 liters (for minor top-up, not full system)
      - Differential fluids: 1 quart each (for top-up/minor leak, not full change)
      - Power Steering: 1 quart (top-up only)
      
      **FULL SYSTEM CAPACITY (emergency trail repair to reach pavement/town):**
      - Brake Fluid: FULL capacity (1 quart) - if brake line fails on trail, need full refill to safely reach town/pavement for proper repair or CAA tow
      - Coolant: Consider 1 gallon for major leak repairs (hose replacement scenario - need enough to get to town)
      
      **RATIONALE:** 
      - Oil/coolant consumption is gradual - small quantities for top-up adequate, major leak = get towed
      - Brake/steering system failure on remote trail requires FULL capacity to make emergency repair and safely reach pavement for CAA pickup or mechanic
      - Weight matters - fluids are heavy, prioritize safety over self-sufficiency
      
   c) **Specific Requirements**:
      - G80 rear differential: Which 75W-90 oils are safe? (NO limited-slip additives!)
      - Dex-Cool coolant: Compatible brands available in North America
      - Climate considerations: Arctic (-40Â°C) to desert (+50Â°C) viscosities needed?
   d) **Shelf Life**: How long do fluids last in storage? When to replace?

2. **SPARE PARTS ANALYSIS**:
   a) **Critical Missing Parts**: What could strand me that I don't have?
   b) **Mileage-Based Failures**: At ${currentMileage.toLocaleString()} km, what's likely to fail soon?
   c) **Terrain-Specific**: Parts prone to damage on rough roads/trails/Arctic conditions
   d) **GM 5.3L Vortec Known Issues**: Common failure points at this mileage
   e) **G80 Locker Specific**: Any special spares for the locking differential?

3. **PRIORITIZED SHOPPING LIST** (Canadian/North American Focus):
   For each item provide:
   - Part name and specification
   - Why needed (failure mode/scenario)
   - Priority (Critical/Important/Recommended)
   - Quantity to carry
   - Approximate Canadian price (CAD)
   - Where to buy in Canada: Canadian Tire, NAPA Auto Parts, Lordco (BC), Princess Auto, Home Depot, etc.
   - Where to buy in USA: AutoZone, O'Reilly Auto Parts, NAPA USA, Advance Auto Parts
   - Availability in Mexico: What's available vs what to stock up on before crossing
   - Part numbers if known (GM/AC Delco)
   - Storage requirements (temperature sensitive? Arctic/tropical considerations)

4. **MAINTENANCE SCHEDULE**:
   Based on current ${currentMileage.toLocaleString()} km:
   - What services are DUE NOW before departure from Canada?
   - What will be due during the 2-3 year trip?
   - Interval recommendations for expedition use (more frequent than normal?)
   - Arctic-specific maintenance (block heater, battery, fluids)

5. **EMERGENCY REPAIR SCENARIOS** (Trail Repair Philosophy - Get to Safety):
   
   **PHILOSOPHY:** Trail repairs are temporary to safely reach pavement, town, or CAA service. Not about complete self-sufficiency in the backcountry.
   
   **Goal:** Make it drivable enough to:
   1. Get back to paved road safely
   2. Drive to nearest town with mechanic
   3. Reach cellular coverage to call CAA (Canadian Automobile Association)
   4. Get to safe location for proper tow truck pickup
   
   **Scenarios with required fluids/parts:**
   
   a) **Coolant Leak (e.g., radiator hose fails):**
      - Parts needed: Upper/lower radiator hose, hose clamps, Rescue Tape
      - Fluid needed: Enough coolant to refill system and reach town (3-4 liters)
      - Goal: Replace hose, refill, drive 50-200 km to mechanic or pavement for CAA
      - Don't carry: Full 15L capacity - too heavy, major leak = get towed anyway
   
   b) **Brake Line Failure (hits rock on trail):**
      - Parts needed: Brake line sections, fittings, flaring tool or compression fittings
      - Fluid needed: FULL brake fluid capacity (1 quart) - CRITICAL SAFETY
      - Goal: Repair line, bleed brakes, refill system completely, drive slowly to pavement/town
      - Why full capacity: Brakes are life-safety, must work properly to exit trail safely
      - CAA won't come up rough trail - need to reach pavement
   
   c) **Power Steering Line Leak:**
      - Parts needed: Hose, clamps
      - Fluid needed: FULL power steering capacity (1 quart)
      - Goal: Repair leak, refill, drive to town (can drive without PS but difficult)
      - Why full capacity: Need functional steering to safely navigate exit from trail
   
   d) **Oil Leak (minor):**
      - Parts needed: Gasket maker, oil filter if damaged
      - Fluid needed: 2 quarts (top-up, not full capacity)
      - Goal: Slow leak = top up, limp to town. Major leak = call tow truck
      - Don't carry: Full 6 quart capacity - too heavy for minor leaks
   
   e) **Differential Seal Leak:**
      - Parts needed: RTV silicone
      - Fluid needed: 1-2 quarts (enough for top-up and minor loss during repair)
      - Goal: Temporary seal, top-up fluid, drive to mechanic
      - Don't carry: Full diff capacity - proper seal replacement needs shop
   
   f) **Belt Failure:**
      - Parts needed: Serpentine belt (carry 2)
      - Fluid needed: None
      - Goal: Replace belt roadside, continue journey
   
   g) **Arctic Cold Start Issues:**
      - Parts needed: Battery booster pack, block heater extension
      - Fluids needed: Proper viscosity oil already in system
      - Goal: Get started, keep running, find heated shelter
   
   **KEY PRINCIPLE:** 
   - Carry full capacity ONLY for safety-critical systems (brakes, steering)
   - Carry top-up quantities for consumables (oil, coolant)
   - Weight vs. risk: Fluids are heavy, prioritize life-safety over total self-sufficiency
   - Canadian context: CAA coverage available, towns accessible, proper repair shops exist
   - Realistic goal: Get to safety, not fix everything perfectly in the bush

6. **CLIMATE ADAPTATIONS** (North American Specific):
   - Canadian Arctic & Alaska (below -40Â°C): Oil viscosity? Block heater? Battery? Coolant strength?
   - Canadian Prairies (extreme swings -35Â°C to +35Â°C): Fluid recommendations?
   - US Southwest Desert (above +50Â°C): Cooling system requirements?
   - Mexico/Central America Tropical/Humid: Rust prevention? Fluids breakdown?

7. **STORAGE & ORGANIZATION** (Weight-Conscious Reality):
   
   **WEIGHT REALITY CHECK:**
   - Fluids are HEAVY: 1 liter = 1 kg approximately
   - Full 2x capacity approach = 30+ kg of fluids alone
   - Expedition already heavy with gear, habitat, recovery equipment
   - Every kg matters for vehicle payload, fuel consumption, suspension wear
   
   **PRACTICAL FLUID LOAD:**
   Recommend carrying approximately:
   - Engine oil: 2 quarts (2 kg)
   - Coolant: 3-4 liters (4 kg)
   - Brake fluid: 1 quart (1 kg) - FULL CAPACITY
   - Power steering: 1 quart (1 kg) - FULL CAPACITY
   - Differential fluids: 2 quarts total (2 kg)
   - Transmission fluid: 2 quarts (2 kg)
   - Total: ~12-15 kg instead of 40+ kg
   
   **STORAGE CONSIDERATIONS:**
   - Leak-proof containers in extreme temps (-40Â°C to +50Â°C)
   - Separate from food/sleeping gear
   - Accessible but secure (not shifting during off-road)
   - Fire safety (flammable fluids away from electrical)
   - Arctic: Most fluids won't freeze, but store where you can access
   - Desert: Keep out of direct sun to prevent container degradation
   
   **WHY THIS MAKES SENSE:**
   - Small leaks: Top-up gets you to town
   - Major leaks: Call CAA/tow truck (carrying 15L won't help if hose is shredded)
   - Safety-critical (brakes/steering): Carry full capacity to reach pavement safely
   - Weight saved: 25-30 kg for other critical gear or fuel range

8. **INTERNATIONAL AVAILABILITY** (Pan-American Focus + CAA Support):
   
   **Canada (Home Base):**
   - Full availability: Canadian Tire, NAPA, Lordco, Princess Auto
   - Stock up on vehicle-specific items (GM parts readily available)
   - CAA (Canadian Automobile Association) coverage: Excellent roadside assistance, towing
   - Towns/services every 100-200 km on major highways
   - Remote North: Sparse but CAA covers most areas
   
   **USA (Cross-Border):**
   - Excellent compatibility: Same GM parts, similar brands
   - AutoZone, O'Reilly, NAPA USA widely available
   - AAA (American Automobile Association) reciprocal with CAA
   - Top-up fluids readily available, no need to carry excess from Canada
   
   **Mexico:**
   - Major cities: Good parts availability for GM vehicles (popular brand)
   - Rural areas: Limited
   - Stock up on specialty items before crossing US border
   - Mexican insurance required (different from CAA)
   - Green Angels (government roadside assistance) on major highways
   
   **Central America:**
   - Very limited parts availability
   - Stock up in Mexico before heading south
   - Basic fluids available in capitals, rare elsewhere
   - Limited roadside assistance infrastructure
   
   **South America:**
   - Major cities: Some availability
   - Rural/mountain areas: Very limited
   - Plan ahead, stock up in capitals
   - Limited equivalent to CAA/AAA

9. **BUDGET ESTIMATE** (Canadian Dollars):
   - Total cost for PRACTICAL fluid inventory (12-15 kg approach): CAD $150-250
   - Total cost for essential spare parts: CAD $300-500
   - Overall budget for fluids + spares: CAD $450-750
   - Cost comparison: Buy in Canada vs USA (similar) vs Mexico (variable quality)
   - Weight saved vs 2x capacity approach: 25-30 kg = Can carry more fuel or critical spares

10. **RISK ASSESSMENT** (Canadian Context):
    
    **With Proper Fluids/Spares (Practical Approach):**
    - âœ… Can handle minor leaks and top-up to town
    - âœ… Can make emergency brake/steering repair to reach pavement for CAA
    - âœ… Can replace belts, hoses, filters roadside
    - âœ… Can drive safely to nearest service in Canada/USA
    - âš ï¸ Major failures still require tow (realistic expectation)
    
    **Without Proper Fluids/Spares:**
    - âŒ Brake line failure on remote trail = stranded, dangerous
    - âŒ Belt failure = stranded immediately
    - âŒ Coolant leak with no fluid = engine damage
    - âŒ In remote Canadian North: Could be days before help arrives
    
    **Most Critical Items (Priority Order):**
    1. Brake fluid (FULL capacity) - life-safety to reach pavement
    2. Serpentine belt (x2) - instant breakdown without
    3. Radiator hoses + coolant (get to town capability)
    4. Power steering fluid (FULL capacity) - safety to exit trail
    5. Engine oil (top-up quantity)
    
    **Acceptable Risk Level:**
    - Carry enough to make safe emergency repairs and reach civilization
    - Don't carry enough to be completely self-sufficient in wilderness
    - Rely on CAA/AAA for major issues (they exist for this reason!)
    - Weight saved = better fuel economy, more food/water, longer range
    
    **Canadian Reality:**
    - CAA coverage is excellent across Canada/USA
    - Towns/services exist (not true wilderness like Antarctica)
    - Goal: Get to pavement safely, then call CAA or drive to mechanic
    - Emergency repairs are temporary, not permanent fixes

Focus on PRACTICAL, WEIGHT-CONSCIOUS advice for long-distance Pan-American overlanding starting from Canada. Don't over-pack fluids - prioritize life-safety systems (brakes, steering) with full capacity, top-up quantities for everything else. Overlanding isn't about total self-sufficiency - it's about calculated risk management with backup (CAA, shops, towns). Weight saved = better expedition capability.`;

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        setAiAnalysis(data.content[0].text);
                    } else {
                        throw new Error('Unexpected response format');
                    }
                } catch (error) {
                    console.error('AI Analysis error:', error);
                    setAiAnalysis(`Error analyzing fluids and spares: ${error.message}\n\nPlease check your internet connection and try again.`);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const downloadFluidsReport = () => {
                const reportData = fluidsItems.map(item => ({
                    'Fluid Type': item.name,
                    'Description': item.description || '',
                    'Quantity': item.weight ? `${item.weight} ${item.weightUnit}` : 'N/A',
                    'Location': item.location || '',
                    'Manufacturer': item.manufacturer || '',
                    'Cost': item.actualCost ? `${item.currency} ${item.actualCost}` : ''
                }));

                const csv = [
                    Object.keys(reportData[0] || {}).join(','),
                    ...reportData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fluids-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const downloadSparesReport = () => {
                const reportData = sparePartsItems.map(item => ({
                    'Part Name': item.name,
                    'Category': item.subcategory || '',
                    'Compatible With': item.compatibleWith || '',
                    'Condition': item.toolCondition || '',
                    'Location': item.location || '',
                    'Manufacturer': item.manufacturer || '',
                    'Cost': item.actualCost ? `${item.currency} ${item.actualCost}` : ''
                }));

                const csv = [
                    Object.keys(reportData[0] || {}).join(','),
                    ...reportData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `spare-parts-inventory-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <>
                    <div className="mb-6">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 flex items-center space-x-2">
                                    <span>ğŸ›¢ï¸</span>
                                    <span>Fluids & Spare Parts Manager</span>
                                </h2>
                                <p className="text-gray-600 mt-1">Essential fluids and spare parts for roadside emergencies and maintenance</p>
                            </div>
                            <button
                                onClick={analyzeFluidAndSparesNeeds}
                                disabled={isAnalyzing}
                                className="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center space-x-2 disabled:opacity-50"
                            >
                                {isAnalyzing ? (
                                    <>
                                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Analyzing...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        <span>ğŸ¤– AI Analysis</span>
                                    </>
                                )}
                            </button>
                        </div>

                        {/* Vehicle Info Banner */}
                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
                            <div className="flex justify-between items-center">
                                <div>
                                    <p className="text-blue-900 font-medium">
                                        <strong>2003 GMC Sierra 1500 Z71</strong> â€¢ 5.3L Vortec V8 â€¢ 4L60E Auto â€¢ G80 Rear Locker
                                    </p>
                                    <p className="text-sm text-blue-700 mt-1">
                                        Current Mileage: <strong>{currentMileage.toLocaleString()} km</strong> ({Math.round(currentMileage * 0.621371).toLocaleString()} miles)
                                    </p>
                                </div>
                                <button
                                    onClick={() => setShowMileageInput(!showMileageInput)}
                                    className="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
                                >
                                    Update Mileage
                                </button>
                            </div>
                            {showMileageInput && (
                                <div className="mt-3 flex items-center space-x-3">
                                    <input
                                        type="number"
                                        value={currentMileage}
                                        onChange={(e) => setCurrentMileage(parseInt(e.target.value) || 0)}
                                        className="px-3 py-2 border rounded"
                                        placeholder="Current km"
                                    />
                                    <span className="text-sm text-blue-700">km</span>
                                    <button
                                        onClick={() => setShowMileageInput(false)}
                                        className="px-4 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700"
                                    >
                                        Save
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* AI Analysis Panel */}
                    {showAIAnalysis && (
                        <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg border-2 border-purple-300 overflow-hidden">
                            <div className="bg-purple-600 px-6 py-4 flex justify-between items-center">
                                <h3 className="font-bold text-white flex items-center space-x-2">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                    <span>AI Fluids & Spares Analysis</span>
                                </h3>
                                <button
                                    onClick={() => setShowAIAnalysis(false)}
                                    className="text-white hover:text-purple-200 transition"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="p-6 max-h-96 overflow-y-auto">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center py-12">
                                        <svg className="animate-spin h-12 w-12 text-purple-600 mb-4" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p className="text-gray-600 font-medium">Analyzing fluids and spare parts requirements...</p>
                                        <p className="text-sm text-gray-500 mt-2">Checking for critical gaps and mileage-based recommendations</p>
                                    </div>
                                ) : aiAnalysis ? (
                                    <div className="prose prose-sm max-w-none">
                                        <div className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                                            {aiAnalysis}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12 text-gray-500">
                                        <p>Click "AI Analysis" to get comprehensive fluids and spares recommendations</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <div className="text-3xl font-bold text-blue-600">{fluidsItems.length}</div>
                            <div className="text-gray-600 mt-1">Fluids in Catalog</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <div className="text-3xl font-bold text-green-600">{sparePartsItems.length}</div>
                            <div className="text-gray-600 mt-1">Spare Parts Stocked</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                            <div className="text-3xl font-bold text-yellow-600">{Object.keys(essentialFluids).length}</div>
                            <div className="text-gray-600 mt-1">Essential Fluid Types</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-500">
                            <div className="text-3xl font-bold text-red-600">
                                {essentialSpares.critical.length + essentialSpares.important.length}
                            </div>
                            <div className="text-gray-600 mt-1">Recommended Spares</div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex space-x-2 mb-6 border-b">
                        <button
                            onClick={() => setSelectedTab('fluids')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'fluids'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Essential Fluids
                        </button>
                        <button
                            onClick={() => setSelectedTab('inventory-fluids')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'inventory-fluids'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            My Fluid Inventory
                        </button>
                        <button
                            onClick={() => setSelectedTab('spares')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'spares'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Essential Spares
                        </button>
                        <button
                            onClick={() => setSelectedTab('inventory-spares')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'inventory-spares'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            My Spares Inventory
                        </button>
                    </div>

                    {/* Tab Content */}
                    {selectedTab === 'fluids' && (
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-gray-900 text-xl">Essential Fluids for 2003 Sierra 1500 Z71</h3>
                            </div>
                            <div className="space-y-3">
                                {Object.entries(essentialFluids).map(([fluid, info]) => (
                                    <div 
                                        key={fluid} 
                                        className={`border-2 rounded-lg p-4 ${info.critical ? 'border-red-300 bg-red-50' : 'border-gray-200'}`}
                                    >
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <div className="font-bold text-gray-900 flex items-center space-x-2">
                                                    <span>{fluid}</span>
                                                    {info.critical && <span className="text-red-600 text-sm">âš ï¸ CRITICAL</span>}
                                                </div>
                                                <div className="text-sm text-gray-600 mt-1">
                                                    Capacity: <strong>{info.capacity}</strong> â€¢ Change Interval: <strong>{info.interval}</strong>
                                                </div>
                                                {info.note && (
                                                    <div className="text-sm text-red-600 mt-1 font-medium">
                                                        âš ï¸ {info.note}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="text-sm">
                                                {fluidsItems.some(item => item.name.toLowerCase().includes(fluid.toLowerCase().split(' ')[0])) ? (
                                                    <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full font-medium">âœ“ In Catalog</span>
                                                ) : (
                                                    <span className="px-3 py-1 bg-red-100 text-red-800 rounded-full font-medium">âœ— Missing</span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {selectedTab === 'inventory-fluids' && (
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-gray-900 text-xl">My Fluid Inventory ({fluidsItems.length})</h3>
                                <button
                                    onClick={downloadFluidsReport}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span>Download CSV</span>
                                </button>
                            </div>
                            {fluidsItems.length > 0 ? (
                                <div className="grid md:grid-cols-2 gap-4">
                                    {fluidsItems.map(item => (
                                        <div key={item.id} className="border-2 rounded-lg p-4">
                                            <div className="font-bold text-gray-900">{item.name}</div>
                                            {item.description && (
                                                <div className="text-sm text-gray-600 mt-1">{item.description}</div>
                                            )}
                                            {item.weight && (
                                                <div className="text-sm text-gray-700 mt-2">
                                                    Quantity: <strong>{item.weight} {item.weightUnit}</strong>
                                                </div>
                                            )}
                                            {item.location && (
                                                <div className="text-xs text-gray-500 mt-1">ğŸ“ {item.location}</div>
                                            )}
                                            {item.manufacturer && (
                                                <div className="text-xs text-gray-500">Brand: {item.manufacturer}</div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-12 text-gray-500">
                                    <p>No fluids in catalog yet. Add fluids to track your inventory.</p>
                                </div>
                            )}
                        </div>
                    )}

                    {selectedTab === 'spares' && (
                        <div className="space-y-6">
                            {/* Critical Spares */}
                            <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-red-300">
                                <div className="bg-red-100 px-6 py-4 border-b border-red-200">
                                    <h3 className="font-bold text-red-900">âš ï¸ Critical Spares (Trip Stoppers)</h3>
                                    <p className="text-sm text-red-700 mt-1">Without these, you could be stranded</p>
                                </div>
                                <div className="p-6">
                                    <div className="space-y-2">
                                        {essentialSpares.critical.map(part => (
                                            <div key={part} className="flex justify-between items-center py-2 border-b border-gray-200">
                                                <span className="text-gray-800 font-medium">{part}</span>
                                                {sparePartsItems.some(item => item.name.toLowerCase().includes(part.toLowerCase())) ? (
                                                    <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">âœ“ In Stock</span>
                                                ) : (
                                                    <span className="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">âœ— Missing</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Important Spares */}
                            <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-yellow-300">
                                <div className="bg-yellow-100 px-6 py-4 border-b border-yellow-200">
                                    <h3 className="font-bold text-yellow-900">Important Spares</h3>
                                    <p className="text-sm text-yellow-700 mt-1">Highly recommended for expedition use</p>
                                </div>
                                <div className="p-6">
                                    <div className="grid md:grid-cols-2 gap-2">
                                        {essentialSpares.important.map(part => (
                                            <div key={part} className="flex justify-between items-center py-2 border-b border-gray-200">
                                                <span className="text-gray-800">{part}</span>
                                                {sparePartsItems.some(item => item.name.toLowerCase().includes(part.toLowerCase())) ? (
                                                    <span className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">âœ“</span>
                                                ) : (
                                                    <span className="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">âœ—</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Recommended Spares */}
                            <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                <div className="bg-gray-100 px-6 py-4 border-b border-gray-200">
                                    <h3 className="font-bold text-gray-900">Recommended Spares</h3>
                                    <p className="text-sm text-gray-600 mt-1">Nice to have for complete peace of mind</p>
                                </div>
                                <div className="p-6">
                                    <div className="grid md:grid-cols-2 gap-2">
                                        {essentialSpares.recommended.map(part => (
                                            <div key={part} className="flex justify-between items-center py-2 border-b border-gray-200">
                                                <span className="text-gray-800">{part}</span>
                                                {sparePartsItems.some(item => item.name.toLowerCase().includes(part.toLowerCase())) ? (
                                                    <span className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">âœ“</span>
                                                ) : (
                                                    <span className="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">âˆ’</span>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {selectedTab === 'inventory-spares' && (
                        <div className="bg-white rounded-xl shadow-md p-6">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-gray-900 text-xl">My Spare Parts Inventory ({sparePartsItems.length})</h3>
                                <button
                                    onClick={downloadSparesReport}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span>Download CSV</span>
                                </button>
                            </div>
                            {sparePartsItems.length > 0 ? (
                                <div className="space-y-6">
                                    {['Spare Parts - Engine', 'Spare Parts - Drivetrain', 'Spare Parts - Suspension', 'Spare Parts - Electrical', 'Spare Parts - Body/Habitat'].map(category => {
                                        const categoryItems = sparePartsItems.filter(i => i.subcategory === category);
                                        if (categoryItems.length === 0) return null;
                                        
                                        return (
                                            <div key={category}>
                                                <h4 className="font-bold text-gray-800 mb-3">{category.replace('Spare Parts - ', '')} ({categoryItems.length})</h4>
                                                <div className="grid md:grid-cols-2 gap-3">
                                                    {categoryItems.map(item => (
                                                        <div key={item.id} className="border-2 rounded-lg p-3">
                                                            <div className="font-semibold text-gray-900">{item.name}</div>
                                                            {item.compatibleWith && (
                                                                <div className="text-xs text-blue-600 mt-1">
                                                                    Compatible: {item.compatibleWith}
                                                                </div>
                                                            )}
                                                            {item.toolCondition && (
                                                                <div className={`text-xs mt-1 ${
                                                                    item.toolCondition === 'New' || item.toolCondition === 'Good' ? 'text-green-600'
                                                                    : item.toolCondition === 'Fair' ? 'text-yellow-600'
                                                                    : 'text-red-600'
                                                                }`}>
                                                                    Condition: {item.toolCondition}
                                                                </div>
                                                            )}
                                                            {item.location && (
                                                                <div className="text-xs text-gray-500 mt-1">ğŸ“ {item.location}</div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div className="text-center py-12 text-gray-500">
                                    <p>No spare parts in catalog yet. Add spare parts to track your inventory.</p>
                                </div>
                            )}
                        </div>
                    )}
                </>
            );
        }

        function TrailRecoveryAssistant({ items, vehicleBaseWeight }) {
            const [vehicleMake, setVehicleMake] = useState('');
            const [vehicleModel, setVehicleModel] = useState('');
            const [vehicleYear, setVehicleYear] = useState('');
            const [estimatedLoad, setEstimatedLoad] = useState('moderate');
            const [stuckCondition, setStuckCondition] = useState('');
            
            // Modification tracking
            const [hasModifications, setHasModifications] = useState(false);
            const [hasFrontBumper, setHasFrontBumper] = useState(false);
            const [hasWinch, setHasWinch] = useState(false);
            const [hasRearBumper, setHasRearBumper] = useState(false);
            const [hasTyreCarrier, setHasTyreCarrier] = useState(false);
            const [hasSliders, setHasSliders] = useState(false);
            const [hasRoofRack, setHasRoofRack] = useState(false);
            const [hasLongRangeTanks, setHasLongRangeTanks] = useState(false);
            const [otherModifications, setOtherModifications] = useState('');
            
            // Gear comparison
            const [carriesOverlandGear, setCarriesOverlandGear] = useState(false);
            const [gearComparison, setGearComparison] = useState('same'); // less, same, more
            
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysis, setAnalysis] = useState(null);
            const [savedAssessments, setSavedAssessments] = useState([]);

            // Calculate user's expedition weight
            const calculateGearWeight = () => {
                return items.reduce((total, item) => {
                    if (!item.weight || !item.weightUnit) return total;
                    const weight = parseFloat(item.weight);
                    let weightInKg = weight;
                    if (item.weightUnit === 'lb') weightInKg = weight * 0.453592;
                    else if (item.weightUnit === 'oz') weightInKg = weight * 0.0283495;
                    else if (item.weightUnit === 'g') weightInKg = weight * 0.001;
                    return total + weightInKg;
                }, 0);
            };

            const gearWeight = calculateGearWeight();
            const myExpeditionWeight = vehicleBaseWeight + gearWeight;

            // Calculate estimated modification weight
            const calculateModificationWeight = () => {
                let modWeight = 0;
                if (hasFrontBumper) modWeight += 45; // Typical steel front bumper
                if (hasWinch) modWeight += 35; // Average winch with cable
                if (hasRearBumper) modWeight += 50; // Rear bumper with swing-out
                if (hasTyreCarrier) modWeight += 45; // Spare tyre + carrier (35kg tyre + 10kg carrier)
                if (hasSliders) modWeight += 40; // Rock sliders (pair)
                if (hasRoofRack) modWeight += 25; // Basic roof rack
                if (hasLongRangeTanks) modWeight += 120; // Long range fuel tank (empty ~30kg, full ~90kg extra)
                return modWeight;
            };

            // Estimate their gear weight based on comparison to yours
            const estimateTheirGearWeight = () => {
                if (!carriesOverlandGear) return 0;
                
                if (gearComparison === 'less') {
                    return gearWeight * 0.5; // Half of yours
                } else if (gearComparison === 'same') {
                    return gearWeight; // Same as yours
                } else { // more
                    return gearWeight * 1.5; // 50% more than yours
                }
            };

            // Get recovery gear inventory
            const recoveryItems = items.filter(i => i.category === 'Recovery & Trail Assistance');

            // Build detailed gear breakdown for AI
            const buildGearBreakdown = () => {
                const breakdown = {
                    cookingWeight: 0,
                    waterWeight: 0,
                    toolsWeight: 0,
                    recoveryWeight: 0,
                    firstAidWeight: 0,
                    sleepingWeight: 0,
                    shelterWeight: 0,
                    electronicsWeight: 0,
                    clothingWeight: 0,
                    otherWeight: 0
                };

                items.forEach(item => {
                    if (!item.weight || !item.category) return;
                    const weight = parseFloat(item.weight);
                    let weightInKg = weight;
                    if (item.weightUnit === 'lb') weightInKg = weight * 0.453592;
                    else if (item.weightUnit === 'oz') weightInKg = weight * 0.0283495;
                    else if (item.weightUnit === 'g') weightInKg = weight * 0.001;

                    const category = item.category.toLowerCase();
                    if (category.includes('cooking')) breakdown.cookingWeight += weightInKg;
                    else if (category.includes('water') || category.includes('hygiene')) breakdown.waterWeight += weightInKg;
                    else if (category.includes('tools')) breakdown.toolsWeight += weightInKg;
                    else if (category.includes('recovery')) breakdown.recoveryWeight += weightInKg;
                    else if (category.includes('first aid')) breakdown.firstAidWeight += weightInKg;
                    else if (category.includes('sleeping')) breakdown.sleepingWeight += weightInKg;
                    else if (category.includes('shelter')) breakdown.shelterWeight += weightInKg;
                    else if (category.includes('electronics')) breakdown.electronicsWeight += weightInKg;
                    else if (category.includes('clothing')) breakdown.clothingWeight += weightInKg;
                    else breakdown.otherWeight += weightInKg;
                });

                return breakdown;
            };

            const performRecoveryAssessment = async () => {
                if (!vehicleMake || !vehicleModel || !vehicleYear) {
                    alert('Please enter the vehicle make, model, and year.');
                    return;
                }

                setIsAnalyzing(true);

                try {
                    const modificationWeight = calculateModificationWeight();
                    const theirEstimatedGearWeight = estimateTheirGearWeight();
                    const gearBreakdown = buildGearBreakdown();

                    const recoveryInventory = recoveryItems.map(item => 
                        `- ${item.name} (${item.subcategory || 'Uncategorized'})${item.recoveryRating ? ` - Rated: ${item.recoveryRating}` : ' - Rating unknown'}${item.certificationStandard ? ` - ${item.certificationStandard}` : ''}${item.toolCondition ? ` - Condition: ${item.toolCondition}` : ''}`
                    ).join('\n');

                    // Build modifications list
                    const modifications = [];
                    if (hasFrontBumper) modifications.push('Steel front bumper (~45kg)');
                    if (hasWinch) modifications.push('Winch with cable (~35kg)');
                    if (hasRearBumper) modifications.push('Rear bumper with swing-out (~50kg)');
                    if (hasTyreCarrier) modifications.push('Spare tyre on carrier (~45kg)');
                    if (hasSliders) modifications.push('Rock sliders/step bars (~40kg)');
                    if (hasRoofRack) modifications.push('Roof rack (~25kg)');
                    if (hasLongRangeTanks) modifications.push('Long range fuel tank (~120kg when full)');
                    if (otherModifications) modifications.push(`Other: ${otherModifications}`);

                    const prompt = `You are an expert vehicle recovery specialist. I'm on a trail and need to assess if I can safely help recover another vehicle. I need you to research their vehicle weight and provide comprehensive calculations.

MY VEHICLE & EQUIPMENT:
- My vehicle: 2003 GMC Sierra 1500 Z71 Extended Cab 4x4
- My base weight: ${vehicleBaseWeight} kg
- My gear weight: ${gearWeight.toFixed(1)} kg
- MY TOTAL LOADED WEIGHT: ${myExpeditionWeight.toFixed(1)} kg
- My features: G80 auto-locking rear differential, 4WD, Radflo 2.5 reservoir shocks

MY GEAR BREAKDOWN (for reference when estimating theirs):
- Cooking equipment: ${gearBreakdown.cookingWeight.toFixed(1)} kg
- Water/hygiene: ${gearBreakdown.waterWeight.toFixed(1)} kg
- Tools & equipment: ${gearBreakdown.toolsWeight.toFixed(1)} kg
- Recovery gear: ${gearBreakdown.recoveryWeight.toFixed(1)} kg
- First aid: ${gearBreakdown.firstAidWeight.toFixed(1)} kg
- Sleeping gear: ${gearBreakdown.sleepingWeight.toFixed(1)} kg
- Shelter: ${gearBreakdown.shelterWeight.toFixed(1)} kg
- Electronics: ${gearBreakdown.electronicsWeight.toFixed(1)} kg
- Clothing: ${gearBreakdown.clothingWeight.toFixed(1)} kg
- Other: ${gearBreakdown.otherWeight.toFixed(1)} kg

MY RECOVERY EQUIPMENT:
${recoveryInventory || 'No recovery equipment cataloged'}

STRANDED VEHICLE DETAILS:
- Make: ${vehicleMake}
- Model: ${vehicleModel}
- Year: ${vehicleYear}
${stuckCondition ? `- Stuck condition: ${stuckCondition}` : ''}

THEIR VEHICLE MODIFICATIONS:
${hasModifications && modifications.length > 0 
    ? modifications.map(m => `- ${m}`).join('\n') + `\n- Total estimated modification weight: ${modificationWeight} kg`
    : '- Stock vehicle, no significant modifications reported'}

THEIR OVERLAND GEAR:
${carriesOverlandGear 
    ? `- YES, they carry overland/adventure gear
- Gear amount relative to mine: ${gearComparison === 'less' ? 'LESS than mine (~50% of my gear weight)' : gearComparison === 'same' ? 'SIMILAR to mine (~same as my gear weight)' : 'MORE than mine (~50% more than my gear weight)'}
- Their estimated gear weight: ${theirEstimatedGearWeight.toFixed(1)} kg (based on comparison to my ${gearWeight.toFixed(1)} kg)
- Use my gear breakdown above as reference for typical overland equipment weights`
    : '- NO significant overland gear reported (just day-trip or minimal supplies)'}

CRITICAL WEIGHT CALCULATION REQUIRED:
Please perform these calculations step-by-step:

1. **Research Stock Vehicle Weight**:
   - Research and provide the official curb weight of the ${vehicleYear} ${vehicleMake} ${vehicleModel}
   - Note any variations by trim level, engine, or drivetrain
   - Provide source if possible

2. **Calculate Modification Weight**:
   - Stock curb weight: [from research]
   - Add modifications: ${modificationWeight} kg
   - Subtotal with mods: [calculate]

3. **Calculate Gear Weight**:
   - Vehicle with mods: [from step 2]
   - Add overland gear: ${theirEstimatedGearWeight.toFixed(1)} kg
   - Add fuel (estimate based on tank size and situation)
   - Add passengers and personal items (estimate)
   - **TOTAL ESTIMATED LOADED WEIGHT**: [final calculation]

4. **Weight Comparison Analysis**:
   - My vehicle loaded weight: ${myExpeditionWeight.toFixed(1)} kg
   - Their estimated loaded weight: [from step 3]
   - Weight difference: [calculate]
   - Percentage heavier/lighter: [calculate]
   - Assessment: [safe ratio or concerning?]

5. **Can I Help? (YES/NO)**:
   - Clear YES or NO answer
   - Primary factors in decision
   - Brief explanation

6. **Recovery Gear Requirements**:
   - Their weight needs gear rated: [their weight Ã— 3] kg minimum
   - My available gear analysis:
     * Which items meet requirements?
     * Which items are under-rated?
     * Specific recommendations for this weight

7. **Safety Assessment**:
   - Risk level (Low/Medium/High) based on actual weight calculations
   - Specific concerns for this weight difference
   - Vehicle stability considerations
   - Ground conditions factor

8. **Recovery Method Recommendations**:
   - Best method for this weight and situation
   - Kinetic vs static pull analysis
   - Winching considerations
   - Why this method is recommended

9. **Step-by-Step Recovery Plan**:
   - Detailed procedure accounting for their weight
   - Specific attachment points for ${vehicleYear} ${vehicleMake} ${vehicleModel}
   - Safety precautions specific to weight difference
   - Communication and spotting

10. **Vehicle-Specific Considerations**:
    - Recovery point locations and ratings for their vehicle
    - Known issues with ${vehicleMake} ${vehicleModel} recovery
    - Frame strength considerations
    - Modification impact on recovery points

11. **Risk Factors**:
    - Specific dangers given weight calculations
    - What could fail with this weight
    - When to abort recovery
    - Alternative options if unsafe

12. **Additional Equipment Needs**:
    - What am I missing for this weight?
    - Could use their gear to supplement?
    - Should I wait for additional help?

Be extremely specific with weight calculations. Show your math. If their weight exceeds safe recovery limits with my equipment, clearly state I should NOT attempt it. Prioritize safety over helping.`;

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        const result = {
                            timestamp: new Date().toISOString(),
                            vehicle: `${vehicleYear} ${vehicleMake} ${vehicleModel}`,
                            modifications: hasModifications ? modifications.join(', ') : 'Stock',
                            modWeight: modificationWeight,
                            gearComparison: carriesOverlandGear ? gearComparison : 'none',
                            estimatedGearWeight: theirEstimatedGearWeight,
                            condition: stuckCondition,
                            analysis: data.content[0].text
                        };
                        setAnalysis(result);
                        setSavedAssessments([result, ...savedAssessments]);
                    } else {
                        throw new Error('Unexpected response format');
                    }
                } catch (error) {
                    console.error('Recovery assessment error:', error);
                    setAnalysis({
                        timestamp: new Date().toISOString(),
                        vehicle: `${vehicleYear} ${vehicleMake} ${vehicleModel}`,
                        error: true,
                        analysis: `Error performing assessment: ${error.message}\n\nPlease check your internet connection and try again. This feature requires internet access to analyze the vehicle and provide recommendations.`
                    });
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const clearForm = () => {
                setVehicleMake('');
                setVehicleModel('');
                setVehicleYear('');
                setEstimatedLoad('moderate');
                setStuckCondition('');
                setHasModifications(false);
                setHasFrontBumper(false);
                setHasWinch(false);
                setHasRearBumper(false);
                setHasTyreCarrier(false);
                setHasSliders(false);
                setHasRoofRack(false);
                setHasLongRangeTanks(false);
                setOtherModifications('');
                setCarriesOverlandGear(false);
                setGearComparison('same');
                setAnalysis(null);
            };

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-red-500 to-orange-500 p-6 rounded-xl shadow-lg">
                        <h2 className="text-3xl font-bold text-white flex items-center space-x-3">
                            <span>ğŸš¨</span>
                            <span>Trail Recovery Assistant</span>
                        </h2>
                        <p className="text-red-50 mt-2">
                            AI-powered weight calculations and safety assessment for vehicle recovery
                        </p>
                        <div className="mt-3 bg-red-600 bg-opacity-50 p-3 rounded-lg">
                            <p className="text-white text-sm font-medium">
                                âš ï¸ Requires internet â€¢ Real-time vehicle research â€¢ Comprehensive weight analysis
                            </p>
                        </div>
                    </div>

                    {/* Your Vehicle Summary */}
                    <div className="bg-blue-50 border-2 border-blue-300 p-5 rounded-xl">
                        <h3 className="font-bold text-blue-900 mb-3 flex items-center space-x-2">
                            <span>ğŸš™</span>
                            <span>Your Vehicle & Equipment Status</span>
                        </h3>
                        <div className="grid md:grid-cols-3 gap-4">
                            <div>
                                <div className="text-sm text-blue-600 font-medium">Your Expedition Weight</div>
                                <div className="text-2xl font-bold text-blue-900">{myExpeditionWeight.toFixed(0)} kg</div>
                                <div className="text-xs text-blue-600">Vehicle: {vehicleBaseWeight} kg + Gear: {gearWeight.toFixed(0)} kg</div>
                            </div>
                            <div>
                                <div className="text-sm text-blue-600 font-medium">Recovery Items Available</div>
                                <div className="text-2xl font-bold text-blue-900">{recoveryItems.length}</div>
                                <div className="text-xs text-blue-600">From your catalog</div>
                            </div>
                            <div>
                                <div className="text-sm text-blue-600 font-medium">Your Gear Reference</div>
                                <div className="text-2xl font-bold text-blue-900">{gearWeight.toFixed(0)} kg</div>
                                <div className="text-xs text-blue-600">For comparison estimates</div>
                            </div>
                        </div>
                    </div>

                    {/* Assessment Form */}
                    <div className="bg-white p-6 rounded-xl shadow-lg border-2 border-gray-200">
                        <h3 className="font-bold text-gray-900 mb-4 text-xl flex items-center space-x-2">
                            <span>ğŸ“‹</span>
                            <span>Stranded Vehicle Information</span>
                        </h3>
                        
                        {/* Basic Vehicle Info */}
                        <div className="grid md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Year *
                                </label>
                                <input
                                    type="text"
                                    value={vehicleYear}
                                    onChange={(e) => setVehicleYear(e.target.value)}
                                    placeholder="e.g., 2018"
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Make *
                                </label>
                                <input
                                    type="text"
                                    value={vehicleMake}
                                    onChange={(e) => setVehicleMake(e.target.value)}
                                    placeholder="e.g., Toyota"
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Model *
                                </label>
                                <input
                                    type="text"
                                    value={vehicleModel}
                                    onChange={(e) => setVehicleModel(e.target.value)}
                                    placeholder="e.g., Land Cruiser"
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                />
                            </div>
                        </div>

                        <div className="mb-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                Stuck Condition (Optional)
                            </label>
                            <input
                                type="text"
                                value={stuckCondition}
                                onChange={(e) => setStuckCondition(e.target.value)}
                                placeholder="e.g., deep sand, mud, ditch, high-centered on rock"
                                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                            />
                        </div>

                        {/* Modifications Section */}
                        <div className="mb-6 bg-orange-50 p-5 rounded-lg border-2 border-orange-200">
                            <div className="flex items-center space-x-3 mb-4">
                                <input
                                    type="checkbox"
                                    id="hasModifications"
                                    checked={hasModifications}
                                    onChange={(e) => setHasModifications(e.target.checked)}
                                    className="w-5 h-5 text-orange-600 rounded focus:ring-orange-500"
                                />
                                <label htmlFor="hasModifications" className="font-bold text-gray-900">
                                    ğŸ”§ Vehicle has modifications (adds weight)
                                </label>
                            </div>

                            {hasModifications && (
                                <div className="space-y-3 ml-8">
                                    <div className="grid md:grid-cols-2 gap-3">
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasFrontBumper}
                                                onChange={(e) => setHasFrontBumper(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Steel front bumper (~45 kg)</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasWinch}
                                                onChange={(e) => setHasWinch(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Winch with cable (~35 kg)</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasRearBumper}
                                                onChange={(e) => setHasRearBumper(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Rear bumper with swing-out (~50 kg)</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasTyreCarrier}
                                                onChange={(e) => setHasTyreCarrier(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Spare tyre on carrier (~45 kg)</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasSliders}
                                                onChange={(e) => setHasSliders(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Rock sliders / step bars (~40 kg)</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasRoofRack}
                                                onChange={(e) => setHasRoofRack(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Roof rack (~25 kg)</span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="checkbox"
                                                checked={hasLongRangeTanks}
                                                onChange={(e) => setHasLongRangeTanks(e.target.checked)}
                                                className="w-4 h-4 text-orange-600 rounded"
                                            />
                                            <span className="text-sm">Long range fuel tank (~120 kg full)</span>
                                        </label>
                                    </div>
                                    <div>
                                        <input
                                            type="text"
                                            value={otherModifications}
                                            onChange={(e) => setOtherModifications(e.target.value)}
                                            placeholder="Other modifications (e.g., lift kit, larger tyres, bull bar)"
                                            className="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                        />
                                    </div>
                                    <div className="bg-orange-100 p-3 rounded border border-orange-300">
                                        <p className="text-sm font-bold text-orange-900">
                                            Estimated modification weight: {calculateModificationWeight()} kg
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Overland Gear Section */}
                        <div className="mb-6 bg-green-50 p-5 rounded-lg border-2 border-green-200">
                            <div className="flex items-center space-x-3 mb-4">
                                <input
                                    type="checkbox"
                                    id="carriesOverlandGear"
                                    checked={carriesOverlandGear}
                                    onChange={(e) => setCarriesOverlandGear(e.target.checked)}
                                    className="w-5 h-5 text-green-600 rounded focus:ring-green-500"
                                />
                                <label htmlFor="carriesOverlandGear" className="font-bold text-gray-900">
                                    ğŸ’ Vehicle carries overland / adventure gear
                                </label>
                            </div>

                            {carriesOverlandGear && (
                                <div className="ml-8 space-y-3">
                                    <p className="text-sm text-gray-700 mb-2">
                                        Compare their gear load to yours ({gearWeight.toFixed(0)} kg):
                                    </p>
                                    <div className="space-y-2">
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="radio"
                                                name="gearComparison"
                                                value="less"
                                                checked={gearComparison === 'less'}
                                                onChange={(e) => setGearComparison(e.target.value)}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className="text-sm">
                                                <strong>Less than mine</strong> - Weekend trip, minimal gear (~{(gearWeight * 0.5).toFixed(0)} kg)
                                            </span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="radio"
                                                name="gearComparison"
                                                value="same"
                                                checked={gearComparison === 'same'}
                                                onChange={(e) => setGearComparison(e.target.value)}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className="text-sm">
                                                <strong>Similar to mine</strong> - Similar expedition setup (~{gearWeight.toFixed(0)} kg)
                                            </span>
                                        </label>
                                        <label className="flex items-center space-x-2">
                                            <input
                                                type="radio"
                                                name="gearComparison"
                                                value="more"
                                                checked={gearComparison === 'more'}
                                                onChange={(e) => setGearComparison(e.target.value)}
                                                className="w-4 h-4 text-green-600"
                                            />
                                            <span className="text-sm">
                                                <strong>More than mine</strong> - Full overlanding, family trip (~{(gearWeight * 1.5).toFixed(0)} kg)
                                            </span>
                                        </label>
                                    </div>
                                    <div className="bg-green-100 p-3 rounded border border-green-300 mt-3">
                                        <p className="text-sm font-bold text-green-900">
                                            Estimated gear weight: {estimateTheirGearWeight().toFixed(0)} kg
                                        </p>
                                        <p className="text-xs text-green-700 mt-1">
                                            Based on your catalog: Cooking, water, tools, recovery, sleeping, shelter, electronics, clothing
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-3">
                            <button
                                onClick={performRecoveryAssessment}
                                disabled={isAnalyzing || !vehicleMake || !vehicleModel || !vehicleYear}
                                className="flex-1 px-6 py-4 bg-red-600 text-white rounded-lg font-bold text-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-3"
                            >
                                {isAnalyzing ? (
                                    <>
                                        <svg className="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Calculating Weights...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                        </svg>
                                        <span>ğŸ¤– Calculate & Assess Recovery</span>
                                    </>
                                )}
                            </button>
                            <button
                                onClick={clearForm}
                                className="px-6 py-4 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition"
                            >
                                Clear
                            </button>
                        </div>

                        <p className="text-xs text-gray-500 mt-3">
                            * AI researches vehicle weight, adds modifications, adds gear estimates based on your catalog, 
                            then assesses if your recovery equipment can safely handle the total weight. Internet required.
                        </p>
                    </div>

                    {/* Analysis Results */}
                    {analysis && (
                        <div className={`rounded-xl shadow-xl border-2 overflow-hidden ${
                            analysis.error ? 'border-red-500' : 'border-green-500'
                        }`}>
                            <div className={`px-6 py-4 ${
                                analysis.error ? 'bg-red-500' : 'bg-green-500'
                            }`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h3 className="font-bold text-white text-xl flex items-center space-x-2">
                                            <span>{analysis.error ? 'âŒ' : 'âœ…'}</span>
                                            <span>Recovery Assessment: {analysis.vehicle}</span>
                                        </h3>
                                        <p className="text-white text-sm mt-1">
                                            {new Date(analysis.timestamp).toLocaleString()}
                                        </p>
                                        {!analysis.error && (
                                            <div className="mt-2 space-y-1 text-white text-sm">
                                                <p>Mods: {analysis.modifications} (+{analysis.modWeight} kg)</p>
                                                {analysis.gearComparison !== 'none' && (
                                                    <p>Gear: {analysis.gearComparison} than yours (~{analysis.estimatedGearWeight.toFixed(0)} kg)</p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-6 max-h-96 overflow-y-auto">
                                <div className="prose prose-sm max-w-none">
                                    <div className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                                        {analysis.analysis}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Previous Assessments */}
                    {savedAssessments.length > 0 && (
                        <div className="bg-gray-50 p-6 rounded-xl">
                            <h3 className="font-bold text-gray-900 mb-4 flex items-center space-x-2">
                                <span>ğŸ“š</span>
                                <span>Recent Assessments</span>
                            </h3>
                            <div className="space-y-3">
                                {savedAssessments.slice(0, 5).map((assessment, idx) => (
                                    <div 
                                        key={idx} 
                                        onClick={() => setAnalysis(assessment)}
                                        className="bg-white p-4 rounded-lg border-2 border-gray-200 hover:border-blue-400 cursor-pointer transition"
                                    >
                                        <div className="font-semibold text-gray-900">{assessment.vehicle}</div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            {new Date(assessment.timestamp).toLocaleString()}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1 space-y-0.5">
                                            <div>Mods: {assessment.modifications} (+{assessment.modWeight} kg)</div>
                                            {assessment.gearComparison !== 'none' && (
                                                <div>Gear: {assessment.gearComparison} than yours (~{assessment.estimatedGearWeight.toFixed(0)} kg)</div>
                                            )}
                                            {assessment.condition && <div>Condition: {assessment.condition}</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Safety Disclaimer */}
                    <div className="bg-yellow-50 border-2 border-yellow-400 p-5 rounded-xl">
                        <div className="flex items-start space-x-3">
                            <svg className="w-8 h-8 text-yellow-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <div>
                                <h3 className="font-bold text-yellow-900 mb-2">Safety Disclaimer</h3>
                                <p className="text-sm text-yellow-800">
                                    Weight calculations are estimates. Vehicle recovery is dangerous. AI assessment is advisory only. 
                                    Always inspect actual vehicle, verify weights if possible, and use proper technique. When in doubt, 
                                    call professional recovery. You assume all risk.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }


        function RecoveryView({ items, vehicleBaseWeight }) {
            const [selectedTab, setSelectedTab] = useState('overview');
            const [showAIAnalysis, setShowAIAnalysis] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            
            const recoveryItems = items.filter(i => i.category === 'Recovery & Trail Assistance');
            
            // Calculate total expedition weight dynamically
            const calculateGearWeight = () => {
                return items.reduce((total, item) => {
                    if (!item.weight || !item.weightUnit) return total;
                    const weight = parseFloat(item.weight);
                    
                    // Convert to kg
                    let weightInKg = weight;
                    if (item.weightUnit === 'lb') weightInKg = weight * 0.453592;
                    else if (item.weightUnit === 'oz') weightInKg = weight * 0.0283495;
                    else if (item.weightUnit === 'g') weightInKg = weight * 0.001;
                    
                    return total + weightInKg;
                }, 0);
            };

            const gearWeight = calculateGearWeight();
            const totalExpeditionWeight = vehicleBaseWeight + gearWeight;
            const recommendedMinRating = totalExpeditionWeight * 3; // 3x vehicle weight
            
            const analyzeRecoveryKit = async () => {
                setIsAnalyzing(true);
                setShowAIAnalysis(true);
                
                try {
                    const inventorySummary = {
                        totalItems: recoveryItems.length,
                        bySubcategory: {},
                        byRating: {},
                        needsInspection: [],
                        underRated: []
                    };

                    recoveryItems.forEach(item => {
                        const subcat = item.subcategory || 'Other';
                        inventorySummary.bySubcategory[subcat] = (inventorySummary.bySubcategory[subcat] || 0) + 1;
                        
                        const rating = item.recoveryRating || 'Unknown';
                        inventorySummary.byRating[rating] = (inventorySummary.byRating[rating] || 0) + 1;
                        
                        // Check for items needing inspection (older than 6 months)
                        if (item.inspectionDate) {
                            const daysSince = Math.floor((new Date() - new Date(item.inspectionDate)) / (1000 * 60 * 60 * 24));
                            if (daysSince > 180) {
                                inventorySummary.needsInspection.push(item.name);
                            }
                        } else {
                            inventorySummary.needsInspection.push(item.name);
                        }
                    });

                    const prompt = `You are an expert in 4x4 vehicle recovery and trail assistance for North American overlanding. I need help analyzing my recovery kit for my Canadian-based 2003 GMC Sierra 1500 Z71 for Pan-American and worldwide overlanding where I may need to:
1. Recover my own vehicle when stuck
2. Assist other overlanders of similar or larger size (up to 3,500 kg)
3. Be prepared for self-recovery in remote Canadian North, Alaska, and Central/South America with no assistance available

Here's my current recovery inventory:

SUMMARY:
- Total recovery items: ${inventorySummary.totalItems}
- Items by type: ${JSON.stringify(inventorySummary.bySubcategory, null, 2)}
- Items by rating: ${JSON.stringify(inventorySummary.byRating, null, 2)}
- Items needing inspection: ${inventorySummary.needsInspection.length > 0 ? inventorySummary.needsInspection.join(', ') : 'None identified'}

DETAILED INVENTORY:
${recoveryItems.map(item => `- ${item.name} (${item.subcategory || 'Uncategorized'})${item.recoveryRating ? ` - Rated: ${item.recoveryRating}` : ''}${item.certificationStandard ? ` - Cert: ${item.certificationStandard}` : ''}${item.toolCondition ? ` - Condition: ${item.toolCondition}` : ''}`).join('\n')}

MY VEHICLE DETAILS:
- 2003 GMC Sierra 1500 Z71 Extended Cab 4x4 (Canadian truck)
- Base vehicle weight: ${vehicleBaseWeight} kg
- Gear weight: ${gearWeight.toFixed(1)} kg
- TOTAL EXPEDITION WEIGHT: ${totalExpeditionWeight.toFixed(1)} kg (vehicle + all gear)
- Has: G80 auto-locking rear differential, 4WD, Radflo 2.5 reservoir shocks
- Minimum safe working load for recovery: ${recommendedMinRating.toFixed(0)} kg (3x total expedition weight)

Please analyze my recovery kit and provide:

1. **Critical Gaps**: What essential recovery equipment am I missing for:
   - Self-recovery (stuck in sand, mud, snow, muskeg, Arctic conditions)
   - Helping another vehicle (similar or larger size)
   - Safe winching operations
   - Communication and signaling (remote Canadian North, cellular dead zones)
   - Protection (for myself and the vehicle)

2. **Rating Assessment**: 
   - Which items are under-rated for my vehicle weight?
   - What minimum ratings should I target?
   - Are my shackles/straps/ropes rated appropriately?

3. **Inspection & Maintenance**: 
   - Which items need immediate inspection or replacement?
   - What should I inspect and how often?
   - Signs of wear to watch for
   - Extreme cold impact on recovery gear (-40Â°C considerations)

4. **Good Samaritan Readiness**:
   - Am I equipped to help larger vehicles (3,000-3,500 kg)?
   - What additional gear would let me assist others safely?
   - Communication equipment for coordinating multi-vehicle recoveries

5. **Safety Assessment**:
   - Do I have proper protective gear (gloves, eye protection, dampers)?
   - Vehicle protection (recovery points, tree savers)?
   - Signaling and visibility equipment?
   - Cold weather considerations for recovery operations

6. **Shopping List** (Canadian/North American Focus): Create a prioritized list with:
   - Item name and specifications
   - Why it's needed (self-recovery vs helping others)
   - Minimum ratings/certifications (ARB, Factor 55, etc.)
   - Where to buy in Canada: Canadian Tire, 4Wheel Parts, Expedition Essentials, Princess Auto
   - Where to buy in USA: 4Wheel Parts, Quadratec, ExtremeTerrain, ARB USA dealers
   - Approximate Canadian price (CAD)
   - Priority level (Critical/Important/Nice to Have)

7. **Recovery Scenarios**: What specific recovery situations am I NOT prepared for?
   - Canadian/Alaskan scenarios: Muskeg, permafrost, deep snow, extreme cold
   - Pan-American scenarios: Deep mud, sand, high altitude, tropical conditions

Focus on practical, field-tested gear suitable for solo overlanding from Canada through Pan-American route and being a helpful member of the overlanding community. Consider extreme Canadian Arctic conditions and limited parts availability in Central/South America.`;

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [
                                { role: 'user', content: prompt }
                            ]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        setAiAnalysis(data.content[0].text);
                    } else {
                        throw new Error('Unexpected response format');
                    }
                } catch (error) {
                    console.error('AI Analysis error:', error);
                    setAiAnalysis(`Error analyzing recovery kit: ${error.message}\n\nPlease make sure you're connected to the internet and try again.`);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const downloadRecoveryReport = () => {
                const reportData = recoveryItems.map(item => ({
                    'Item': item.name,
                    'Type': item.subcategory || 'N/A',
                    'Rating/SWL': item.recoveryRating || 'N/A',
                    'Certification': item.certificationStandard || 'N/A',
                    'Condition': item.toolCondition || 'N/A',
                    'Last Inspection': item.inspectionDate || 'Never',
                    'Manufacturer': item.manufacturer || 'N/A',
                    'Location': item.location || 'N/A'
                }));

                const csv = [
                    Object.keys(reportData[0] || {}).join(','),
                    ...reportData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recovery-kit-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            // Calculate items needing inspection
            const needsInspection = recoveryItems.filter(item => {
                if (!item.inspectionDate) return true;
                const daysSince = Math.floor((new Date() - new Date(item.inspectionDate)) / (1000 * 60 * 60 * 24));
                return daysSince > 180; // 6 months
            });

            return (
                <>
                    <div className="mb-6 flex justify-between items-start">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900 flex items-center space-x-2">
                                <span>ğŸ”—</span>
                                <span>Recovery & Trail Assistance</span>
                            </h2>
                            <p className="text-gray-600 mt-1">Vehicle recovery and Good Samaritan equipment</p>
                            <div className="mt-2 bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                <p className="text-sm text-blue-900">
                                    <strong>Your Expedition Weight:</strong> Vehicle {vehicleBaseWeight.toFixed(0)} kg + Gear {gearWeight.toFixed(0)} kg = <strong>{totalExpeditionWeight.toFixed(0)} kg</strong> â€¢ Minimum recovery gear rating: <strong>{recommendedMinRating.toLocaleString()} kg</strong> (3x weight)
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={analyzeRecoveryKit}
                                disabled={isAnalyzing || recoveryItems.length === 0}
                                className="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isAnalyzing ? (
                                    <>
                                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Analyzing...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        <span>ğŸ¤– AI Assistant</span>
                                    </>
                                )}
                            </button>
                            <button
                                onClick={downloadRecoveryReport}
                                className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span>Download Report</span>
                            </button>
                        </div>
                    </div>

                    {/* AI Analysis Panel */}
                    {showAIAnalysis && (
                        <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg border-2 border-purple-300 overflow-hidden">
                            <div className="bg-purple-600 px-6 py-4 flex justify-between items-center">
                                <h3 className="font-bold text-white flex items-center space-x-2">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                    <span>AI Recovery Kit Analysis</span>
                                </h3>
                                <button
                                    onClick={() => setShowAIAnalysis(false)}
                                    className="text-white hover:text-purple-200 transition"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="p-6 max-h-96 overflow-y-auto">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center py-12">
                                        <svg className="animate-spin h-12 w-12 text-purple-600 mb-4" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p className="text-gray-600 font-medium">Analyzing your recovery equipment...</p>
                                        <p className="text-sm text-gray-500 mt-2">Claude is reviewing your kit for self-recovery and helping others</p>
                                    </div>
                                ) : aiAnalysis ? (
                                    <div className="prose prose-sm max-w-none">
                                        <div className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                                            {aiAnalysis}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12 text-gray-500">
                                        <p>Click "AI Assistant" to analyze your recovery kit</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <div className="text-3xl font-bold text-blue-600">{recoveryItems.length}</div>
                            <div className="text-gray-600 mt-1">Total Recovery Items</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <div className="text-3xl font-bold text-green-600">
                                {recoveryItems.filter(i => i.recoveryRating && (i.recoveryRating.includes('3,500') || i.recoveryRating.includes('5,000') || i.recoveryRating.includes('7,000'))).length}
                            </div>
                            <div className="text-gray-600 mt-1">Properly Rated (â‰¥{recommendedMinRating} kg)</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                            <div className="text-3xl font-bold text-yellow-600">
                                {needsInspection.length}
                            </div>
                            <div className="text-gray-600 mt-1">âš ï¸ Needs Inspection</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-500">
                            <div className="text-3xl font-bold text-red-600">
                                {recoveryItems.filter(i => i.toolCondition === 'Needs Replacement').length}
                            </div>
                            <div className="text-gray-600 mt-1">Needs Replacement</div>
                        </div>
                    </div>

                    {/* Warning for items needing inspection */}
                    {needsInspection.length > 0 && (
                        <div className="mb-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                            <div className="flex items-start">
                                <svg className="w-6 h-6 text-yellow-600 mr-3 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <h3 className="font-bold text-yellow-900">Recovery Gear Inspection Required</h3>
                                    <p className="text-sm text-yellow-800 mt-1">
                                        {needsInspection.length} item(s) need inspection (no inspection recorded or >6 months old). 
                                        Recovery equipment should be inspected every 6 months for wear, fraying, rust, and damage.
                                    </p>
                                    <ul className="mt-2 text-sm text-yellow-800 list-disc list-inside">
                                        {needsInspection.slice(0, 5).map(item => (
                                            <li key={item.id}>{item.name}</li>
                                        ))}
                                        {needsInspection.length > 5 && <li>...and {needsInspection.length - 5} more</li>}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tabs */}
                    <div className="flex space-x-2 mb-6 border-b">
                        <button
                            onClick={() => setSelectedTab('overview')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'overview'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Overview
                        </button>
                        <button
                            onClick={() => setSelectedTab('byrating')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'byrating'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            By Rating
                        </button>
                        <button
                            onClick={() => setSelectedTab('inspection')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'inspection'
                                    ? 'border-b-3 border-blue-600 text-blue-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Inspection Tracker
                        </button>
                    </div>

                    {/* Tab Content */}
                    {selectedTab === 'overview' && (
                        <div className="space-y-6">
                            {RECOVERY_SUBCATEGORIES.filter(sub => sub !== 'Other').map(subcategory => {
                                const items = recoveryItems.filter(i => i.subcategory === subcategory);
                                if (items.length === 0) return null;
                                
                                return (
                                    <div key={subcategory} className="bg-white rounded-xl shadow-md overflow-hidden">
                                        <div className="bg-blue-50 px-6 py-4 border-b border-blue-100">
                                            <h3 className="font-bold text-gray-900">{subcategory} ({items.length})</h3>
                                        </div>
                                        <div className="p-6">
                                            <div className="grid md:grid-cols-2 gap-4">
                                                {items.map(item => (
                                                    <div key={item.id} className="border-2 rounded-lg p-4 hover:shadow-md transition">
                                                        <div className="font-semibold text-gray-900">{item.name}</div>
                                                        {item.manufacturer && (
                                                            <div className="text-xs text-gray-600 mt-1">{item.manufacturer}</div>
                                                        )}
                                                        {item.recoveryRating && (
                                                            <div className={`text-sm font-medium mt-2 ${
                                                                item.recoveryRating.includes('< 2,000') ? 'text-red-600'
                                                                : item.recoveryRating.includes('2,000') ? 'text-yellow-600'
                                                                : 'text-green-600'
                                                            }`}>
                                                                âš–ï¸ Rated: {item.recoveryRating}
                                                            </div>
                                                        )}
                                                        {item.certificationStandard && (
                                                            <div className="text-xs text-blue-600 mt-1">
                                                                âœ“ {item.certificationStandard}
                                                            </div>
                                                        )}
                                                        {item.toolCondition && (
                                                            <div className={`text-xs mt-1 ${
                                                                item.toolCondition === 'New' || item.toolCondition === 'Good' ? 'text-green-600'
                                                                : item.toolCondition === 'Fair' ? 'text-yellow-600'
                                                                : 'text-red-600'
                                                            }`}>
                                                                Condition: {item.toolCondition}
                                                            </div>
                                                        )}
                                                        {item.inspectionDate && (
                                                            <div className="text-xs text-gray-500 mt-1">
                                                                Last inspected: {new Date(item.inspectionDate).toLocaleDateString()}
                                                            </div>
                                                        )}
                                                        {item.location && (
                                                            <div className="text-xs text-gray-500 mt-1">ğŸ“ {item.location}</div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {selectedTab === 'byrating' && (
                        <div className="space-y-6">
                            {RECOVERY_RATING.map(rating => {
                                const items = recoveryItems.filter(i => i.recoveryRating === rating);
                                if (items.length === 0) return null;
                                
                                const isUnderRated = rating.includes('< 2,000') || (rating.includes('2,000') && !rating.includes('3,500'));
                                
                                return (
                                    <div key={rating} className={`bg-white rounded-xl shadow-md overflow-hidden ${isUnderRated ? 'border-2 border-red-500' : ''}`}>
                                        <div className={`px-6 py-4 border-b ${isUnderRated ? 'bg-red-100 border-red-200' : 'bg-gray-50 border-gray-200'}`}>
                                            <h3 className="font-bold text-gray-900 flex items-center space-x-2">
                                                {isUnderRated && <span className="text-red-600">âš ï¸</span>}
                                                <span>{rating} ({items.length} items)</span>
                                                {isUnderRated && <span className="text-sm text-red-600 font-normal">- Under-rated for your vehicle!</span>}
                                            </h3>
                                        </div>
                                        <div className="p-6">
                                            <div className="space-y-3">
                                                {items.map(item => (
                                                    <div key={item.id} className="border rounded-lg p-3">
                                                        <div className="font-semibold text-gray-900">{item.name}</div>
                                                        <div className="text-sm text-gray-600">{item.subcategory}</div>
                                                        {item.certificationStandard && (
                                                            <div className="text-xs text-blue-600">âœ“ {item.certificationStandard}</div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {selectedTab === 'inspection' && (
                        <div className="space-y-6">
                            <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                <p className="text-sm text-blue-900">
                                    <strong>Inspection Schedule:</strong> Recovery equipment should be inspected every 6 months for:
                                    wear, fraying, rust, deformation, damaged stitching, and proper function.
                                </p>
                            </div>

                            {needsInspection.length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-yellow-500">
                                    <div className="bg-yellow-100 px-6 py-4 border-b border-yellow-200">
                                        <h3 className="font-bold text-yellow-900">âš ï¸ Needs Inspection ({needsInspection.length})</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="space-y-3">
                                            {needsInspection.map(item => {
                                                const daysSince = item.inspectionDate 
                                                    ? Math.floor((new Date() - new Date(item.inspectionDate)) / (1000 * 60 * 60 * 24))
                                                    : null;
                                                
                                                return (
                                                    <div key={item.id} className="border-2 border-yellow-300 rounded-lg p-4 bg-yellow-50">
                                                        <div className="font-bold text-gray-900">{item.name}</div>
                                                        <div className="text-sm text-gray-600">{item.subcategory}</div>
                                                        <div className="text-sm text-yellow-800 mt-2">
                                                            {item.inspectionDate 
                                                                ? `Last inspected ${daysSince} days ago (${new Date(item.inspectionDate).toLocaleDateString()})`
                                                                : 'Never inspected - add inspection date!'}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {recoveryItems.filter(i => {
                                if (!i.inspectionDate) return false;
                                const daysSince = Math.floor((new Date() - new Date(i.inspectionDate)) / (1000 * 60 * 60 * 24));
                                return daysSince <= 180;
                            }).length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                    <div className="bg-green-50 px-6 py-4 border-b border-green-200">
                                        <h3 className="font-bold text-green-900">âœ“ Recently Inspected (Within 6 Months)</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid md:grid-cols-2 gap-3">
                                            {recoveryItems.filter(i => {
                                                if (!i.inspectionDate) return false;
                                                const daysSince = Math.floor((new Date() - new Date(i.inspectionDate)) / (1000 * 60 * 60 * 24));
                                                return daysSince <= 180;
                                            }).map(item => {
                                                const daysSince = Math.floor((new Date() - new Date(item.inspectionDate)) / (1000 * 60 * 60 * 24));
                                                
                                                return (
                                                    <div key={item.id} className="border rounded-lg p-3">
                                                        <div className="font-medium text-gray-900">{item.name}</div>
                                                        <div className="text-xs text-gray-600">{item.subcategory}</div>
                                                        <div className="text-xs text-green-600 mt-1">
                                                            Inspected {daysSince} days ago
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </>
            );
        }

        function ToolsView({ items }) {
            const [selectedTab, setSelectedTab] = useState('overview');
            const [showAIAnalysis, setShowAIAnalysis] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            
            const toolItems = items.filter(i => i.category === 'Tools & Equipment');
            
            const analyzeToolKit = async () => {
                setIsAnalyzing(true);
                setShowAIAnalysis(true);
                
                try {
                    const inventorySummary = {
                        totalItems: toolItems.length,
                        bySubcategory: {},
                        byCondition: {},
                        compatibilitySystems: []
                    };

                    toolItems.forEach(item => {
                        const subcat = item.subcategory || 'Other';
                        inventorySummary.bySubcategory[subcat] = (inventorySummary.bySubcategory[subcat] || 0) + 1;
                        
                        const condition = item.toolCondition || 'Unknown';
                        inventorySummary.byCondition[condition] = (inventorySummary.byCondition[condition] || 0) + 1;
                        
                        if (item.compatibleWith) {
                            inventorySummary.compatibilitySystems.push(item.compatibleWith);
                        }
                    });

                    const prompt = `You are an expert automotive technician and habitat/camper modification specialist for Canadian overlanding. I need help analyzing my tool kit for my 2003 GMC Sierra 1500 Z71 with habitat during Pan-American and worldwide travel.

**CRITICAL CONTEXT - TOOL KIT PHILOSOPHY:**

This is NOT a "build a complete vehicle in the wilderness" kit. This is a PRACTICAL kit for:

1. **Emergency Roadside Repairs** (Get to Pavement/Town):
   - Temporary fixes to safely reach nearest town or pavement for CAA pickup
   - Belt replacement, hose repair, electrical fixes, brake bleeding
   - Goal: Make it drivable, not perfect
   - Then: Drive to mechanic for proper repair

2. **DIY Habitat Projects** (Living Space Maintenance):
   - Modify and maintain truck bed habitat/camper
   - Build shelving, fix cabinetry, repair water systems
   - Woodworking, basic plumbing, 12V electrical
   - Comfort and livability improvements
   - Goal: Keep living space functional and comfortable

3. **Preventive Maintenance** (What I Can Do Myself):
   - Oil changes, filter replacements
   - Brake pad changes, fluid top-ups
   - Basic repairs I'm comfortable doing at campsite
   - Goal: Avoid shop visits for simple stuff I can handle

**NOT THE GOAL:**
âŒ Engine rebuild in the wilderness
âŒ Transmission tear-down on trail
âŒ Differential complete overhaul
âŒ Frame welding and fabrication
âŒ Professional shop capabilities
âŒ Carry every possible tool "just in case"

**WEIGHT REALITY:**
- Tools are HEAVY (full mechanic kit = 100+ kg)
- Habitat already heavy with living gear
- Every kg matters for payload, fuel economy, handling
- Prioritize: Common repairs, habitat work, emergency fixes

**CANADIAN CONTEXT:**
- CAA roadside assistance available
- Mechanics exist in towns (even Yukon, NWT)
- Major repairs = drive or tow to shop
- Self-sufficiency for COMMON issues, not everything

Here's my current tool inventory:

SUMMARY:
- Total tools/equipment: ${inventorySummary.totalItems}
- Items by category: ${JSON.stringify(inventorySummary.bySubcategory, null, 2)}
- Items by condition: ${JSON.stringify(inventorySummary.byCondition, null, 2)}
- Vehicle/Systems mentioned: ${inventorySummary.compatibilitySystems.join(', ') || 'Not specified'}

DETAILED INVENTORY:
${toolItems.map(item => `- ${item.name} (${item.subcategory || 'Uncategorized'}) - Condition: ${item.toolCondition || 'Unknown'}${item.compatibleWith ? ` - For: ${item.compatibleWith}` : ''}`).join('\n')}

MY VEHICLE & HABITAT:
- 2003 GMC Sierra 1500 Z71 Extended Cab 4x4
- Engine: 5.3L Vortec V8 (metric fasteners, some standard)
- Truck bed habitat/camper (custom or commercial)
- Living systems: 12V electrical, water, propane, storage
- Based in Canada, traveling Pan-American route

Please analyze my tool kit and provide:

1. **CRITICAL GAPS - EMERGENCY ROADSIDE REPAIRS:**
   What am I missing to handle common breakdowns and limp to town?
   
   **Common Roadside Scenarios:**
   - Belt replacement (serpentine belt fails)
   - Hose repair (coolant hose burst)
   - Brake bleeding (after line repair)
   - Electrical troubleshooting (alternator, battery, fuses)
   - Tire change (lug wrench, jack)
   - Sensor replacement (O2, MAF, easy bolt-on parts)
   
   **What tools make these possible?**
   - Socket sets (metric for engine, standard for some chassis)
   - Wrenches (metric/standard combination)
   - Pliers, wire cutters, crimpers
   - Screwdrivers, hex keys
   - Basic diagnostic (multimeter, code reader)
   - Tire changing equipment
   
   **What's NOT needed:**
   - Engine hoist
   - Transmission jack
   - Valve spring compressor
   - Brake lathe
   - Professional shop equipment

2. **HABITAT/CAMPER DIY TOOLS:**
   What am I missing for maintaining and improving my living space?
   
   **Common Habitat Projects:**
   - Build/repair shelving and storage
   - Fix cabinet doors, latches, hinges
   - Repair water system (fittings, hoses)
   - 12V electrical work (wire, terminals, switches)
   - Insulation and weatherproofing
   - Ventilation fan installation
   - Solar panel mounting
   
   **What tools make these possible?**
   - Drill/driver (cordless, 12V/20V)
   - Saw (hand saw, possibly compact circular saw)
   - Measuring tape, square, level
   - Wood screws, fasteners, L-brackets
   - Wire strippers, crimpers, heat shrink
   - Sealants (silicone, Sikaflex)
   - Basic plumbing (PEX tools, fittings)

3. **PREVENTIVE MAINTENANCE - DIY AT CAMPSITE:**
   What do I need to do basic maintenance myself?
   
   **Tasks I Can Handle:**
   - Oil changes (drain pan, funnel, rags)
   - Filter replacements (oil, air, fuel)
   - Brake pad replacement (C-clamp, brake cleaner)
   - Fluid top-ups and checks
   - Battery maintenance
   - Spark plug replacement (at 230,000+ km intervals)
   
   **What's needed:**
   - Oil drain pan and funnel
   - Filter wrench
   - Brake tools (C-clamp or piston tool)
   - Fluid containers and funnels
   - Battery terminal cleaner
   - Spark plug socket and gap tool

4. **WEIGHT-CONSCIOUS SHOPPING LIST** (Canadian Suppliers):
   
   For each recommended item:
   - Tool name and spec (be specific: "3/8\" socket set, metric, 10-19mm")
   - Why needed (specific scenario: "Roadside belt replacement" or "Habitat shelf building")
   - Category (Emergency Roadside / Habitat DIY / Maintenance)
   - Weight consideration (if heavy, justify why essential)
   - Canadian supplier: Canadian Tire, Princess Auto, Home Depot, KMS Tools
   - Canadian price (CAD)
   - Priority: Critical / Important / Nice to Have
   
   **Prioritization:**
   - Critical: Can't do emergency repair or essential habitat work without it
   - Important: Makes common tasks much easier
   - Nice to Have: Useful but can improvise or skip

5. **TOOL REDUNDANCY - REALITY CHECK:**
   
   **Do I need backups?**
   - Critical roadside tools (one broken = stranded): Consider backup
   - Common DIY tools: One is enough, can improvise
   - Heavy tools: Don't duplicate unless essential
   
   **Examples:**
   - Socket wrench: Carry one good ratchet, maybe backup 3/8" drive
   - Screwdrivers: One good multi-bit, not 20 individual drivers
   - Pliers: 2-3 types (needle-nose, regular, vice-grips), not 10
   
   **Weight vs. redundancy balance**

6. **WHAT TO SKIP - LEAVE AT HOME:**
   
   Tools I DON'T need for this expedition:
   - Professional shop equipment (engine hoist, transmission jack, etc.)
   - Specialized tools I'll use once (valve spring compressor, etc.)
   - Duplicates of non-critical tools
   - "Just in case" tools for unlikely scenarios
   
   **Weight saved = more fuel, food, or useful gear**

7. **CONSUMABLES - PRACTICAL QUANTITIES:**
   
   **NOT asking for full shop inventory:**
   - Shop rags: 1 roll (not 20 rolls)
   - Zip ties: 1 bag assorted (not 5 bags)
   - Electrical tape: 2 rolls (not 10)
   - Fuses: Assortment for my vehicle (not every size)
   - Hose clamps: 10-15 various sizes (not 100)
   - Fasteners: Small tackle box assorted (not full bins)
   
   **Goal:** Handle common repairs, not stock a hardware store

8. **CONDITION ASSESSMENT:**
   Flag any tools marked "Needs Replacement" or "Fair" condition.
   Recommend upgrade if critical for roadside repairs.

9. **2003 SIERRA Z71 SPECIFIC:**
   - Metric sockets for engine (10mm, 13mm, 15mm most common)
   - Standard sockets for some chassis (1/2", 9/16", etc.)
   - 15mm for serpentine belt tensioner
   - Torx bits for interior and electronics
   - Any Z71-specific considerations

10. **REALITY CHECK - CANADIAN OVERLANDER:**
    
    **Remember:**
    - You have CAA for major failures
    - Mechanics exist in every town
    - Goal: Handle common issues, limp to help for major ones
    - Habitat work is DIY-friendly (you're building it yourself)
    - Weight matters - smart packing beats carrying everything
    
    **Realistic expectations:**
    âœ… Replace belt roadside
    âœ… Fix coolant hose and drive to town
    âœ… Build habitat shelf at campsite
    âœ… Change oil at campground
    âŒ Rebuild engine in wilderness
    âŒ Replace transmission on trail
    âŒ Professional fabrication work

Focus on PRACTICAL, WEIGHT-CONSCIOUS recommendations for roadside emergency repairs and habitat DIY projects. Don't recommend professional shop tools or "complete self-sufficiency" kits. This is a Canadian overlander with access to CAA and mechanics, not an Antarctic expedition. Prioritize tools that handle common issues and habitat maintenance.`;

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [
                                { role: 'user', content: prompt }
                            ]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        setAiAnalysis(data.content[0].text);
                    } else {
                        throw new Error('Unexpected response format');
                    }
                } catch (error) {
                    console.error('AI Analysis error:', error);
                    setAiAnalysis(`Error analyzing tool kit: ${error.message}\n\nPlease make sure you're connected to the internet and try again.`);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const downloadToolReport = () => {
                const reportData = toolItems.map(item => ({
                    'Tool/Part Name': item.name,
                    'Type': item.subcategory || 'N/A',
                    'Condition': item.toolCondition || 'N/A',
                    'Manufacturer': item.manufacturer || 'N/A',
                    'Compatible With': item.compatibleWith || 'N/A',
                    'Location': item.location || 'N/A',
                    'Cost': item.actualCost ? `Â£${item.actualCost}` : 'N/A',
                    'Description': item.description || ''
                }));

                const csv = [
                    Object.keys(reportData[0] || {}).join(','),
                    ...reportData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tools-equipment-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <>
                    <div className="mb-6 flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900 flex items-center space-x-2">
                                <span>ğŸ”§</span>
                                <span>Tools & Equipment</span>
                            </h2>
                            <p className="text-gray-600 mt-1">Vehicle and habitat maintenance toolkit</p>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={analyzeToolKit}
                                disabled={isAnalyzing || toolItems.length === 0}
                                className="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isAnalyzing ? (
                                    <>
                                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Analyzing...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        <span>ğŸ¤– AI Assistant</span>
                                    </>
                                )}
                            </button>
                            <button
                                onClick={downloadToolReport}
                                className="px-6 py-3 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 transition flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span>Download Report</span>
                            </button>
                        </div>
                    </div>

                    {/* AI Analysis Panel */}
                    {showAIAnalysis && (
                        <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg border-2 border-purple-300 overflow-hidden">
                            <div className="bg-purple-600 px-6 py-4 flex justify-between items-center">
                                <h3 className="font-bold text-white flex items-center space-x-2">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                    <span>AI Tool Kit Analysis</span>
                                </h3>
                                <button
                                    onClick={() => setShowAIAnalysis(false)}
                                    className="text-white hover:text-purple-200 transition"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="p-6 max-h-96 overflow-y-auto">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center py-12">
                                        <svg className="animate-spin h-12 w-12 text-purple-600 mb-4" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p className="text-gray-600 font-medium">Analyzing your tool kit...</p>
                                        <p className="text-sm text-gray-500 mt-2">Claude is reviewing your inventory and preparing recommendations</p>
                                    </div>
                                ) : aiAnalysis ? (
                                    <div className="prose prose-sm max-w-none">
                                        <div className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                                            {aiAnalysis}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12 text-gray-500">
                                        <p>Click "AI Assistant" to analyze your tool kit</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-orange-500">
                            <div className="text-3xl font-bold text-orange-600">{toolItems.length}</div>
                            <div className="text-gray-600 mt-1">Total Tools/Parts</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                            <div className="text-3xl font-bold text-green-600">
                                {toolItems.filter(i => i.toolCondition === 'New' || i.toolCondition === 'Good').length}
                            </div>
                            <div className="text-gray-600 mt-1">Good Condition</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                            <div className="text-3xl font-bold text-yellow-600">
                                {toolItems.filter(i => i.toolCondition === 'Fair').length}
                            </div>
                            <div className="text-gray-600 mt-1">Fair Condition</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-500">
                            <div className="text-3xl font-bold text-red-600">
                                {toolItems.filter(i => i.toolCondition === 'Needs Replacement').length}
                            </div>
                            <div className="text-gray-600 mt-1">âš ï¸ Needs Replacement</div>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex space-x-2 mb-6 border-b">
                        <button
                            onClick={() => setSelectedTab('overview')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'overview'
                                    ? 'border-b-3 border-orange-600 text-orange-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Overview
                        </button>
                        <button
                            onClick={() => setSelectedTab('condition')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'condition'
                                    ? 'border-b-3 border-orange-600 text-orange-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            By Condition
                        </button>
                        <button
                            onClick={() => setSelectedTab('system')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'system'
                                    ? 'border-b-3 border-orange-600 text-orange-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            By System
                        </button>
                    </div>

                    {/* Tab Content */}
                    {selectedTab === 'overview' && (
                        <div className="space-y-6">
                            {TOOLS_SUBCATEGORIES.filter(sub => sub !== 'Other').map(subcategory => {
                                const items = toolItems.filter(i => i.subcategory === subcategory);
                                if (items.length === 0) return null;
                                
                                return (
                                    <div key={subcategory} className="bg-white rounded-xl shadow-md overflow-hidden">
                                        <div className="bg-orange-50 px-6 py-4 border-b border-orange-100">
                                            <h3 className="font-bold text-gray-900">{subcategory} ({items.length})</h3>
                                        </div>
                                        <div className="p-6">
                                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {items.map(item => (
                                                    <div key={item.id} className="border rounded-lg p-4 hover:shadow-md transition">
                                                        <div className="font-semibold text-gray-900">{item.name}</div>
                                                        {item.manufacturer && (
                                                            <div className="text-xs text-gray-600 mt-1">{item.manufacturer}</div>
                                                        )}
                                                        {item.toolCondition && (
                                                            <div className={`text-xs font-medium mt-2 ${
                                                                item.toolCondition === 'New' || item.toolCondition === 'Good' ? 'text-green-600'
                                                                : item.toolCondition === 'Fair' ? 'text-yellow-600'
                                                                : item.toolCondition === 'Needs Replacement' ? 'text-red-600'
                                                                : 'text-blue-600'
                                                            }`}>
                                                                Condition: {item.toolCondition}
                                                            </div>
                                                        )}
                                                        {item.compatibleWith && (
                                                            <div className="text-xs text-purple-600 mt-1">
                                                                ğŸ”§ For: {item.compatibleWith}
                                                            </div>
                                                        )}
                                                        {item.location && (
                                                            <div className="text-xs text-gray-500 mt-1">ğŸ“ {item.location}</div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {selectedTab === 'condition' && (
                        <div className="space-y-6">
                            {/* Needs Replacement */}
                            {toolItems.filter(i => i.toolCondition === 'Needs Replacement').length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-red-500">
                                    <div className="bg-red-100 px-6 py-4 border-b border-red-200">
                                        <h3 className="font-bold text-red-900 flex items-center space-x-2">
                                            <span>âš ï¸</span>
                                            <span>Needs Replacement ({toolItems.filter(i => i.toolCondition === 'Needs Replacement').length})</span>
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="space-y-3">
                                            {toolItems.filter(i => i.toolCondition === 'Needs Replacement').map(item => (
                                                <div key={item.id} className="border-2 border-red-300 rounded-lg p-4 bg-red-50">
                                                    <div className="font-bold text-gray-900">{item.name}</div>
                                                    <div className="text-sm text-gray-600">{item.subcategory}</div>
                                                    {item.compatibleWith && (
                                                        <div className="text-sm text-purple-600">For: {item.compatibleWith}</div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Fair Condition */}
                            {toolItems.filter(i => i.toolCondition === 'Fair').length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-yellow-400">
                                    <div className="bg-yellow-50 px-6 py-4 border-b border-yellow-200">
                                        <h3 className="font-bold text-yellow-900">Fair Condition ({toolItems.filter(i => i.toolCondition === 'Fair').length})</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid md:grid-cols-2 gap-3">
                                            {toolItems.filter(i => i.toolCondition === 'Fair').map(item => (
                                                <div key={item.id} className="border rounded-lg p-3">
                                                    <div className="font-semibold text-gray-900">{item.name}</div>
                                                    <div className="text-xs text-gray-600">{item.subcategory}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Good Condition */}
                            {toolItems.filter(i => i.toolCondition === 'Good' || i.toolCondition === 'New').length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                    <div className="bg-green-50 px-6 py-4 border-b border-green-200">
                                        <h3 className="font-bold text-green-900">Good Condition ({toolItems.filter(i => i.toolCondition === 'Good' || i.toolCondition === 'New').length})</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid md:grid-cols-3 gap-3">
                                            {toolItems.filter(i => i.toolCondition === 'Good' || i.toolCondition === 'New').map(item => (
                                                <div key={item.id} className="border rounded-lg p-2">
                                                    <div className="text-sm font-medium text-gray-900">{item.name}</div>
                                                    <div className="text-xs text-gray-500">{item.subcategory}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {selectedTab === 'system' && (
                        <div className="space-y-6">
                            {[...new Set(toolItems.filter(i => i.compatibleWith).map(i => i.compatibleWith))].map(system => {
                                const items = toolItems.filter(i => i.compatibleWith === system);
                                
                                return (
                                    <div key={system} className="bg-white rounded-xl shadow-md overflow-hidden">
                                        <div className="bg-purple-50 px-6 py-4 border-b border-purple-200">
                                            <h3 className="font-bold text-gray-900 flex items-center space-x-2">
                                                <span>ğŸ”§</span>
                                                <span>{system} ({items.length} items)</span>
                                            </h3>
                                        </div>
                                        <div className="p-6">
                                            <div className="space-y-3">
                                                {items.map(item => (
                                                    <div key={item.id} className="border rounded-lg p-4">
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <div className="font-semibold text-gray-900">{item.name}</div>
                                                                <div className="text-sm text-gray-600">{item.subcategory}</div>
                                                                {item.description && (
                                                                    <div className="text-sm text-gray-500 mt-1">{item.description}</div>
                                                                )}
                                                            </div>
                                                            <div className={`text-xs font-medium px-2 py-1 rounded ${
                                                                item.toolCondition === 'New' || item.toolCondition === 'Good' ? 'bg-green-100 text-green-700'
                                                                : item.toolCondition === 'Fair' ? 'bg-yellow-100 text-yellow-700'
                                                                : 'bg-red-100 text-red-700'
                                                            }`}>
                                                                {item.toolCondition}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            
                            {toolItems.filter(i => !i.compatibleWith).length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                    <div className="bg-gray-50 px-6 py-4 border-b border-gray-200">
                                        <h3 className="font-bold text-gray-900">General Tools ({toolItems.filter(i => !i.compatibleWith).length})</h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid md:grid-cols-3 gap-3">
                                            {toolItems.filter(i => !i.compatibleWith).map(item => (
                                                <div key={item.id} className="border rounded-lg p-3">
                                                    <div className="font-medium text-gray-900">{item.name}</div>
                                                    <div className="text-xs text-gray-600">{item.subcategory}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </>
            );
        }

        function FirstAidView({ items }) {
            const [selectedTab, setSelectedTab] = useState('overview');
            const [showAIAnalysis, setShowAIAnalysis] = useState(false);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            
            const firstAidItems = items.filter(i => i.category === 'First Aid');
            const medications = firstAidItems.filter(i => i.medicationExpiry);
            const personalMeds = medications.filter(i => i.medicationFor && i.medicationFor !== 'General/Shared');
            
            const medicationsByPerson = {
                'Sonia': medications.filter(i => i.medicationFor === 'Sonia'),
                'Amanda': medications.filter(i => i.medicationFor === 'Amanda'),
                'Guest': medications.filter(i => i.medicationFor === 'Guest'),
                'General/Shared': medications.filter(i => !i.medicationFor || i.medicationFor === 'General/Shared')
            };

            const expiredMeds = medications.filter(i => new Date(i.medicationExpiry) < new Date());
            const expiringSoon = medications.filter(i => {
                const expiry = new Date(i.medicationExpiry);
                const now = new Date();
                const ninetyDays = new Date(now.getTime() + 90*24*60*60*1000);
                return expiry >= now && expiry < ninetyDays;
            });

            const analyzeFirstAidKit = async () => {
                setIsAnalyzing(true);
                setShowAIAnalysis(true);
                
                try {
                    // Prepare inventory summary for Claude
                    const inventorySummary = {
                        totalItems: firstAidItems.length,
                        bySubcategory: {},
                        medications: medications.map(m => ({
                            name: m.name,
                            type: m.subcategory,
                            for: m.medicationFor,
                            expiry: m.medicationExpiry,
                            expired: new Date(m.medicationExpiry) < new Date()
                        })),
                        nonMedications: firstAidItems.filter(i => !i.medicationExpiry).map(i => ({
                            name: i.name,
                            type: i.subcategory
                        }))
                    };

                    // Count items by subcategory
                    firstAidItems.forEach(item => {
                        const subcat = item.subcategory || 'Other';
                        inventorySummary.bySubcategory[subcat] = (inventorySummary.bySubcategory[subcat] || 0) + 1;
                    });

                    const prompt = `You are a wilderness first aid and overland travel medical expert. I'm going on an overland adventure and need help analyzing my first aid kit.

Here's my current inventory:

SUMMARY:
- Total first aid items: ${inventorySummary.totalItems}
- Items by category: ${JSON.stringify(inventorySummary.bySubcategory, null, 2)}

MEDICATIONS (${inventorySummary.medications.length} items):
${inventorySummary.medications.map(m => `- ${m.name} (${m.type}) - For: ${m.for || 'General'} - Expires: ${m.expiry} ${m.expired ? 'âš ï¸ EXPIRED' : ''}`).join('\n')}

OTHER FIRST AID ITEMS (${inventorySummary.nonMedications.length} items):
${inventorySummary.nonMedications.map(i => `- ${i.name} (${i.type})`).join('\n')}

Please analyze my first aid kit and provide:

1. **Critical Gaps**: What essential items am I missing for overland travel? Prioritize life-saving and serious injury treatment items.

2. **Medication Recommendations**: Based on what I have, what medications should I add? Consider:
   - Pain management (different types)
   - Infection prevention and treatment
   - Allergic reactions
   - Gastrointestinal issues (common in travel)
   - Any expired medications that need replacing

3. **Supplies to Add**: What bandages, tools, or other supplies am I lacking?

4. **Shopping List**: Create a prioritized shopping list with:
   - Item name
   - Why it's needed
   - Where to buy (pharmacy, outdoor store, online, prescription needed)
   - Approximate UK price if known

5. **Border Crossing Notes**: Any items that might need special documentation for international travel?

Please be specific and practical. Focus on items suitable for extended overland travel in remote areas.`;

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [
                                { role: 'user', content: prompt }
                            ]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.content && data.content[0] && data.content[0].text) {
                        setAiAnalysis(data.content[0].text);
                    } else {
                        throw new Error('Unexpected response format');
                    }
                } catch (error) {
                    console.error('AI Analysis error:', error);
                    setAiAnalysis(`Error analyzing first aid kit: ${error.message}\n\nPlease make sure you're connected to the internet and try again.`);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const downloadMedicationReport = () => {
                const reportData = medications.map(item => ({
                    'Medication Name': item.name,
                    'For Person': item.medicationFor || 'General/Shared',
                    'Prescribing Doctor': item.prescribingDoctor || 'N/A',
                    'Expiry Date': item.medicationExpiry,
                    'Status': new Date(item.medicationExpiry) < new Date() ? 'EXPIRED' : 'Valid',
                    'Days Until Expiry': Math.floor((new Date(item.medicationExpiry) - new Date()) / (1000*60*60*24)),
                    'Type': item.subcategory || 'N/A',
                    'Manufacturer': item.manufacturer || 'N/A',
                    'Location': item.location || 'N/A',
                    'Description': item.description || ''
                }));

                const csv = [
                    Object.keys(reportData[0] || {}).join(','),
                    ...reportData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `first-aid-medications-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <>
                    <div className="mb-6 flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900 flex items-center space-x-2">
                                <span>ğŸ¥</span>
                                <span>First Aid & Medications</span>
                            </h2>
                            <p className="text-gray-600 mt-1">Track medical supplies and medication expiry dates</p>
                        </div>
                        <div className="flex gap-3">
                            <button
                                onClick={analyzeFirstAidKit}
                                disabled={isAnalyzing || firstAidItems.length === 0}
                                className="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isAnalyzing ? (
                                    <>
                                        <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Analyzing...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        <span>ğŸ¤– AI Assistant</span>
                                    </>
                                )}
                            </button>
                            <button
                                onClick={downloadMedicationReport}
                                className="px-6 py-3 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition flex items-center space-x-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                <span>Download Report</span>
                            </button>
                        </div>
                    </div>

                    {/* AI Analysis Panel */}
                    {showAIAnalysis && (
                        <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg border-2 border-purple-300 overflow-hidden">
                            <div className="bg-purple-600 px-6 py-4 flex justify-between items-center">
                                <h3 className="font-bold text-white flex items-center space-x-2">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                    <span>AI First Aid Kit Analysis</span>
                                </h3>
                                <button
                                    onClick={() => setShowAIAnalysis(false)}
                                    className="text-white hover:text-purple-200 transition"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div className="p-6 max-h-96 overflow-y-auto">
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center justify-center py-12">
                                        <svg className="animate-spin h-12 w-12 text-purple-600 mb-4" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p className="text-gray-600 font-medium">Analyzing your first aid kit...</p>
                                        <p className="text-sm text-gray-500 mt-2">Claude is reviewing your inventory and preparing recommendations</p>
                                    </div>
                                ) : aiAnalysis ? (
                                    <div className="prose prose-sm max-w-none">
                                        <div className="whitespace-pre-wrap text-gray-800 leading-relaxed">
                                            {aiAnalysis}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12 text-gray-500">
                                        <p>Click "AI Assistant" to analyze your first aid kit</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                            <div className="text-3xl font-bold text-blue-600">{firstAidItems.length}</div>
                            <div className="text-gray-600 mt-1">Total First Aid Items</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                            <div className="text-3xl font-bold text-purple-600">{medications.length}</div>
                            <div className="text-gray-600 mt-1">Medications Tracked</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-orange-500">
                            <div className="text-3xl font-bold text-orange-600">{expiringSoon.length}</div>
                            <div className="text-gray-600 mt-1">Expiring in 90 Days</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-red-500">
                            <div className="text-3xl font-bold text-red-600">{expiredMeds.length}</div>
                            <div className="text-gray-600 mt-1">ğŸš¨ Expired Medications</div>
                        </div>
                    </div>

                    {/* Border Crossing Alert */}
                    {personalMeds.length > 0 && (
                        <div className="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6">
                            <div className="flex items-start space-x-3">
                                <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <h3 className="font-bold text-yellow-900">Border Crossing Information</h3>
                                    <p className="text-sm text-yellow-800 mt-1">
                                        You have <strong>{personalMeds.length} personal medication(s)</strong> that must be declared at border crossings. 
                                        Ensure you have prescriptions and documentation for all personal medications.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Tabs */}
                    <div className="flex space-x-2 mb-6 border-b">
                        <button
                            onClick={() => setSelectedTab('overview')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'overview'
                                    ? 'border-b-3 border-red-600 text-red-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Overview
                        </button>
                        <button
                            onClick={() => setSelectedTab('byperson')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'byperson'
                                    ? 'border-b-3 border-red-600 text-red-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            By Person
                        </button>
                        <button
                            onClick={() => setSelectedTab('expiry')}
                            className={`px-6 py-3 font-medium transition ${
                                selectedTab === 'expiry'
                                    ? 'border-b-3 border-red-600 text-red-600'
                                    : 'text-gray-500 hover:text-gray-700'
                            }`}
                        >
                            Expiry Tracking
                        </button>
                    </div>

                    {/* Tab Content */}
                    {selectedTab === 'overview' && (
                        <div className="space-y-6">
                            {FIRST_AID_SUBCATEGORIES.filter(sub => sub !== 'Other').map(subcategory => {
                                const items = firstAidItems.filter(i => i.subcategory === subcategory);
                                if (items.length === 0) return null;
                                
                                return (
                                    <div key={subcategory} className="bg-white rounded-xl shadow-md overflow-hidden">
                                        <div className="bg-red-50 px-6 py-4 border-b border-red-100">
                                            <h3 className="font-bold text-gray-900">{subcategory} ({items.length})</h3>
                                        </div>
                                        <div className="p-6">
                                            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {items.map(item => (
                                                    <div key={item.id} className="border rounded-lg p-4 hover:shadow-md transition">
                                                        <div className="font-semibold text-gray-900">{item.name}</div>
                                                        {item.medicationFor && (
                                                            <div className="text-xs text-purple-600 font-medium mt-1">
                                                                For: {item.medicationFor}
                                                            </div>
                                                        )}
                                                        {item.prescribingDoctor && (
                                                            <div className="text-xs text-indigo-600 font-medium mt-1">
                                                                ğŸ‘¨â€âš•ï¸ Dr: {item.prescribingDoctor}
                                                            </div>
                                                        )}
                                                        {item.medicationExpiry && (
                                                            <div className={`text-xs font-semibold mt-1 ${
                                                                new Date(item.medicationExpiry) < new Date()
                                                                    ? 'text-red-600'
                                                                    : new Date(item.medicationExpiry) < new Date(Date.now() + 90*24*60*60*1000)
                                                                    ? 'text-orange-600'
                                                                    : 'text-green-600'
                                                            }`}>
                                                                Expires: {item.medicationExpiry}
                                                            </div>
                                                        )}
                                                        {item.location && (
                                                            <div className="text-xs text-gray-500 mt-1">ğŸ“ {item.location}</div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {selectedTab === 'byperson' && (
                        <div className="space-y-6">
                            {Object.entries(medicationsByPerson).map(([person, meds]) => {
                                if (meds.length === 0) return null;
                                
                                return (
                                    <div key={person} className="bg-white rounded-xl shadow-md overflow-hidden">
                                        <div className={`px-6 py-4 border-b ${
                                            person === 'General/Shared' 
                                                ? 'bg-gray-50 border-gray-200'
                                                : 'bg-purple-50 border-purple-200'
                                        }`}>
                                            <h3 className="font-bold text-gray-900 flex items-center space-x-2">
                                                <span>ğŸ’Š</span>
                                                <span>{person} ({meds.length} medication{meds.length !== 1 ? 's' : ''})</span>
                                            </h3>
                                            {person !== 'General/Shared' && (
                                                <p className="text-xs text-purple-700 mt-1">âš ï¸ Must be declared at border crossings</p>
                                            )}
                                        </div>
                                        <div className="p-6">
                                            <div className="space-y-3">
                                                {meds.map(item => (
                                                    <div key={item.id} className="border rounded-lg p-4 flex justify-between items-start">
                                                        <div>
                                                            <div className="font-semibold text-gray-900">{item.name}</div>
                                                            {item.manufacturer && (
                                                                <div className="text-sm text-gray-600">by {item.manufacturer}</div>
                                                            )}
                                                            {item.prescribingDoctor && (
                                                                <div className="text-sm text-indigo-600 font-medium mt-1">
                                                                    ğŸ‘¨â€âš•ï¸ Prescribed by: {item.prescribingDoctor}
                                                                </div>
                                                            )}
                                                            {item.description && (
                                                                <div className="text-sm text-gray-500 mt-1">{item.description}</div>
                                                            )}
                                                            {item.location && (
                                                                <div className="text-xs text-gray-500 mt-1">ğŸ“ {item.location}</div>
                                                            )}
                                                        </div>
                                                        <div className="text-right">
                                                            <div className={`text-sm font-bold ${
                                                                new Date(item.medicationExpiry) < new Date()
                                                                    ? 'text-red-600'
                                                                    : new Date(item.medicationExpiry) < new Date(Date.now() + 90*24*60*60*1000)
                                                                    ? 'text-orange-600'
                                                                    : 'text-green-600'
                                                            }`}>
                                                                {new Date(item.medicationExpiry) < new Date() ? 'EXPIRED' : item.medicationExpiry}
                                                            </div>
                                                            <div className="text-xs text-gray-500">
                                                                {Math.floor((new Date(item.medicationExpiry) - new Date()) / (1000*60*60*24))} days
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {selectedTab === 'expiry' && (
                        <div className="space-y-6">
                            {/* Expired */}
                            {expiredMeds.length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-red-500">
                                    <div className="bg-red-100 px-6 py-4 border-b border-red-200">
                                        <h3 className="font-bold text-red-900 flex items-center space-x-2">
                                            <span>ğŸš¨</span>
                                            <span>EXPIRED - Replace Immediately ({expiredMeds.length})</span>
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="space-y-3">
                                            {expiredMeds.map(item => (
                                                <div key={item.id} className="border-2 border-red-300 rounded-lg p-4 bg-red-50">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="font-bold text-gray-900">{item.name}</div>
                                                            <div className="text-sm text-gray-600">For: {item.medicationFor || 'General'}</div>
                                                            {item.prescribingDoctor && (
                                                                <div className="text-sm text-indigo-600 font-medium">
                                                                    ğŸ‘¨â€âš•ï¸ Dr: {item.prescribingDoctor}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-red-700">EXPIRED</div>
                                                            <div className="text-xs text-gray-600">{item.medicationExpiry}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Expiring Soon */}
                            {expiringSoon.length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden border-2 border-orange-400">
                                    <div className="bg-orange-50 px-6 py-4 border-b border-orange-200">
                                        <h3 className="font-bold text-orange-900 flex items-center space-x-2">
                                            <span>âš ï¸</span>
                                            <span>Expiring Within 90 Days ({expiringSoon.length})</span>
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="space-y-3">
                                            {expiringSoon.sort((a, b) => new Date(a.medicationExpiry) - new Date(b.medicationExpiry)).map(item => (
                                                <div key={item.id} className="border-2 border-orange-200 rounded-lg p-4 bg-orange-50">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="font-bold text-gray-900">{item.name}</div>
                                                            <div className="text-sm text-gray-600">For: {item.medicationFor || 'General'}</div>
                                                            {item.prescribingDoctor && (
                                                                <div className="text-sm text-indigo-600 font-medium">
                                                                    ğŸ‘¨â€âš•ï¸ Dr: {item.prescribingDoctor}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-orange-700">{item.medicationExpiry}</div>
                                                            <div className="text-xs text-gray-600">
                                                                {Math.floor((new Date(item.medicationExpiry) - new Date()) / (1000*60*60*24))} days left
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Valid Medications */}
                            {medications.filter(i => 
                                new Date(i.medicationExpiry) >= new Date(Date.now() + 90*24*60*60*1000)
                            ).length > 0 && (
                                <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                    <div className="bg-green-50 px-6 py-4 border-b border-green-200">
                                        <h3 className="font-bold text-green-900 flex items-center space-x-2">
                                            <span>âœ“</span>
                                            <span>Valid Medications (90+ days remaining)</span>
                                        </h3>
                                    </div>
                                    <div className="p-6">
                                        <div className="grid md:grid-cols-2 gap-3">
                                            {medications
                                                .filter(i => new Date(i.medicationExpiry) >= new Date(Date.now() + 90*24*60*60*1000))
                                                .map(item => (
                                                <div key={item.id} className="border rounded-lg p-3">
                                                    <div className="font-semibold text-gray-900">{item.name}</div>
                                                    <div className="text-xs text-gray-600">For: {item.medicationFor || 'General'}</div>
                                                    <div className="text-xs text-green-600 mt-1">Expires: {item.medicationExpiry}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </>
            );
        }

        function InsuranceReportView({ items }) {
            const ownedItems = items.filter(i => i.ownership === 'Owned');
            const itemsWithCost = ownedItems.filter(i => i.actualCost);
            const itemsWithReceipt = ownedItems.filter(i => i.receipt);
            const totalValue = itemsWithCost.reduce((sum, i) => sum + parseFloat(i.actualCost || 0), 0);

            const downloadReport = () => {
                const reportData = ownedItems.map(item => ({
                    Name: item.name,
                    Owner: item.owner || 'N/A',
                    Manufacturer: item.manufacturer || 'N/A',
                    Category: item.category,
                    Subcategory: item.subcategory || 'N/A',
                    'Medication For': item.medicationFor || 'N/A',
                    'Prescribing Doctor': item.prescribingDoctor || 'N/A',
                    'Medication Expiry': item.medicationExpiry || 'N/A',
                    Location: item.location || 'N/A',
                    Mobility: item.mobility || 'N/A',
                    'Has Warranty': item.hasWarranty || 'N/A',
                    'Warranty Expiry': item.warrantyExpiry || 'N/A',
                    Cost: item.actualCost ? `${getCurrencySymbol(item.currency || 'GBP (Â£)')}${item.actualCost}` : 'N/A',
                    Currency: item.currency || 'GBP (Â£)',
                    'Purchase Date': item.purchaseDate || 'N/A',
                    Weight: item.weight ? `${item.weight} ${item.weightUnit || 'kg'}` : 'N/A',
                    'Product URL': item.productUrl || 'N/A',
                    'Receipt Uploaded': item.receipt ? 'Yes' : 'No',
                    Description: item.description || ''
                }));

                const csv = [
                    Object.keys(reportData[0] || {}).join(','),
                    ...reportData.map(row => Object.values(row).map(v => `"${v}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `overland-gear-insurance-report-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            return (
                <>
                    <div className="mb-6 flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-900">Insurance Report</h2>
                            <p className="text-gray-600 mt-1">Documentation for insurance purposes</p>
                        </div>
                        <button
                            onClick={downloadReport}
                            className="px-6 py-3 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 transition flex items-center space-x-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span>Download CSV</span>
                        </button>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <div className="text-3xl font-bold text-emerald-600">Â£{totalValue.toFixed(2)}</div>
                            <div className="text-gray-600 mt-1">Total Insured Value</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <div className="text-3xl font-bold text-blue-600">{ownedItems.length}</div>
                            <div className="text-gray-600 mt-1">Owned Items</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <div className="text-3xl font-bold text-green-600">{itemsWithCost.length}</div>
                            <div className="text-gray-600 mt-1">Items with Cost</div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <div className="text-3xl font-bold text-purple-600">{itemsWithReceipt.length}</div>
                            <div className="text-gray-600 mt-1">Receipts Uploaded</div>
                        </div>
                    </div>

                    {/* Warranty Summary */}
                    <div className="grid md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <div className="text-2xl font-bold text-blue-700">
                                {ownedItems.filter(i => i.hasWarranty === 'Yes').length}
                            </div>
                            <div className="text-gray-700 text-sm mt-1">Items Under Warranty</div>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <div className="text-2xl font-bold text-orange-700">
                                {ownedItems.filter(i => 
                                    i.hasWarranty === 'Yes' && 
                                    i.warrantyExpiry && 
                                    new Date(i.warrantyExpiry) >= new Date() &&
                                    new Date(i.warrantyExpiry) < new Date(Date.now() + 30*24*60*60*1000)
                                ).length}
                            </div>
                            <div className="text-gray-700 text-sm mt-1">Expiring Soon (30 days)</div>
                        </div>
                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                            <div className="text-2xl font-bold text-red-700">
                                {ownedItems.filter(i => 
                                    i.hasWarranty === 'Yes' && 
                                    i.warrantyExpiry && 
                                    new Date(i.warrantyExpiry) < new Date()
                                ).length}
                            </div>
                            <div className="text-gray-700 text-sm mt-1">Warranties Expired</div>
                        </div>
                    </div>

                    {/* Medication Summary */}
                    {ownedItems.some(i => i.medicationExpiry) && (
                        <div className="bg-purple-50 p-4 rounded-lg border-2 border-purple-300 mb-6">
                            <h3 className="text-lg font-bold text-purple-900 mb-3 flex items-center space-x-2">
                                <span>ğŸ’Š</span>
                                <span>Medication Tracking</span>
                            </h3>
                            <div className="grid md:grid-cols-4 gap-4">
                                <div className="bg-white p-3 rounded-lg">
                                    <div className="text-2xl font-bold text-green-700">
                                        {ownedItems.filter(i => i.medicationExpiry && new Date(i.medicationExpiry) >= new Date()).length}
                                    </div>
                                    <div className="text-gray-700 text-xs mt-1">Valid Medications</div>
                                </div>
                                <div className="bg-white p-3 rounded-lg">
                                    <div className="text-2xl font-bold text-orange-700">
                                        {ownedItems.filter(i => 
                                            i.medicationExpiry && 
                                            new Date(i.medicationExpiry) >= new Date() &&
                                            new Date(i.medicationExpiry) < new Date(Date.now() + 90*24*60*60*1000)
                                        ).length}
                                    </div>
                                    <div className="text-gray-700 text-xs mt-1">Expiring in 90 Days</div>
                                </div>
                                <div className="bg-white p-3 rounded-lg">
                                    <div className="text-2xl font-bold text-red-700">
                                        {ownedItems.filter(i => i.medicationExpiry && new Date(i.medicationExpiry) < new Date()).length}
                                    </div>
                                    <div className="text-gray-700 text-xs mt-1">ğŸš¨ EXPIRED</div>
                                </div>
                                <div className="bg-white p-3 rounded-lg">
                                    <div className="text-2xl font-bold text-purple-700">
                                        {ownedItems.filter(i => i.medicationFor && i.medicationFor !== 'General/Shared').length}
                                    </div>
                                    <div className="text-gray-700 text-xs mt-1">Personal Medications</div>
                                </div>
                            </div>
                            <p className="text-xs text-purple-800 mt-3 font-medium">
                                âš ï¸ Personal medications must be declared at border crossings
                            </p>
                        </div>
                    )}

                    {/* Items Table */}
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manufacturer</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mobility</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Warranty</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Link</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receipt</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {ownedItems.length === 0 ? (
                                        <tr>
                                            <td colSpan="12" className="px-6 py-12 text-center text-gray-500">
                                                No owned items yet
                                            </td>
                                        </tr>
                                    ) : (
                                        ownedItems.map(item => (
                                            <tr key={item.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4">
                                                    <div className="font-medium text-gray-900">{item.name}</div>
                                                    {item.description && (
                                                        <div className="text-sm text-gray-500">{item.description}</div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {item.owner || '-'}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {item.manufacturer || '-'}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {item.location || '-'}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {item.mobility || '-'}
                                                </td>
                                                <td className="px-6 py-4 text-sm">
                                                    {item.hasWarranty === 'Yes' ? (
                                                        <div>
                                                            <div className={`font-medium ${
                                                                item.warrantyExpiry && new Date(item.warrantyExpiry) < new Date()
                                                                    ? 'text-red-600'
                                                                    : 'text-green-600'
                                                            }`}>
                                                                {item.warrantyExpiry && new Date(item.warrantyExpiry) < new Date() 
                                                                    ? 'Expired' 
                                                                    : 'Active'
                                                                }
                                                            </div>
                                                            {item.warrantyExpiry && (
                                                                <div className="text-xs text-gray-500">Until {item.warrantyExpiry}</div>
                                                            )}
                                                        </div>
                                                    ) : (
                                                        <span className="text-gray-400">No warranty</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">{item.category}</td>
                                                <td className="px-6 py-4">
                                                    {item.actualCost ? (
                                                        <span className="font-semibold text-emerald-600">
                                                            {getCurrencySymbol(item.currency || 'GBP (Â£)')}{item.actualCost}
                                                        </span>
                                                    ) : (
                                                        <span className="text-gray-400">Not set</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {item.purchaseDate || '-'}
                                                </td>
                                                <td className="px-6 py-4">
                                                    {item.productUrl ? (
                                                        <a
                                                            href={item.productUrl}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="text-indigo-600 hover:text-indigo-800 flex items-center space-x-1"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                            </svg>
                                                            <span>View</span>
                                                        </a>
                                                    ) : (
                                                        <span className="text-gray-400">None</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4">
                                                    {item.receipt ? (
                                                        <a
                                                            href={item.receipt}
                                                            download={`${item.name}-receipt`}
                                                            className="text-blue-600 hover:text-blue-800 flex items-center space-x-1"
                                                        >
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                            </svg>
                                                            <span>View</span>
                                                        </a>
                                                    ) : (
                                                        <span className="text-gray-400">None</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4">
                                                    {item.image ? (
                                                        <img src={item.image} alt={item.name} className="w-16 h-16 object-cover rounded" />
                                                    ) : (
                                                        <div className="w-16 h-16 bg-gray-100 rounded flex items-center justify-center">
                                                            <svg className="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                            </svg>
                                                        </div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            );
        }

        function PackingListsView({ packingLists, items, onAddList, onDeleteList, onUpdateList }) {
            return (
                <>
                    <div className="mb-6 flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">Packing Lists</h2>
                        <button
                            onClick={onAddList}
                            className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition flex items-center space-x-2"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            <span>New List</span>
                        </button>
                    </div>

                    {packingLists.length === 0 ? (
                        <div className="text-center py-16 bg-white rounded-xl">
                            <svg className="w-20 h-20 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3 className="text-xl font-semibold text-gray-700 mb-2">No packing lists yet</h3>
                            <p className="text-gray-500 mb-4">Create custom lists for different adventures</p>
                            <button
                                onClick={onAddList}
                                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                            >
                                Create Your First List
                            </button>
                        </div>
                    ) : (
                        <div className="grid gap-6">
                            {packingLists.map(list => (
                                <PackingListCard
                                    key={list.id}
                                    list={list}
                                    items={items}
                                    onDelete={onDeleteList}
                                    onUpdate={onUpdateList}
                                />
                            ))}
                        </div>
                    )}
                </>
            );
        }

        function PackingListCard({ list, items, onDelete, onUpdate }) {
            const [expanded, setExpanded] = useState(false);
            const listItems = items.filter(item => list.itemIds.includes(item.id));
            const totalWeight = listItems.reduce((sum, item) => {
                const weight = parseFloat(item.weight) || 0;
                return sum + weight;
            }, 0);

            const toggleItem = (itemId) => {
                const newChecked = list.checkedItems?.includes(itemId)
                    ? list.checkedItems.filter(id => id !== itemId)
                    : [...(list.checkedItems || []), itemId];
                onUpdate({ ...list, checkedItems: newChecked });
            };

            const checkedCount = list.checkedItems?.length || 0;

            return (
                <div className="bg-white rounded-xl shadow-md overflow-hidden">
                    <div
                        className="p-6 cursor-pointer hover:bg-gray-50 transition"
                        onClick={() => setExpanded(!expanded)}
                    >
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <h3 className="text-xl font-semibold text-gray-900 mb-1">{list.name}</h3>
                                {list.description && (
                                    <p className="text-gray-600 text-sm mb-2">{list.description}</p>
                                )}
                                <div className="flex items-center space-x-4 text-sm text-gray-500">
                                    <span>{listItems.length} items</span>
                                    <span>â€¢</span>
                                    <span>{checkedCount}/{listItems.length} packed</span>
                                    {totalWeight > 0 && (
                                        <>
                                            <span>â€¢</span>
                                            <span>{totalWeight.toFixed(1)} kg total</span>
                                        </>
                                    )}
                                </div>
                            </div>
                            <div className="flex items-center space-x-2">
                                <button
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        onDelete(list.id);
                                    }}
                                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                                <svg
                                    className={`w-6 h-6 text-gray-400 transition-transform ${expanded ? 'rotate-180' : ''}`}
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>

                        {/* Progress bar */}
                        <div className="mt-4 bg-gray-200 rounded-full h-2">
                            <div
                                className="bg-green-500 h-2 rounded-full transition-all"
                                style={{ width: `${listItems.length > 0 ? (checkedCount / listItems.length) * 100 : 0}%` }}
                            />
                        </div>
                    </div>

                    {expanded && (
                        <div className="border-t px-6 py-4 bg-gray-50">
                            <div className="space-y-2">
                                {listItems.map(item => (
                                    <label
                                        key={item.id}
                                        className="flex items-center space-x-3 p-3 bg-white rounded-lg hover:bg-gray-50 cursor-pointer"
                                    >
                                        <input
                                            type="checkbox"
                                            checked={list.checkedItems?.includes(item.id)}
                                            onChange={() => toggleItem(item.id)}
                                            className="w-5 h-5 text-blue-600 rounded"
                                        />
                                        <div className="flex-1">
                                            <div className={`font-medium ${list.checkedItems?.includes(item.id) ? 'line-through text-gray-400' : 'text-gray-900'}`}>
                                                {item.name}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                {item.category}
                                                {item.weight && ` â€¢ ${item.weight}`}
                                            </div>
                                        </div>
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function WeightMonitorModal({ items, vehicleBaseWeight, setVehicleBaseWeight, onClose }) {
            // Calculate total weight
            const calculateTotalWeight = () => {
                const gearWeight = items.reduce((total, item) => {
                    if (!item.weight || !item.weightUnit) return total;
                    const weight = parseFloat(item.weight);
                    
                    // Convert to kg
                    let weightInKg = weight;
                    if (item.weightUnit === 'lb') weightInKg = weight * 0.453592;
                    else if (item.weightUnit === 'oz') weightInKg = weight * 0.0283495;
                    else if (item.weightUnit === 'g') weightInKg = weight * 0.001;
                    
                    return total + weightInKg;
                }, 0);
                
                return gearWeight;
            };

            const gearWeight = calculateTotalWeight();
            const totalWeight = vehicleBaseWeight + gearWeight;
            const recommendedMinRecoveryRating = totalWeight * 3; // 3x weight rule

            // Find under-rated recovery items
            const recoveryItems = items.filter(i => i.category === 'Recovery & Trail Assistance');
            const underRatedItems = recoveryItems.filter(item => {
                if (!item.recoveryRating) return true; // No rating = under-rated
                
                // Extract max kg from rating
                const rating = item.recoveryRating;
                if (rating.includes('< 2,000')) return true;
                if (rating.includes('2,000 - 3,500') && recommendedMinRecoveryRating > 3500) return true;
                if (rating.includes('3,500 - 5,000') && recommendedMinRecoveryRating > 5000) return true;
                if (rating.includes('5,000 - 7,000') && recommendedMinRecoveryRating > 7000) return true;
                
                return false;
            });

            // Weight breakdown by location
            const weightByLocation = {};
            items.forEach(item => {
                if (!item.weight || !item.location) return;
                
                const weight = parseFloat(item.weight);
                let weightInKg = weight;
                if (item.weightUnit === 'lb') weightInKg = weight * 0.453592;
                else if (item.weightUnit === 'oz') weightInKg = weight * 0.0283495;
                else if (item.weightUnit === 'g') weightInKg = weight * 0.001;
                
                const location = item.location;
                weightByLocation[location] = (weightByLocation[location] || 0) + weightInKg;
            });

            // Weight breakdown by category
            const weightByCategory = {};
            items.forEach(item => {
                if (!item.weight || !item.category) return;
                
                const weight = parseFloat(item.weight);
                let weightInKg = weight;
                if (item.weightUnit === 'lb') weightInKg = weight * 0.453592;
                else if (item.weightUnit === 'oz') weightInKg = weight * 0.0283495;
                else if (item.weightUnit === 'g') weightInKg = weight * 0.001;
                
                const category = item.category;
                weightByCategory[category] = (weightByCategory[category] || 0) + weightInKg;
            });

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full my-8">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-indigo-600 to-blue-600 px-8 py-6 rounded-t-2xl">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold text-white flex items-center space-x-2">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                                        </svg>
                                        <span>Weight Monitoring System</span>
                                    </h2>
                                    <p className="text-indigo-100 mt-1 text-sm">Track total weight and recovery gear requirements</p>
                                </div>
                                <button
                                    onClick={onClose}
                                    className="text-white hover:text-indigo-200 transition"
                                >
                                    <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-8 space-y-6 max-h-[70vh] overflow-y-auto">
                            {/* Vehicle Base Weight Settings */}
                            <div className="bg-gray-50 p-6 rounded-xl border-2 border-gray-200">
                                <h3 className="font-bold text-gray-900 mb-4 flex items-center space-x-2">
                                    <span>ğŸš™</span>
                                    <span>Vehicle Base Weight Configuration</span>
                                </h3>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Vehicle Base Weight (empty, no gear)
                                        </label>
                                        <div className="flex items-center space-x-3">
                                            <input
                                                type="number"
                                                value={vehicleBaseWeight}
                                                onChange={(e) => setVehicleBaseWeight(parseFloat(e.target.value) || 0)}
                                                className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                                min="0"
                                                step="10"
                                            />
                                            <span className="text-gray-600 font-medium">kg</span>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-2">
                                            2003 GMC Sierra 1500 Z71 Extended Cab typical weight: ~2,100 kg
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Weight Summary Dashboard */}
                            <div className="grid md:grid-cols-3 gap-4">
                                <div className="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
                                    <div className="text-sm text-blue-600 font-medium mb-1">Vehicle Base</div>
                                    <div className="text-3xl font-bold text-blue-900">{vehicleBaseWeight.toLocaleString()}</div>
                                    <div className="text-sm text-blue-600">kg</div>
                                </div>
                                <div className="bg-green-50 p-6 rounded-xl border-2 border-green-200">
                                    <div className="text-sm text-green-600 font-medium mb-1">Gear Weight</div>
                                    <div className="text-3xl font-bold text-green-900">{gearWeight.toFixed(1)}</div>
                                    <div className="text-sm text-green-600">kg</div>
                                </div>
                                <div className="bg-purple-50 p-6 rounded-xl border-2 border-purple-200">
                                    <div className="text-sm text-purple-600 font-medium mb-1">Total Expedition Weight</div>
                                    <div className="text-3xl font-bold text-purple-900">{totalWeight.toFixed(1)}</div>
                                    <div className="text-sm text-purple-600">kg</div>
                                </div>
                            </div>

                            {/* Recovery Gear Requirements */}
                            <div className="bg-gradient-to-r from-orange-50 to-red-50 p-6 rounded-xl border-2 border-orange-300">
                                <h3 className="font-bold text-orange-900 mb-3 flex items-center space-x-2">
                                    <span>ğŸ”—</span>
                                    <span>Recovery Gear Requirements</span>
                                </h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-700">Minimum Recovery Rating (3x weight):</span>
                                        <span className="text-2xl font-bold text-orange-600">{recommendedMinRecoveryRating.toFixed(0)} kg</span>
                                    </div>
                                    <div className="text-sm text-gray-600 bg-white p-3 rounded border border-orange-200">
                                        <strong>Rule:</strong> Recovery gear should be rated at minimum 3x your total loaded vehicle weight for safe operations.
                                    </div>
                                </div>
                            </div>

                            {/* Under-Rated Recovery Items Alert */}
                            {underRatedItems.length > 0 && (
                                <div className="bg-red-50 p-6 rounded-xl border-2 border-red-400">
                                    <div className="flex items-start space-x-3">
                                        <svg className="w-8 h-8 text-red-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-red-900 text-lg mb-2">
                                                âš ï¸ {underRatedItems.length} Recovery Item{underRatedItems.length > 1 ? 's' : ''} Under-Rated!
                                            </h3>
                                            <p className="text-red-800 mb-3">
                                                The following recovery gear is NOT rated for your current expedition weight of {totalWeight.toFixed(0)} kg:
                                            </p>
                                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                                {underRatedItems.map(item => (
                                                    <div key={item.id} className="bg-white p-3 rounded border-2 border-red-300">
                                                        <div className="font-semibold text-gray-900">{item.name}</div>
                                                        <div className="text-sm text-gray-600">{item.subcategory}</div>
                                                        <div className="text-sm text-red-600 font-medium mt-1">
                                                            Current rating: {item.recoveryRating || 'Not specified'} 
                                                            <span className="ml-2">â†’ Need: â‰¥{recommendedMinRecoveryRating.toFixed(0)} kg</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="mt-4 bg-red-100 p-3 rounded border border-red-300">
                                                <p className="text-sm text-red-900 font-medium">
                                                    âš ï¸ <strong>Action Required:</strong> Upgrade these items or reduce gear weight before expedition. Using under-rated recovery gear is dangerous!
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {underRatedItems.length === 0 && recoveryItems.length > 0 && (
                                <div className="bg-green-50 p-6 rounded-xl border-2 border-green-300">
                                    <div className="flex items-center space-x-3">
                                        <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <div>
                                            <h3 className="font-bold text-green-900 text-lg">All Recovery Gear Properly Rated!</h3>
                                            <p className="text-green-700 text-sm">Your recovery equipment meets or exceeds the minimum requirements for your expedition weight.</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Weight by Location */}
                            <div className="bg-gray-50 p-6 rounded-xl">
                                <h3 className="font-bold text-gray-900 mb-4 flex items-center space-x-2">
                                    <span>ğŸ“</span>
                                    <span>Weight Distribution by Location</span>
                                </h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {Object.entries(weightByLocation)
                                        .sort(([, a], [, b]) => b - a)
                                        .map(([location, weight]) => (
                                            <div key={location} className="flex justify-between items-center py-2 border-b border-gray-200">
                                                <span className="text-gray-700 font-medium">{location}</span>
                                                <span className="text-gray-900 font-bold">{weight.toFixed(1)} kg</span>
                                            </div>
                                        ))}
                                </div>
                            </div>

                            {/* Weight by Category */}
                            <div className="bg-gray-50 p-6 rounded-xl">
                                <h3 className="font-bold text-gray-900 mb-4 flex items-center space-x-2">
                                    <span>ğŸ“¦</span>
                                    <span>Weight Distribution by Category</span>
                                </h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {Object.entries(weightByCategory)
                                        .sort(([, a], [, b]) => b - a)
                                        .map(([category, weight]) => (
                                            <div key={category} className="flex justify-between items-center py-2 border-b border-gray-200">
                                                <span className="text-gray-700 font-medium">{category}</span>
                                                <span className="text-gray-900 font-bold">{weight.toFixed(1)} kg</span>
                                            </div>
                                        ))}
                                </div>
                            </div>

                            {/* Items Missing Weight Data */}
                            {items.filter(i => !i.weight).length > 0 && (
                                <div className="bg-yellow-50 p-6 rounded-xl border-2 border-yellow-300">
                                    <div className="flex items-start space-x-3">
                                        <svg className="w-6 h-6 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <div>
                                            <h3 className="font-bold text-yellow-900 mb-1">Incomplete Weight Data</h3>
                                            <p className="text-sm text-yellow-800">
                                                {items.filter(i => !i.weight).length} items are missing weight information. 
                                                Add weights for accurate total calculation.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="bg-gray-100 px-8 py-4 rounded-b-2xl flex justify-end">
                            <button
                                onClick={onClose}
                                className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function AddItemModal({ onClose, onAdd, categories }) {
            const [formData, setFormData] = useState({
                name: '',
                owner: OWNERS[0],
                manufacturer: '',
                category: categories[0],
                subcategory: '',
                description: '',
                location: LOCATIONS[0],
                mobility: MOBILITY_STATUS[0],
                weight: '',
                weightUnit: 'kg',
                image: '',
                ownership: 'Owned',
                priority: 'Must Have',
                estimatedCost: '',
                actualCost: '',
                currency: 'CAD ($)',
                purchaseYear: '',
                purchaseMonth: '',
                purchaseDay: '',
                receipt: '',
                productUrl: '',
                hasWarranty: 'No',
                warrantyExpiry: '',
                medicationExpiry: '',
                medicationFor: 'General/Shared',
                prescribingDoctor: '',
                toolCondition: 'Good',
                compatibleWith: '',
                recoveryRating: '2,000 - 3,500 kg',
                inspectionDate: '',
                certificationStandard: ''
            });

            const [isProcessingImage, setIsProcessingImage] = useState(false);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({ ...formData, image: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const removeBackground = async () => {
                if (!formData.image) return;
                
                setIsProcessingImage(true);
                try {
                    // Create a canvas to process the image
                    const img = new Image();
                    img.src = formData.image;
                    
                    await new Promise((resolve) => {
                        img.onload = resolve;
                    });

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // Draw the image
                    ctx.drawImage(img, 0, 0);

                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // Simple background removal based on edge detection
                    // This is a basic implementation - for production, you'd want to use a proper API
                    // Find the most common color (likely background)
                    const colorCounts = {};
                    const sampleSize = 20; // Sample every 20th pixel for performance

                    for (let i = 0; i < data.length; i += 4 * sampleSize) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        const key = `${r},${g},${b}`;
                        colorCounts[key] = (colorCounts[key] || 0) + 1;
                    }

                    // Find dominant background color
                    let dominantColor = null;
                    let maxCount = 0;
                    for (const [color, count] of Object.entries(colorCounts)) {
                        if (count > maxCount) {
                            maxCount = count;
                            dominantColor = color.split(',').map(Number);
                        }
                    }

                    if (dominantColor) {
                        const threshold = 40; // Color similarity threshold
                        
                        for (let i = 0; i < data.length; i += 4) {
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            // Calculate color difference
                            const diff = Math.abs(r - dominantColor[0]) + 
                                       Math.abs(g - dominantColor[1]) + 
                                       Math.abs(b - dominantColor[2]);
                            
                            // If similar to background, make transparent
                            if (diff < threshold) {
                                data[i + 3] = 0; // Set alpha to 0 (transparent)
                            }
                        }
                    }

                    ctx.putImageData(imageData, 0, 0);
                    
                    // Convert to base64 PNG (to preserve transparency)
                    const processedImage = canvas.toDataURL('image/png');
                    setFormData({ ...formData, image: processedImage });
                } catch (error) {
                    console.error('Error removing background:', error);
                    alert('Failed to remove background. Please try again.');
                } finally {
                    setIsProcessingImage(false);
                }
            };

            const handleReceiptUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFormData({ ...formData, receipt: reader.result });
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name.trim()) {
                    // Build purchase date from components
                    let purchaseDate = '';
                    if (formData.purchaseYear) {
                        purchaseDate = formData.purchaseYear;
                        if (formData.purchaseMonth) {
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            purchaseDate = `${monthNames[parseInt(formData.purchaseMonth) - 1]} ${purchaseDate}`;
                            if (formData.purchaseDay) {
                                purchaseDate = `${formData.purchaseDay} ${purchaseDate}`;
                            }
                        }
                    }
                    
                    const itemData = { ...formData, purchaseDate };
                    delete itemData.purchaseYear;
                    delete itemData.purchaseMonth;
                    delete itemData.purchaseDay;
                    
                    onAdd(itemData);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold text-gray-900">Add New Item</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Item Name *
                                    </label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.name}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., Camp Stove"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Owner *
                                    </label>
                                    <select
                                        value={formData.owner}
                                        onChange={(e) => setFormData({ ...formData, owner: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        {OWNERS.map(owner => (
                                            <option key={owner} value={owner}>{owner}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Manufacturer / Brand
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.manufacturer}
                                        onChange={(e) => setFormData({ ...formData, manufacturer: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., MSR, Jetboil, etc."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Product URL
                                    </label>
                                    <input
                                        type="url"
                                        value={formData.productUrl}
                                        onChange={(e) => setFormData({ ...formData, productUrl: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="https://example.com/product"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Link to product page or listing</p>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Ownership Status *
                                    </label>
                                    <select
                                        value={formData.ownership}
                                        onChange={(e) => setFormData({ ...formData, ownership: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="Owned">Owned</option>
                                        <option value="Need to Purchase">Need to Purchase</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Priority *
                                    </label>
                                    <select
                                        value={formData.priority}
                                        onChange={(e) => setFormData({ ...formData, priority: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="Must Have">Must Have</option>
                                        <option value="Nice to Have">Nice to Have</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Category
                                    </label>
                                    <select
                                        value={formData.category}
                                        onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        {categories.map(cat => (
                                            <option key={cat} value={cat}>{cat}</option>
                                        ))}
                                    </select>
                                </div>

                                {formData.category === 'Clothing' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Clothing Type
                                        </label>
                                        <select
                                            value={formData.subcategory}
                                            onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-blue-50"
                                        >
                                            <option value="">Select type...</option>
                                            {CLOTHING_SUBCATEGORIES.map(sub => (
                                                <option key={sub} value={sub}>{sub}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}

                                {formData.category === 'First Aid' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            First Aid Type
                                        </label>
                                        <select
                                            value={formData.subcategory}
                                            onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 bg-red-50"
                                        >
                                            <option value="">Select type...</option>
                                            {FIRST_AID_SUBCATEGORIES.map(sub => (
                                                <option key={sub} value={sub}>{sub}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}

                                {formData.category === 'Tools & Equipment' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Tool Type
                                        </label>
                                        <select
                                            value={formData.subcategory}
                                            onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 bg-orange-50"
                                        >
                                            <option value="">Select type...</option>
                                            {TOOLS_SUBCATEGORIES.map(sub => (
                                                <option key={sub} value={sub}>{sub}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}

                                {formData.category === 'Tools & Equipment' && (
                                    <div className="bg-orange-50 p-4 rounded-lg border-2 border-orange-200 space-y-4">
                                        <h3 className="text-sm font-semibold text-orange-900 flex items-center space-x-2">
                                            <span>ğŸ”§</span>
                                            <span>Tool Details</span>
                                        </h3>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Condition
                                            </label>
                                            <select
                                                value={formData.toolCondition}
                                                onChange={(e) => setFormData({ ...formData, toolCondition: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"
                                            >
                                                {TOOL_CONDITION.map(condition => (
                                                    <option key={condition} value={condition}>{condition}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Compatible With (Vehicle/System)
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.compatibleWith}
                                                onChange={(e) => setFormData({ ...formData, compatibleWith: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500"
                                                placeholder="e.g., Land Rover Defender 130, Roof solar system"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                Specify which vehicle or habitat system this tool/part is for
                                            </p>
                                        </div>
                                    </div>
                                )}

                                {formData.category === 'Recovery & Trail Assistance' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Recovery Type
                                        </label>
                                        <select
                                            value={formData.subcategory}
                                            onChange={(e) => setFormData({ ...formData, subcategory: e.target.value })}
                                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-blue-50"
                                        >
                                            <option value="">Select type...</option>
                                            {RECOVERY_SUBCATEGORIES.map(sub => (
                                                <option key={sub} value={sub}>{sub}</option>
                                            ))}
                                        </select>
                                    </div>
                                )}

                                {formData.category === 'Recovery & Trail Assistance' && (
                                    <div className="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 space-y-4">
                                        <h3 className="text-sm font-semibold text-blue-900 flex items-center space-x-2">
                                            <span>ğŸ”—</span>
                                            <span>Recovery Equipment Details</span>
                                        </h3>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Weight Rating / Safe Working Load
                                            </label>
                                            <select
                                                value={formData.recoveryRating}
                                                onChange={(e) => setFormData({ ...formData, recoveryRating: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            >
                                                {RECOVERY_RATING.map(rating => (
                                                    <option key={rating} value={rating}>{rating}</option>
                                                ))}
                                            </select>
                                            <p className="text-xs text-gray-500 mt-1">
                                                Your 2003 Sierra 1500 weighs approx. 2,100 kg. Recovery gear should be rated 3x vehicle weight minimum.
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Last Inspection Date
                                            </label>
                                            <input
                                                type="date"
                                                value={formData.inspectionDate}
                                                onChange={(e) => setFormData({ ...formData, inspectionDate: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                Recovery gear should be inspected regularly for wear, fraying, and damage
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Certification/Standard
                                            </label>
                                            <input
                                                type="text"
                                                value={formData.certificationStandard}
                                                onChange={(e) => setFormData({ ...formData, certificationStandard: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                placeholder="e.g., ARB, Factor 55, CE certified, MBS 12,000kg"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">
                                                Note manufacturer rating or certification standard
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Condition
                                            </label>
                                            <select
                                                value={formData.toolCondition}
                                                onChange={(e) => setFormData({ ...formData, toolCondition: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            >
                                                {TOOL_CONDITION.map(condition => (
                                                    <option key={condition} value={condition}>{condition}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                )}

                                {(formData.subcategory === 'Medications' || formData.subcategory === 'Personal Medications') && (
                                    <div className="bg-red-50 p-4 rounded-lg border-2 border-red-200 space-y-4">
                                        <h3 className="text-sm font-semibold text-red-900 flex items-center space-x-2">
                                            <span>ğŸ’Š</span>
                                            <span>Medication Details</span>
                                        </h3>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Medication Expiry Date *
                                            </label>
                                            <input
                                                type="date"
                                                value={formData.medicationExpiry}
                                                onChange={(e) => setFormData({ ...formData, medicationExpiry: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                                            />
                                            <p className="text-xs text-red-600 mt-1 font-medium">
                                                âš ï¸ Important: Track expiry dates for border crossings and safety
                                            </p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Medication For *
                                            </label>
                                            <select
                                                value={formData.medicationFor}
                                                onChange={(e) => setFormData({ ...formData, medicationFor: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                                            >
                                                {MEDICATION_FOR.map(person => (
                                                    <option key={person} value={person}>{person}</option>
                                                ))}
                                            </select>
                                            <p className="text-xs text-gray-500 mt-1">
                                                Essential for border crossings - personal medications must be declared
                                            </p>
                                        </div>

                                        {formData.medicationFor !== 'General/Shared' && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Prescribing Doctor
                                                </label>
                                                <input
                                                    type="text"
                                                    value={formData.prescribingDoctor}
                                                    onChange={(e) => setFormData({ ...formData, prescribingDoctor: e.target.value })}
                                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                                                    placeholder="e.g., Dr. Smith, NHS Manchester"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">
                                                    Helpful for border crossings and prescription renewals
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Location
                                    </label>
                                    <select
                                        value={formData.location}
                                        onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        {LOCATIONS.map(loc => (
                                            <option key={loc} value={loc}>{loc}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Mobility Status
                                    </label>
                                    <select
                                        value={formData.mobility}
                                        onChange={(e) => setFormData({ ...formData, mobility: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        {MOBILITY_STATUS.map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">
                                        Fixed: Permanent installation | Movable: Can be relocated | Removable: Stored when not in use
                                    </p>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Description
                                    </label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        rows="3"
                                        placeholder="Optional details..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Weight
                                    </label>
                                    <div className="flex space-x-2">
                                        <input
                                            type="number"
                                            step="0.1"
                                            value={formData.weight}
                                            onChange={(e) => setFormData({ ...formData, weight: e.target.value })}
                                            className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            placeholder="e.g., 2.5"
                                        />
                                        <select
                                            value={formData.weightUnit}
                                            onChange={(e) => setFormData({ ...formData, weightUnit: e.target.value })}
                                            className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            {WEIGHT_UNITS.map(unit => (
                                                <option key={unit} value={unit}>{unit}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                {formData.ownership === 'Need to Purchase' && (
                                    <>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Currency
                                            </label>
                                            <select
                                                value={formData.currency}
                                                onChange={(e) => setFormData({ ...formData, currency: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            >
                                                {CURRENCIES.map(curr => (
                                                    <option key={curr} value={curr}>{curr}</option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Estimated Cost
                                            </label>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-gray-600 font-medium">{getCurrencySymbol(formData.currency)}</span>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.estimatedCost}
                                                    onChange={(e) => setFormData({ ...formData, estimatedCost: e.target.value })}
                                                    className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    placeholder="e.g., 49.99"
                                                />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {formData.ownership === 'Owned' && (
                                    <>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Currency
                                            </label>
                                            <select
                                                value={formData.currency}
                                                onChange={(e) => setFormData({ ...formData, currency: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            >
                                                {CURRENCIES.map(curr => (
                                                    <option key={curr} value={curr}>{curr}</option>
                                                ))}
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Actual Cost *
                                            </label>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-gray-600 font-medium">{getCurrencySymbol(formData.currency)}</span>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={formData.actualCost}
                                                    onChange={(e) => setFormData({ ...formData, actualCost: e.target.value })}
                                                    className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    placeholder="e.g., 49.99"
                                                />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">For insurance purposes</p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Purchase Date (Optional)
                                            </label>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label className="text-xs text-gray-500">Day</label>
                                                    <input
                                                        type="number"
                                                        min="1"
                                                        max="31"
                                                        value={formData.purchaseDay}
                                                        onChange={(e) => setFormData({ ...formData, purchaseDay: e.target.value })}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        placeholder="DD"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-500">Month</label>
                                                    <select
                                                        value={formData.purchaseMonth}
                                                        onChange={(e) => setFormData({ ...formData, purchaseMonth: e.target.value })}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    >
                                                        <option value="">-</option>
                                                        <option value="1">Jan</option>
                                                        <option value="2">Feb</option>
                                                        <option value="3">Mar</option>
                                                        <option value="4">Apr</option>
                                                        <option value="5">May</option>
                                                        <option value="6">Jun</option>
                                                        <option value="7">Jul</option>
                                                        <option value="8">Aug</option>
                                                        <option value="9">Sep</option>
                                                        <option value="10">Oct</option>
                                                        <option value="11">Nov</option>
                                                        <option value="12">Dec</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-500">Year</label>
                                                    <input
                                                        type="number"
                                                        min="1900"
                                                        max="2100"
                                                        value={formData.purchaseYear}
                                                        onChange={(e) => setFormData({ ...formData, purchaseYear: e.target.value })}
                                                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        placeholder="YYYY"
                                                    />
                                                </div>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">Leave day/month blank if unknown</p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Receipt / Proof of Purchase
                                            </label>
                                            <input
                                                type="file"
                                                accept="image/*,application/pdf"
                                                onChange={handleReceiptUpload}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            />
                                            {formData.receipt && (
                                                <div className="mt-2 flex items-center space-x-2 text-sm text-green-600">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    <span>Receipt uploaded</span>
                                                </div>
                                            )}
                                            <p className="text-xs text-gray-500 mt-1">Upload image or PDF of receipt</p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Warranty Status
                                            </label>
                                            <select
                                                value={formData.hasWarranty}
                                                onChange={(e) => setFormData({ ...formData, hasWarranty: e.target.value })}
                                                className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="No">No Warranty</option>
                                                <option value="Yes">Has Warranty</option>
                                            </select>
                                        </div>

                                        {formData.hasWarranty === 'Yes' && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Warranty Expiry Date (Optional)
                                                </label>
                                                <input
                                                    type="date"
                                                    value={formData.warrantyExpiry}
                                                    onChange={(e) => setFormData({ ...formData, warrantyExpiry: e.target.value })}
                                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                />
                                                <p className="text-xs text-gray-500 mt-1">Leave blank if warranty doesn't expire or date unknown</p>
                                            </div>
                                        )}
                                    </>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Photo
                                    </label>
                                    <div className="space-y-3">
                                        <div className="flex gap-2">
                                            <div className="flex-1">
                                                <input
                                                    type="file"
                                                    accept="image/*"
                                                    capture="environment"
                                                    onChange={handleImageUpload}
                                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                                    id="image-upload"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <label 
                                                htmlFor="image-upload"
                                                className="flex-1 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition text-center cursor-pointer font-medium text-sm flex items-center justify-center space-x-2"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                                </svg>
                                                <span>Take Photo / Choose File</span>
                                            </label>
                                        </div>
                                        {formData.image && (
                                            <>
                                                <img src={formData.image} alt="Preview" className="w-full h-40 object-contain rounded-lg bg-gray-50" />
                                                <button
                                                    type="button"
                                                    onClick={removeBackground}
                                                    disabled={isProcessingImage}
                                                    className="w-full px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition font-medium text-sm flex items-center justify-center space-x-2 disabled:opacity-50"
                                                >
                                                    {isProcessingImage ? (
                                                        <>
                                                            <svg className="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                            </svg>
                                                            <span>Processing...</span>
                                                        </>
                                                    ) : (
                                                        <>
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                                                            </svg>
                                                            <span>Remove Background</span>
                                                        </>
                                                    )}
                                                </button>
                                                <p className="text-xs text-gray-500 text-center">
                                                    Tip: For best results, photograph items against a plain, solid-colored background
                                                </p>
                                            </>
                                        )}
                                    </div>
                                </div>

                                <div className="flex space-x-3 pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        Add Item
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function AddPackingListModal({ onClose, items, onAdd }) {
            const [formData, setFormData] = useState({
                name: '',
                description: '',
                itemIds: []
            });

            const toggleItem = (itemId) => {
                setFormData({
                    ...formData,
                    itemIds: formData.itemIds.includes(itemId)
                        ? formData.itemIds.filter(id => id !== itemId)
                        : [...formData.itemIds, itemId]
                });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name.trim()) {
                    onAdd({ ...formData, checkedItems: [] });
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-2xl font-bold text-gray-900">Create Packing List</h2>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        List Name *
                                    </label>
                                    <input
                                        type="text"
                                        required
                                        value={formData.name}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="e.g., Weekend Trip, Summer Adventure"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Description
                                    </label>
                                    <input
                                        type="text"
                                        value={formData.description}
                                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                        placeholder="Optional notes..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-3">
                                        Select Items ({formData.itemIds.length} selected)
                                    </label>
                                    <div className="border rounded-lg max-h-60 overflow-y-auto">
                                        {items.length === 0 ? (
                                            <div className="p-4 text-center text-gray-500">
                                                No items in catalog yet. Add items first!
                                            </div>
                                        ) : (
                                            items.map(item => (
                                                <label
                                                    key={item.id}
                                                    className="flex items-center space-x-3 p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0"
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={formData.itemIds.includes(item.id)}
                                                        onChange={() => toggleItem(item.id)}
                                                        className="w-5 h-5 text-blue-600 rounded"
                                                    />
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-900">{item.name}</div>
                                                        <div className="text-sm text-gray-500">{item.category}</div>
                                                    </div>
                                                </label>
                                            ))
                                        )}
                                    </div>
                                </div>

                                <div className="flex space-x-3 pt-4">
                                    <button
                                        type="button"
                                        onClick={onClose}
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        Create List
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
